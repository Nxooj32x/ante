define("more_selection",function(t,e,a){function o(){for(var t,e=1;e<T.length;e++)(t=T[e])&&$(t.element.children(".selected_icon")).addClass("align_selected");T[0]&&$(T[0].element.children(".selected_icon")).addClass("align_selected_first")}function i(t){if(t)return void $(t.element.children(".selected_icon")).removeClass("align_selected").removeClass("align_selected_first");for(var e,a=0;a<T.length;a++)(e=T[a])&&$(e.element.children(".selected_icon")).removeClass("align_selected").removeClass("align_selected_first")}function n(t){var e=b(t),a=t.element;a.hasClass("textbox")?w.trigger(S,{pageNum:a.parent().attr("data-num"),textboxName:a.attr("data-name"),obj:{x:y.pxToMm(e.x),y:y.pxToMm(e.y)}}):a.hasClass("imgbox")?x.trigger(S,{pageNum:a.parent().attr("data-num"),imgboxName:a.attr("data-name"),obj:{x:y.pxToMm(e.x),y:y.pxToMm(e.y)}}):a.hasClass("decorabox")?_decoraboxChanged.trigger(S,{pageNum:a.parent().attr("data-num"),decoraboxName:a.attr("data-name"),obj:{x:y.pxToMm(e.x),y:y.pxToMm(e.y)}}):a.hasClass("shapebox")?_shapeboxChanged.trigger(S,{pageNum:a.parent().attr("data-num"),shapeboxName:a.attr("data-name"),obj:{x:y.pxToMm(e.x),y:y.pxToMm(e.y)}}):a.hasClass("shadingbox")&&_shadingboxChanged.trigger(S,{pageNum:a.parent().attr("data-num"),shadingboxName:a.attr("data-name"),obj:{x:y.pxToMm(e.x),y:y.pxToMm(e.y)}})}function r(t){v({element:t.element,obj:{x:m.x}}),n(t)}function s(t){v({element:t.element,obj:{x:m.x+(m.width-b(t).width)/2}}),n(t)}function l(t){v({element:t.element,obj:{x:m.x+(m.width-b(t).width)}}),n(t)}function d(t){v({element:t.element,obj:{y:m.y}}),n(t)}function c(t){v({element:t.element,obj:{y:m.y+(m.height-b(t).height)/2}}),n(t)}function g(t){v({element:t.element,obj:{y:m.y+m.height-b(t).height}}),n(t)}function h(t){T.each(function(){$(this)})}function p(t){v({element:t.element,obj:{height:m.height}}),k({element:t.element})}function u(t){v({element:t.element,obj:{width:m.width}}),k({element:t.element})}function f(t){v({element:t.element,obj:{height:m.height,width:m.width}}),k({element:t.element})}var m,v,b,x,S,y,w,k,T=[],P=null,C=!1,I=function(){i(),P=null,T=[],$(document).off("mousedown.more_selection.remove")},_=function(){return T},q=function(t){if(C){if(T.length>=1)if($(T[0].element).offsetParent().attr("data-num")!==$(t.element).offsetParent().attr("data-num"))I();else for(var e=0;e<T.length;e++)if(T[e].element.index()==t.element.index())return i(t),T.splice(e,1),void o();return T.push(t),o(),void $(document).on("mousedown.more_selection.remove",function(t){$(t.target).is(".shadingbox,.shadingbox *,.decorabox,.decorabox *,.textbox,.textbox *,.shapebox,.shapebox *,.imgbox,.imgbox *,.content,.selected_icon,.img,.toolbar-button,.preventHideSelectionHandles,.menu-btn,.menu-btn *, .drag_area_vessel, .drag_area_vessel *, .fill_in_vessel, .fill_in_vessel *, #align_center_vessel, #align_center_vessel *")||I()})}I(),T[0]=t},E=function(t){P=T[0],m=b(P);for(var e,a=1;a<T.length;a++)switch(e=T[a],t){case"align-left":r(e);break;case"align-center":s(e);break;case"align-right":l(e);break;case"align-top":d(e);break;case"align-ju":c(e);break;case"align-bottom":g(e);break;case"align-vertical":h(e);break;case"align-horizontal":break;case"align-sameHeight":p(e);break;case"align-sameWidth":u(e);break;case"align-sameSize":f(e)}m=null},L=function(t){C=t},A=function(){return C};e.remove=I,e.addele=q,e.doAlign=E,e.setCtrl=L,e.getCtrl=A,e.getboxs=_,e.setResized=function(t){k=t},e.setSizeConverter=function(t){y=t},e.setView=function(t){S=t},e.boxChanged=function(t,e){x=t,w=e},e.setProperties=function(t,e){v=t,b=e}}),define("uploader",function(t,e,a){function o(t,e){this.belongId=t.belongId,this.belongType="book",this.bucket=t.bucket||"yearbook-album",this.domain=t.domain||"http://"+me.bucket+".yearbook.com.cn/",e=$.extend({},{Error:function(t,e,a){e.code===plupload.FILE_SIZE_ERROR?(a="图片太大了，换一个小的吧",SureMsg.alert(a)):console.log(a)},Key:function(t,e){return"imageRes/"+(e.md5||(new UUID).id)}},e);var a={uptoken_url:"/qiniu/upToken?scope="+this.bucket};t.uptoken&&(a={}),t=$.extend({},i,a,t,{init:e}),this.qiniuUploader=Qiniu.uploader(t)}var i={runtimes:"gears,html5,flash",flash_swf_url:"/js/lib/plupload/Moxie.swf",silverlight_xap_url:"/js/lib/plupload/Moxie.xap",dragdrop:!0,chunk_size:"4Mb",max_retries:1,filters:{max_file_size:"30mb",prevent_duplicates:!0},mime_types:"image/*",auto_start:!1};o.prototype.startUpload=function(){this.qiniuUploader.start()},o.prototype.stopUpload=function(){this.qiniuUploader.stop()},a.exports=o}),define("imgload",function(t,e,a){function o(t,e){var a=document.createElement("img");if(a.src=t,a.complete||a.width*a.height>0)return void e.call(a,a.width,a.height);var o=setInterval(function(){(a.complete||a.width*a.height>0)&&(e.call(a,a.width,a.height),clearInterval(o))},1e3/60)}a.exports=o}),define("zoombar",["event","transform","draggable"],function(t,e,a){function o(t){t=$(t);var e=this;e.elements={zoombar:t,cursor:$("> .zoombar_cursor",t),buttonZoomOut:$("> .zoombar_min",t),buttomZoomIn:$("> .zoombar_max",t)},e.changeStart=new i,e.change=new i,e.changeEnd=new i,e.setCursorPosition(1);var a=new r(e.elements.cursor);a.dragStart.register(function(t){$(t.currentTarget).data("pointerInnerX",t.pageX-$(t.currentTarget).offset().left),e.changeStart.trigger(e,t)}),a.drag.register(function(t){$(t.currentTarget).addClass("no-transition");var a=t.pageX-e.elements.zoombar.offset().left-$(t.currentTarget).data("pointerInnerX"),o=e.computeScaleValueFromX(a);e.setCursorPosition(o)}),a.dragEnd.register(function(t){n.set(t.currentTarget,n.getCurrent(t.currentTarget)),setTimeout(function(){$(t.currentTarget).removeClass("no-transition")}),e.changeEnd.trigger(e)}),e.elements.zoombar.on(function(){var t={};return t.tap=function(t){var a=$(t.currentTarget);if(!a.data("isLongPress")){var o;switch(a[0]){case e.elements.buttonZoomOut[0]:o=n.getCurrent(e.elements.cursor).translationX-5;break;case e.elements.buttomZoomIn[0]:o=n.getCurrent(e.elements.cursor).translationX+5;break;default:return}var i=e.computeScaleValueFromX(o);e.setCursorPosition(i),t.preventDefault()}},t.mousedown=function(t){var a,o=$(t.currentTarget);switch(o[0]){case e.elements.buttonZoomOut[0]:a=function(){e.setCursorPosition(e.computeScaleValueFromX(n.getCurrent(e.elements.cursor).translationX-3))};break;case e.elements.buttomZoomIn[0]:a=function(){e.setCursorPosition(e.computeScaleValueFromX(n.getCurrent(e.elements.cursor).translationX+3))};break;default:return}o.data("isLongPress",!1),o.data("clockStartChangeTimeOut",setTimeout(function(){o.data("clockChangeInterval",setInterval(a,1e3/60)),e.elements.cursor.addClass("no-transition"),o.data("isLongPress",!0),e.changeStart.trigger(e,t)},200)),t.preventDefault()},t.mouseup=t.mouseleave=function(t){var a=$(t.currentTarget),o=a.data("clockStartChangeTimeOut"),i=a.data("clockChangeInterval"),n=a.data("isLongPress");o&&clearTimeout(o),i&&clearInterval(i),n&&(e.elements.cursor.removeClass("no-transition"),e.changeEnd.trigger(e),t.preventDefault())},t}(),".zoombar_btn").on("pointerdown",function(t){if(!$(t.target).is(".zoombar_btn")){var a=t.pageX-e.elements.zoombar.offset().left-e.elements.cursor.outerWidth()/2,o=e.computeScaleValueFromX(a);e.setCursorPosition(o),t.preventDefault()}})}var i=t("event"),n=t("transform"),r=t("draggable");o.prototype.getMaxValue=function(){return parseFloat(this.elements.zoombar.attr("data-max-value"))},o.prototype.getMinValue=function(){return parseFloat(this.elements.zoombar.attr("data-min-value"))},o.prototype.setCursorPosition=function(t){var e=this,a=this.getMaxValue(),o=this.getMinValue();t<o?t=o:t>a&&(t=a);var i=(t-o)/(a-o)*(e.elements.zoombar.width()-e.elements.buttonZoomOut.outerWidth()-e.elements.cursor.outerWidth()-e.elements.buttomZoomIn.outerWidth())+e.elements.buttonZoomOut.outerWidth();n.translate(e.elements.cursor,i,0);var r=parseInt(100*parseFloat(t).toFixed(2))+"%";"100%"==r&&(r="1:1"),e.elements.cursor.attr("data-text",r),e.elements.zoombar.attr("data-text",r),e.change.trigger(e,{scale:t})},o.prototype.computeScaleValueFromX=function(t){var e=this,a=e.getMaxValue(),o=e.getMinValue();return(t-e.elements.buttonZoomOut.outerWidth())/(e.elements.zoombar.width()-e.elements.buttonZoomOut.outerWidth()-e.elements.cursor.outerWidth()-e.elements.buttomZoomIn.outerWidth())*(a-o)+o},a.exports=o}),define("selection-handles",["draggable","event","more_selection"],function(t,e,a){function o(t){var e=$(t.element),a=void 0===t.setCss||t.setCss,o=t.minWidth||10,i=t.minHeight||10;this.element=e,this.setCss=a,this.minWidth=o,this.minHeight=i,this.isOn=!1,this.element.css("transform-origin","0 0"),this.rotateStart=new r,this.rotate=new r,this.rotateEnd=new r,this.resizeStart=new r,this.resize=new r,this.resizeEnd=new r,this.locators={},this.handles={},this.borders={}}var i,n=t("draggable"),r=t("event");t("more_selection");!function(){$("body").on("mousedown",function(t){var t=t||window.event;i=!!t.shiftKey})}(),o.prototype.on=function(){var t=this;for(this.element.addClass("transformable-box"),a=0;a<5;a++){var e=$(document.createElement("span"));switch(e.addClass("selection-border"),a){case 0:e.addClass("selection-border-top"),t.borders.top=e;break;case 1:e.addClass("selection-border-right"),t.borders.right=e;break;case 2:e.addClass("selection-border-bottom"),t.borders.bottom=e;break;case 3:e.addClass("selection-border-left"),t.borders.left=e;break;case 4:e.addClass("selection-border-linkrotate"),t.borders.linkrotate=e}e.appendTo($("body"))}for(var a=0;a<9;a++){var o=$(document.createElement("span")),r=$(document.createElement("span"));if(o.addClass("selection-handle"),r.addClass("selection-handle-locator"),a<8)switch(o.addClass("selection-handle-resize"),a){case 0:o.addClass("selection-handle-resize-left-top"),r.addClass("selection-handle-locator-left-top"),this.handles.leftTop=o,this.locators.leftTop=r;break;case 1:o.addClass("selection-handle-resize-left-bottom"),r.addClass("selection-handle-locator-left-bottom"),this.handles.leftBottom=o,this.locators.leftBottom=r;break;case 2:o.addClass("selection-handle-resize-right-top"),r.addClass("selection-handle-locator-right-top"),this.handles.rightTop=o,this.locators.rightTop=r;break;case 3:o.addClass("selection-handle-resize-right-bottom"),r.addClass("selection-handle-locator-right-bottom"),this.handles.rightBottom=o,this.locators.rightBottom=r;break;case 4:o.addClass("selection-handle-resize-center-top"),r.addClass("selection-handle-locator-center-top"),this.handles.centerTop=o,this.locators.centerTop=r;break;case 5:o.addClass("selection-handle-resize-center-bottom"),r.addClass("selection-handle-locator-center-bottom"),this.handles.centerBottom=o,this.locators.centerBottom=r;break;case 6:o.addClass("selection-handle-resize-left-center"),r.addClass("selection-handle-locator-left-center"),this.handles.leftCenter=o,this.locators.leftCenter=r;break;case 7:o.addClass("selection-handle-resize-right-center"),r.addClass("selection-handle-locator-right-center"),this.handles.rightCenter=o,this.locators.rightCenter=r}else o.addClass("selection-handle-rotate"),this.handles.rotate=o,r.addClass("selection-handle-locator-center"),this.locators.center=r;r.appendTo(this.element),o.appendTo($("body"))}this.resetPosition();var s;for(var l in t.handles)s=s?s.add(t.handles[l]):t.handles[l];$(s).on({mouseenter:function(e){$(t).data("drag")||($(this).hasClass("selection-handle-resize")?t.setCursorToResize(this):$(this).hasClass("selection-handle-rotate")&&t.setCursorToRotate())},mouseleave:function(){$(t).data("drag")||t.setCursorToDefault()}});var d=new n(s);d.dragStart.register(function(e){var a=$(e.currentTarget);$(t).data("drag",!0);var o=t.locators.leftTop.offset(),i=(t.locators.leftBottom.offset(),t.locators.rightTop.offset(),t.locators.rightBottom.offset());t.elementInitialTransform=t.element.css("transform"),t.centerPoint={x:i.left-(i.left-o.left)/2,y:i.top-(i.top-o.top)/2},t.radiansStartMouse=t.computePointRadians(e.startPoint.x,e.startPoint.y),t.radiansStart=t.getCurrentRadians(),t.initialSize={width:t.element.innerWidth(),height:t.element.innerHeight()},t.offsetLeftTop=t.locators.leftTop.offset(),t.offsetLeftBottom=t.locators.leftBottom.offset(),t.offsetRightTop=t.locators.rightTop.offset(),t.offsetRightBottom=t.locators.rightBottom.offset(),t.offsetCenter=t.locators.center.offset(),t.locations=t.getLocations();var n=t.offsetRightTop.left-t.offsetLeftTop.left+1,r=t.offsetRightTop.top-t.offsetLeftTop.top+1;if(t.scale=Math.sqrt(n*n+r*r)/t.element.innerWidth(),a.is(".selection-handle-rotate"))t.setCursorToRotate(),t.rotateStart.trigger(t,{type:"rotate",element:t.element,originalEvent:e});else{var s;a.is(".selection-handle-resize-left-top")?s="resize-left-top":a.is(".selection-handle-resize-left-bottom")?s="resize-left-bottom":a.is(".selection-handle-resize-right-top")?s="resize-right-top":a.is(".selection-handle-resize-right-bottom")&&(s="resize-right-bottom"),t.setCursorToResize(a),t.resizeStart.trigger(t,{type:s,element:t.element,originalEvent:e})}}),d.drag.register(function(e){var a,o,n=$(e.currentTarget),r=t.element.hasClass("decorationslot");if(n.hasClass("selection-handle-rotate")){a=t.computePointRadians(e.pageX,e.pageY),o=a-t.radiansStartMouse;var s=o/Math.PI*180;t.rotatedAngle=s,t.setCss&&t.element.css("transform",t.elementInitialTransform+"translate(50%,50%)rotate("+s+"deg)translate(-50%,-50%)"),t.rotate.trigger(t,{type:"rotate",element:t.element,rotatedAngle:s,rotationMouse:a/Math.PI*180,originalEvent:e})}else if(n.hasClass("selection-handle-resize")){var l,d,c,g,h,p,u,f={element:t.element,initialSize:t.initialSize,originalEvent:e};n.hasClass("selection-handle-resize-center-top")?(l=e.pageX-t.offsetLeftBottom.left,d=t.offsetLeftBottom.top-e.pageY,c=Math.sqrt(l*l+d*d),a=Math.acos(d/c),e.pageX<t.offsetLeftBottom.left&&(a=-a),o=a-t.radiansStart,g=Math.round(c*Math.cos(o)/t.scale),g<t.minHeight/t.scale&&(g=t.minHeight/t.scale),p=t.deltaTop=-(g-t.initialSize.height),r&&1!=window.EditorStatus&&(h=t.initialSize.width*g/t.initialSize.height)<t.minWidth/t.scale&&(h=t.minWidth/t.scale),r&&1!=window.EditorStatus?t.setCss&&t.element.css({transform:t.elementInitialTransform+"translateY("+p+"px)"}).innerWidth(h).innerHeight(g):t.setCss&&t.element.css({transform:t.elementInitialTransform+"translateY("+p+"px)"}).innerHeight(g),f.type="resize-center-top",f.height=g,f.deltaTop=p):n.hasClass("selection-handle-resize-center-bottom")?(l=e.pageX-t.offsetLeftTop.left,d=t.offsetLeftTop.top-e.pageY,c=Math.sqrt(l*l+d*d),a=Math.acos(d/c),e.pageX<t.offsetLeftTop.left&&(a=-a),o=a-t.radiansStart,g=-Math.round(c*Math.cos(o)/t.scale),r&&1!=window.EditorStatus&&(h=t.initialSize.width*g/t.initialSize.height),r&&1!=window.EditorStatus?(h<t.minWidth/t.scale&&(h=t.minWidth/t.scale),g<t.minHeight/t.scale&&(g=t.minHeight/t.scale),t.setCss&&t.element.css({transform:t.elementInitialTransform}).innerWidth(h).innerHeight(g)):(g<t.minHeight/t.scale&&(g=t.minHeight/t.scale),t.setCss&&t.element.css({transform:t.elementInitialTransform}).innerHeight(g)),f.type="resize-center-bottom",f.height=g):n.hasClass("selection-handle-resize-left-center")?(l=e.pageX-t.offsetRightBottom.left,d=e.pageY-t.offsetRightBottom.top,c=Math.sqrt(l*l+d*d),a=-Math.acos(d/c),e.pageX<t.offsetRightBottom.left&&(a=-a),o=a-t.radiansStart,h=Math.round(c*Math.sin(o)/t.scale),h<t.minWidth/t.scale&&(h=t.minWidth/t.scale),u=t.deltaLeft=-(h-t.initialSize.width),r&&1!=window.EditorStatus&&(g=t.initialSize.height*h/t.initialSize.width)<t.minHeight/t.scale&&(g=t.minHeight/t.scale),r&&1!=window.EditorStatus?t.setCss&&t.element.css({transform:t.elementInitialTransform+"translateX("+u+"px)"}).innerWidth(h).innerHeight(g):t.setCss&&t.element.css({transform:t.elementInitialTransform+"translateX("+u+"px)"}).innerWidth(h),f.type="resize-left-center",f.width=h,f.deltaLeft=u):n.hasClass("selection-handle-resize-right-center")?(l=e.pageX-t.offsetLeftTop.left,d=t.offsetLeftTop.top-e.pageY,c=Math.sqrt(l*l+d*d),a=Math.acos(d/c),e.pageX<t.offsetLeftTop.left&&(a=-a),o=a-t.radiansStart,h=Math.round(c*Math.sin(o)/t.scale),h<t.minWidth/t.scale&&(h=t.minWidth/t.scale),r&&1!=window.EditorStatus&&(g=t.initialSize.height*h/t.initialSize.width,g<t.minHeight/t.scale&&(g=t.minHeight/t.scale),u=t.deltaLeft=-(h-t.initialSize.width),p=t.deltaTop=-(g-t.initialSize.height)),r&&1!=window.EditorStatus?t.setCss&&t.element.css({transform:t.elementInitialTransform}).innerWidth(h).innerHeight(g):t.setCss&&t.element.css({transform:t.elementInitialTransform}).innerWidth(h),f.type="resize-right-center",f.width=h,f.height=g):n.hasClass("selection-handle-resize-left-top")?(l=t.offsetRightBottom.left-e.pageX,d=e.pageY-t.offsetRightBottom.top,c=Math.sqrt(l*l+d*d),a=-Math.acos(d/c),e.pageX<t.offsetRightBottom.left&&(a=-a),o=a-t.radiansStart,h=Math.round(c*Math.sin(o)/t.scale),g=r||i?t.initialSize.height*h/t.initialSize.width:Math.round(c*-Math.cos(o)/t.scale),h<t.minWidth/t.scale&&(h=t.minWidth/t.scale),g<t.minHeight/t.scale&&(g=t.minHeight/t.scale),u=t.deltaLeft=-(h-t.initialSize.width),p=t.deltaTop=-(g-t.initialSize.height),t.setCss&&t.element.css({transform:t.elementInitialTransform+"translate("+u+"px,"+p+"px)"}).innerWidth(h).innerHeight(g),f.type="resize-left-top",f.width=h,f.height=g,f.deltaLeft=u,f.deltaTop=p):n.hasClass("selection-handle-resize-left-bottom")?(l=e.pageX-t.offsetRightTop.left,d=e.pageY-t.offsetRightTop.top,c=Math.sqrt(l*l+d*d),a=-Math.acos(d/c),e.pageX<t.offsetRightTop.left&&(a=-a),o=a-t.radiansStart,g=Math.round(c*Math.cos(o)/t.scale),r||i?(h=t.initialSize.width*g/t.initialSize.height,p=t.deltaTop=-(g-t.initialSize.height)):h=Math.round(c*Math.sin(o)/t.scale),h<t.minWidth/t.scale&&(h=t.minWidth/t.scale),g<t.minHeight/t.scale&&(g=t.minHeight/t.scale),u=t.deltaLeft=-(h-t.initialSize.width),t.setCss&&t.element.css({transform:t.elementInitialTransform+"translateX("+u+"px)"}).innerWidth(h).innerHeight(g),f.type="resize-left-bottom",f.width=h,f.height=g,f.deltaLeft=u):n.hasClass("selection-handle-resize-right-top")?(l=e.pageX-t.offsetLeftBottom.left,d=t.offsetLeftBottom.top-e.pageY,c=Math.sqrt(l*l+d*d),a=Math.acos(d/c),e.pageX<t.offsetLeftBottom.left&&(a=-a),o=a-t.radiansStart,h=Math.round(c*Math.sin(o)/t.scale),r||i?(g=t.initialSize.height*h/t.initialSize.width,u=t.deltaLeft=-(h-t.initialSize.width)):g=Math.round(c*Math.cos(o)/t.scale),h<t.minWidth/t.scale&&(h=t.minWidth/t.scale),g<t.minHeight/t.scale&&(g=t.minHeight/t.scale),p=t.deltaTop=-(g-t.initialSize.height),t.setCss&&t.element.css({transform:t.elementInitialTransform+"translateY("+p+"px)"}).innerWidth(h).innerHeight(g),f.type="resize-right-top",f.width=h,f.height=g,f.deltaTop=p):n.hasClass("selection-handle-resize-right-bottom")&&(l=e.pageX-t.offsetLeftTop.left,d=t.offsetLeftTop.top-e.pageY,c=Math.sqrt(l*l+d*d),a=Math.acos(d/c),e.pageX<t.offsetLeftTop.left&&(a=-a),o=a-t.radiansStart,h=Math.round(c*Math.sin(o)/t.scale),r||i?(g=t.initialSize.height*h/t.initialSize.width,u=t.deltaLeft=-(h-t.initialSize.width)):g=-Math.round(c*Math.cos(o)/t.scale),h<t.minWidth/t.scale&&(h=t.minWidth/t.scale),g<t.minHeight/t.scale&&(g=t.minHeight/t.scale),t.setCss&&t.element.css({transform:t.elementInitialTransform}).innerWidth(h).innerHeight(g),f.type="resize-right-bottom",f.width=h,f.height=g),void 0!==f.width&&(f.deltaWidth=f.width-t.initialSize.width),void 0!==f.height&&(f.deltaHeight=f.height-t.initialSize.height);var m=$(t).data("timesliceSetCursorClockToken");m&&clearTimeout(m),$(t).data("timesliceSetCursorClockToken",setTimeout(function(){t.setCursorToResize(n),$(t).data("timesliceSetCursorClockToken",null)},1e3/60)),t.resize.trigger(t,f)}t.resetPosition()}),d.dragEnd.register(function(e){var a=$(e.currentTarget),o=t.getCurrentRotation();if(a.is(".selection-handle-rotate"))t.rotateEnd.trigger(t,{type:"rotate",element:t.element,rotatedAngle:t.rotatedAngle,rotation:o,originalEvent:e});else{var i;a.is(".selection-handle-resize-left-top")?i="resize-left-top":a.is(".selection-handle-resize-left-bottom")?i="resize-left-bottom":a.is(".selection-handle-resize-right-top")?i="resize-right-top":a.is(".selection-handle-resize-right-bottom")&&(i="resize-right-bottom"),t.resizeEnd.trigger(t,{type:i,element:t.element,originalEvent:e,deltaLeft:t.deltaLeft,deltaTop:t.deltaTop,rotation:o})}if(!$(e.event.target).is(".selection-handle-resize,.selection-handle-rotate")){var n=$(t).data("timesliceSetCursorClockToken");n&&clearTimeout(n),t.setCursorToDefault()}$(t).data("drag",!1),delete t.rotatedAngle,delete t.deltaLeft,delete t.deltaTop}),t.isOn=!0},o.prototype.off=function(){this.element.removeClass("transformable-box").removeData("selectionHandels");for(var t in this.borders)this.borders[t].remove();for(t in this.handles)this.handles[t].remove();for(t in this.locators)this.locators[t].remove();this.isOn=!1},o.prototype.show=function(){for(var t in this.borders)this.borders[t].css("display","block");for(t in this.handles)this.handles[t].css("display","block")},o.prototype.hide=function(){for(var t in this.borders)this.borders[t].css("display","none");for(t in this.handles)this.handles[t].css("display","none")},o.prototype.showHandles=function(){for(key in this.handles)this.handles[key].css("display","block");this.borders.linkrotate.css("display","block")},o.prototype.hideHandles=function(){for(key in this.handles)this.handles[key].css("display","none");this.borders.linkrotate.css("display","none")},o.prototype.getCurrentRadians=function(){var t=this.locators.centerTop.offset();return this.computePointRadians(t.left,t.top)},o.prototype.getCurrentRotation=function(){return this.getCurrentRadians()/Math.PI*180},o.prototype.computePointRadians=function(t,e){var a=this.locators.center.offset();t-=a.left,e=a.top-e;var o=Math.acos(e/Math.sqrt(t*t+e*e));return t<0&&(o=-o),o},o.prototype.computePointRotation=function(t,e){return this.computePointRadians(t,e)/Math.PI*180},o.prototype.resetPosition=function(){var t=this,e=t.getCurrentRadians(),a=e/Math.PI*180,o=t.locators.centerTop.offset(),i=t.locators.leftCenter.offset(),n=t.locators.centerBottom.offset(),r=t.locators.rightCenter.offset();for(var s in t.handles){var l,d=t.handles[s];if("rotate"===s){l={left:o.left+12*Math.sin(e),top:o.top-12*Math.cos(e)}}else l=t.locators[s].offset();d.css("transform","translate("+l.left+"px,"+l.top+"px)rotate("+a+"deg)translate(-50%,-50%)")}this.borders.top.css({width:(r.left-i.left)/Math.cos(e),transform:"translate("+o.left+"px,"+o.top+"px)rotate("+a+"deg)translate(-50%,-50%)"}),this.borders.right.css({height:(n.top-o.top)/Math.cos(e),transform:"translate("+r.left+"px,"+r.top+"px)rotate("+a+"deg)translate(-50%,-50%)"}),this.borders.bottom.css({width:(r.left-i.left)/Math.cos(e),transform:"translate("+n.left+"px,"+n.top+"px)rotate("+a+"deg)translate(-50%,-50%)"}),this.borders.left.css({height:(n.top-o.top)/Math.cos(e),transform:"translate("+i.left+"px,"+i.top+"px)rotate("+a+"deg)translate(-50%,-50%)"}),this.borders.linkrotate.css({transform:"translate("+o.left+"px,"+o.top+"px)rotate("+a+"deg)translate(-50%,-100%)"})},o.prototype.getLocations=function(){return{leftTop:this.locators.leftTop.offset(),leftBottom:this.locators.leftTop.offset(),leftCenter:this.locators.leftCenter.offset(),rightTop:this.locators.rightTop.offset(),centerTop:this.locators.centerTop.offset(),rightBottom:this.locators.rightBottom.offset(),rightCenter:this.locators.rightCenter.offset(),centerBottom:this.locators.centerBottom.offset(),center:this.locators.center.offset()}},o.prototype.setCursorToResize=function(t){t=$(t);var e=t[0].getBoundingClientRect(),a=e.left+e.width/2,o=e.top+e.height/2,i=this.computePointRotation(a,o);i<=22.5&&i>-22.5?$("body").attr("data-cursor","n-resize"):i<=67.5&&i>22.5?$("body").attr("data-cursor","ne-resize"):i<=112.5&&i>67.5?$("body").attr("data-cursor","e-resize"):i<=157.5&&i>112.5?$("body").attr("data-cursor","se-resize"):i<=-157.5||i>157.5?$("body").attr("data-cursor","s-resize"):i<=-112.5&&i>-157.5?$("body").attr("data-cursor","sw-resize"):i<=-67.5&&i>-112.5?$("body").attr("data-cursor","w-resize"):i<=-22.5&&i>-67.5&&$("body").attr("data-cursor","nw-resize")},o.prototype.setCursorToRotate=function(){$("body").attr("data-cursor","rotate")},o.prototype.setCursorToDefault=function(){$("body").removeAttr("data-cursor")},a.exports=o}),define("draggable",["event"],function(t,e,a){function o(t,e,a,o,s){arguments[0]instanceof jQuery||"string"==typeof arguments[0]?(t=$(t),a=a||1,o=o||0,s=void 0===s||s):(t=$(arguments[0].el),e=arguments[0].selector,a=arguments[0].delta||1,o=arguments[0].longtouchtime||0,s=void 0===arguments[0].preventDefault||arguments[0].preventDefault);var l=this,d=i();l.element=t,l.dragStart=new n,l.drag=new n,l.dragEnd=new n,l.delta=a,l.isOn=!1,l.state=0,l.dragStartPoint=null,t.on("dragstart",function(t){l.isOn&&t.preventDefault()}),t.on((d?"touchstart":"mousedown")+".drag",e,function(t){if(l.isOn&&("mousedown"!==t.type||0===t.button)){t.pageX=t.pageX||t.originalEvent.touches[0].pageX,t.pageY=t.pageY||t.originalEvent.touches[0].pageY,("mousedown"===t.type||s)&&t.preventDefault();var e,a=t.currentTarget,i=t.target;l.state=1,l.dragStartPoint={x:t.pageX,y:t.pageY};var n=r++,c=function(t){"mouseup"===t.type&&t.preventDefault(),void 0===t.pageX&&(t.pageX=l.lastDragX),void 0===t.pageY&&(t.pageY=l.lastDragY),window.requestAnimationFrame(function(){2===l.state&&l.dragEnd.trigger(l,{currentTarget:a,target:i,startPoint:l.dragStartPoint,pageX:t.pageX||t.originalEvent.changedTouches[0].pageX,pageY:t.pageY||t.originalEvent.changedTouches[0].pageY,deltaX:(t.pageX||t.originalEvent.changedTouches[0].pageX)-l.dragStartPoint.x,deltaY:(t.pageY||t.originalEvent.changedTouches[0].pageY)-l.dragStartPoint.y,event:t}),$(document).off(".drag"+n),$(window).off(".drag"+n),l.state=0})},g=function(t){l.state=2,l.dragStart.trigger(l,{currentTarget:a,target:i,startPoint:l.dragStartPoint,pageX:t.pageX,pageY:t.pageY,deltaX:t.pageX-l.dragStartPoint.x,deltaY:t.pageY-l.dragStartPoint.y,event:t,prevent:function(){$(document).off(".drag"+n),$(window).off(".drag"+n),l.state=0}})},h=function(){$(document).on(d?"touchmove.drag"+n:"mousemove.drag"+n,function(t){if(s&&t.preventDefault(),t.pageX=t.pageX||t.originalEvent.touches[0].pageX,t.pageY=t.pageY||t.originalEvent.touches[0].pageY,l.dragStartPoint.x!==t.pageX||l.dragStartPoint.y!==t.pageY)switch(l.state){case 1:case 2:1===l.state&&(Math.abs(t.pageX-l.dragStartPoint.x)>=l.delta||Math.abs(t.pageY-l.dragStartPoint.y)>=l.delta)&&g(t),window.cancelAnimationFrame(e),e=window.requestAnimationFrame(function(){2===l.state&&(l.drag.trigger(l,{currentTarget:a,target:i,startPoint:l.dragStartPoint,pageX:t.pageX,pageY:t.pageY,deltaX:t.pageX-l.dragStartPoint.x,deltaY:t.pageY-l.dragStartPoint.y,event:t,prevent:function(){$(document).off(".drag"+n),$(window).off(".drag"+n),l.state=0}}),l.lastDragX=t.pageX,l.lastDragY=t.pageY)})}}).on(d?"touchend.drag"+n:"mouseup.drag"+n,c),$(window).on("blur.drag"+n,c)};if(o>0){var p=setTimeout(function(){$(document).off(".checkmove"),g(t),h()},o);$(document).on("touchmove.checkmove touchend.checkmove touchcancel.checkmove mousemove.checkmove mouseup.checkmove",function(t){("touchmove"!==t.type&&"mousemove"!==t.type||t.pageX!==l.dragStartPoint.x||t.pageY!==l.dragStartPoint.y)&&(clearTimeout(p),$(document).off(".checkmove"))})}else h()}}),l.on()}function i(){return-1!==window.navigator.userAgent.indexOf("iPad")}var n=t("event"),r=0;o.prototype.on=function(){this.isOn=!0},o.prototype.off=function(){this.isOn=!1},a.exports=o}),define("event",function(t,e,a){function o(){this.funcList=[]}a.exports=o,o.prototype.trigger=function(t,e){for(var a=0;a<this.funcList.length;a++)this.funcList[a].call(t,e);return this},o.prototype.register=function(t){return this.funcList.push(t),this},o.prototype.unregister=function(t){for(var e=0;e<this.funcList.length;e++)this.funcList[e]===t&&this.funcList.splice(e,1);return this}}),define("defaultSlot",function(t,e,a){function o(){console.log("槽位类型出错！")}e.template=o,e.create=o,e.getAttr=o,e.setAttr=o}),define("shapeSlot",["size-converter","transform"],function(t,e,a){function o(){return $(g).html()}function i(t){var e=$(o()),a=t.x,i=t.y;return"preview"===$("body").attr("data-mode")&&(a-=h,i-=h),e.attr({"data-name":t.name,"data-decorationId":t.decorationId}),n(e,{locked:!1!==t.locked,index:t.index,x:c.mmToPx(a),y:c.mmToPx(i),width:c.mmToPx(t.width)+"px",height:c.mmToPx(t.height)+"px",rotation:t.rotation,opacity:t.opacity,color:t.color,borderColor:t.borderColor,borderWidth:t.borderWidth}),e}function n(t,e){t=$(t);var a=e.locked,o=e.x,i=e.y,n=e.width,r=e.height,s=e.rotation,l=e.index,c=e.borderColor,g=e.borderWidth,h=e.color,p=e.opacity;void 0!==a&&t.attr("data-locked",a),void 0!==n&&t.css("width",n),void 0!==r&&t.css("height",r),void 0!==o&&void 0!==i?(d.translate(t,o,i),t.css("transform","translate("+t.outerWidth()/2+"px,"+t.outerHeight()/2+"px)"+d.getCurrentTransform(t)+"translate("+-t.outerWidth()/2+"px,"+-t.outerHeight()/2+"px)")):(void 0!==o&&(d.translateX(t,o),t.css("transform","translate("+t.outerWidth()/2+"px,"+t.outerHeight()/2+"px)"+d.getCurrentTransform(t)+"translate("+-t.outerWidth()/2+"px,"+-t.outerHeight()/2+"px)")),void 0!==i&&(d.translateY(t,i),t.css("transform","translate("+t.outerWidth()/2+"px,"+t.outerHeight()/2+"px)"+d.getCurrentTransform(t)+"translate("+-t.outerWidth()/2+"px,"+-t.outerHeight()/2+"px)"))),void 0!==s&&(d.rotate(t,s),t.css("transform","translate("+t.outerWidth()/2+"px,"+t.outerHeight()/2+"px)"+d.getCurrentTransform(t)+"translate("+-t.outerWidth()/2+"px,"+-t.outerHeight()/2+"px)")),void 0!==l&&t.css("z-index",l).attr("data-index",l),void 0!==c&&t.css("border-color",c).attr("data-borderColor",c),void 0!==g&&t.css("border-width",g).attr("data-borderWidth",g),void 0!==h&&t.css("background-color",h).attr("data-color",h),void 0!==p&&t.css("opacity",p).attr("data-opacity",p)}function r(t){t=$(t);var e=d.getCurrent(t);return{locked:"true"===t.attr("data-locked"),x:e.translationX,y:e.translationY,rotation:e.rotation,width:parseFloat(t.css("width")),height:parseFloat(t.css("height")),index:parseFloat(t.attr("data-index")),borderColor:t.attr("data-borderColor")||"#ffffff",borderWidth:parseFloat(t.attr("data-borderWidth"))||0,opacity:t.attr("data-opacity"),color:t.attr("data-color")}}function s(t){return"true"===$(t).attr("data-locked")}var l=t("size-converter"),d=t("transform"),c=new l(108),g="#book_edit-template_shapeslot",h=3;e.template=o,e.create=i,e.getAttr=r,e.setAttr=n,e.isLocked=s}),define("shadingSlot",["size-converter","transform"],function(t,e,a){function o(){return $(g).html()}function i(t){var e=$(o()),a=t.x,i=t.y;return"preview"===$("body").attr("data-mode")&&"front-flap"!=$("#section_book_edit").children(".page").attr("data-seq")&&(a-=h,i-=h),e.attr({"data-name":t.name,"data-slotId":t.slotId}),n(e,{shadingId:t.shadingId,thumbUrl:t.thumbUrl,editUrl:t.editUrl,locked:!1!==t.locked,index:t.index,x:c.mmToPx(a),y:c.mmToPx(i),width:c.mmToPx(t.width)+"px",height:c.mmToPx(t.height)+"px",rotation:t.rotation,imgWidth:c.mmToPx(t.imgWidth)}),e}function n(t,e){t=$(t);var a=e.shadingId,o=(e.thumbUrl,e.editUrl),i=e.locked,n=e.index,r=e.width,s=e.height,l=e.x,c=e.y,g=e.rotation,h=e.imgWidth;void 0!==a&&t.attr("data-shadingId",a),void 0!==o&&t.attr("data-edit-url",o).children(".content").children(".img").attr("src",o),void 0!==h&&t.attr("data-img-width",h).children(".content").children(".img").css({width:h}),void 0!==i&&t.attr("data-locked",i),void 0!==n&&t.attr("data-index",n).css("z-index",n),void 0!==r&&t.css("width",r),void 0!==s&&t.css("height",s),void 0!==l&&void 0!==c?(d.translate(t,l,c),t.css("transform","translate("+t.outerWidth()/2+"px,"+t.outerHeight()/2+"px)"+d.getCurrentTransform(t)+"translate("+-t.outerWidth()/2+"px,"+-t.outerHeight()/2+"px)")):(void 0!==l&&(d.translateX(t,l),t.css("transform","translate("+t.outerWidth()/2+"px,"+t.outerHeight()/2+"px)"+d.getCurrentTransform(t)+"translate("+-t.outerWidth()/2+"px,"+-t.outerHeight()/2+"px)")),void 0!==c&&(d.translateY(t,c),
t.css("transform","translate("+t.outerWidth()/2+"px,"+t.outerHeight()/2+"px)"+d.getCurrentTransform(t)+"translate("+-t.outerWidth()/2+"px,"+-t.outerHeight()/2+"px)"))),void 0!==g&&(d.rotate(t,g),t.css("transform","translate("+t.outerWidth()/2+"px,"+t.outerHeight()/2+"px)"+d.getCurrentTransform(t)+"translate("+-t.outerWidth()/2+"px,"+-t.outerHeight()/2+"px)"))}function r(t){t=$(t);var e=d.getCurrent(t);return{shadingId:t.attr("data-shadingId"),locked:"true"===t.attr("data-locked"),index:parseFloat(t.attr("data-index")),width:parseFloat(t.css("width")),height:parseFloat(t.css("height")),x:e.translationX,y:e.translationY,rotation:e.rotation,editUrl:t.attr("data-edit-url"),imgWidth:parseFloat(t.attr("data-img-width"))}}function s(t){return"true"===$(t).attr("data-locked")}var l=t("size-converter"),d=t("transform"),c=new l(108),g="#book_edit-template_shadingslot",h=3;e.template=o,e.create=i,e.getAttr=r,e.setAttr=n,e.isLocked=s}),define("decorationSlot",["size-converter","transform"],function(t,e,a){function o(){return $(g).html()}function i(t){var e=$(o()),a=t.x,i=t.y;return"preview"===$("body").attr("data-mode")&&(a-=h,i-=h),e.attr({"data-name":t.name,"data-id":t.decorationId}),r(e,{locked:!1!==t.locked,index:t.index,x:c.mmToPx(a),y:c.mmToPx(i),width:c.mmToPx(t.width)+"px",height:c.mmToPx(t.height)+"px",rotation:t.rotation,img:t.src}),e}function n(t){t=$(t);var e=t.children(".content").children(".decoration_img"),a=d.getCurrent(t);return{locked:"true"===t.attr("data-locked"),x:a.translationX,y:a.translationY,rotation:a.rotation,width:parseFloat(t.css("width")),height:parseFloat(t.css("height")),index:parseFloat(t.attr("data-index")),borderWidth:parseFloat(t.attr("data-borderWidth"))||0,borderColor:t.attr("data-borderColor")||"#ffffff",img:e.attr("src")}}function r(t,e){t=$(t);var a=t.children(".content").children(".decoration_img"),o=e.locked,i=e.x,n=e.y,r=e.width,s=e.height,l=e.rotation,c=e.index,g=e.img;void 0!==g&&a.attr("src",g),void 0!==o&&t.attr("data-locked",o),void 0!==r&&t.css("width",r),void 0!==s&&t.css("height",s),void 0!==a&&a.css({width:"100%",height:"100%"}),void 0!==i&&void 0!==n?(d.translate(t,i,n),t.css("transform","translate("+t.outerWidth()/2+"px,"+t.outerHeight()/2+"px)"+d.getCurrentTransform(t)+"translate("+-t.outerWidth()/2+"px,"+-t.outerHeight()/2+"px)")):(void 0!==i&&(d.translateX(t,i),t.css("transform","translate("+t.outerWidth()/2+"px,"+t.outerHeight()/2+"px)"+d.getCurrentTransform(t)+"translate("+-t.outerWidth()/2+"px,"+-t.outerHeight()/2+"px)")),void 0!==n&&(d.translateY(t,n),t.css("transform","translate("+t.outerWidth()/2+"px,"+t.outerHeight()/2+"px)"+d.getCurrentTransform(t)+"translate("+-t.outerWidth()/2+"px,"+-t.outerHeight()/2+"px)"))),void 0!==l&&(d.rotate(t,l),t.css("transform","translate("+t.outerWidth()/2+"px,"+t.outerHeight()/2+"px)"+d.getCurrentTransform(t)+"translate("+-t.outerWidth()/2+"px,"+-t.outerHeight()/2+"px)")),void 0!==c&&t.css("z-index",c).attr("data-index",c)}function s(t){return"true"===$(t).attr("data-locked")}var l=t("size-converter"),d=t("transform"),c=new l(108),g="#book_edit-template_decorationslot",h=3;e.template=o,e.create=i,e.getAttr=n,e.setAttr=r,e.isLocked=s}),define("textSlot",["size-converter","transform"],function(t,e,a){function o(){return $(b).html()}function i(t){var e=$(o()),a=t.x,i=t.y;return e.attr({"data-name":t.name,"data-maxLine":t.maxLine,"data-maxLength":t.maxLength,"data-space":t.space,"data-leading":t.leading}),r(e,{locked:!1!==t.locked,index:t.index,content:t.content,pt:t.pt,space:t.space,leading:t.leading,color:t.color||"#000",fontId:t.fontId,align:t.align,x:v.mmToPx(a),y:v.mmToPx(i),width:v.mmToPx(t.width),height:v.mmToPx(t.height),rotation:t.rotation||0,weight:t.weight,style:t.style,decoration:t.decoration,opacity:t.opacity||1,readonly:!0===t.readonly,doNotAutoSetTextboxHeight:!0}),e}function n(t){t=$(t);var e=m.getCurrent(t);return{locked:"true"===t.attr("data-locked"),content:t.children(".content").attr("content")?t.children(".content").attr("content"):t.children(".content").text(),fontId:t.attr("data-fontId"),pt:parseFloat(t.attr("data-pt")),space:parseFloat(t.attr("data-space")),leading:parseFloat(t.attr("data-leading")),color:t.attr("data-color"),align:t.attr("data-align"),index:parseFloat(t.attr("data-index")),width:parseFloat(t.css("width")),height:parseFloat(t.css("height")),decoration:t.attr("data-text-decoration"),style:t.attr("data-font-style"),weight:t.attr("data-font-weight"),opacity:t.attr("data-opacity")||1,readonly:t.attr("data-readonly"),maxLine:t.attr("data-maxLine"),maxLength:t.attr("data-maxLength"),x:e.translationX,y:e.translationY,rotation:e.rotation}}function r(t,e){t=$(t);var a=e.locked,o=e.index,i=e.content,n=e.fontId,r=e.pt,l=e.space,d=e.leading,c=e.color,g=e.align,h=e.width,p=e.height,u=e.decoration,f=e.style,b=e.weight,x=e.x,S=e.y,y=e.rotation,w=e.readonly,k=e.opacity;1==w&&t.attr("data-readonly",w),void 0!==a&&t.attr("data-locked",a),void 0!==o&&t.attr("data-index",o).css("z-index",o),void 0!==i&&(""===i?t.addClass("prompt"):t.removeClass("prompt"),t.children(".content").text(i)),void 0!==n&&t.attr("data-fontId",n).css("font-family","font"+n+',"Microsoft YaHei","Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif'),void 0!==r&&t.css({"font-size":v.ptToPx(r)}).attr("data-pt",r),void 0!==l&&t.css({"letter-spacing":l/1e3+"em"}).attr("data-space",l),void 0!==d&&t.css({"line-height":d<0?"1.2em":v.ptToPx(d)+"px"}).attr("data-leading",d),void 0!==c&&t.attr("data-color",c).css({color:c}),void 0!==g&&t.attr("data-align",g).css({"text-align":g}),void 0!==h&&t.css("width",h),void 0!==p&&t.css("height",p),void 0!==u&&t.attr("data-text-decoration",u).css({"text-decoration":u}),void 0!==b&&t.attr("data-font-weight",b).css({"font-weight":b}),void 0!==f&&t.attr("data-font-style",f).css({"font-style":f}),void 0!==x&&void 0!==S?(m.translate(t,x,S),t.css("transform","translate("+t.outerWidth()/2+"px,"+t.outerHeight()/2+"px)"+m.getCurrentTransform(t)+"translate("+-t.outerWidth()/2+"px,"+-t.outerHeight()/2+"px)")):(void 0!==x&&(m.translateX(t,x),t.css("transform","translate("+t.outerWidth()/2+"px,"+t.outerHeight()/2+"px)"+m.getCurrentTransform(t)+"translate("+-t.outerWidth()/2+"px,"+-t.outerHeight()/2+"px)")),void 0!==S&&(m.translateY(t,S),t.css("transform","translate("+t.outerWidth()/2+"px,"+t.outerHeight()/2+"px)"+m.getCurrentTransform(t)+"translate("+-t.outerWidth()/2+"px,"+-t.outerHeight()/2+"px)"))),void 0!==y&&(m.rotate(t,y),t.css("transform","translate("+t.outerWidth()/2+"px,"+t.outerHeight()/2+"px)"+m.getCurrentTransform(t)+"translate("+-t.outerWidth()/2+"px,"+-t.outerHeight()/2+"px)")),void 0!==k&&t.attr("data-opacity",k).css({opacity:k}),e.doNotAutoSetTextboxHeight||void 0===i&&void 0===n&&void 0===r&&void 0===l&&void 0===d||s(t)}function s(t){t=$(t),r(t,{height:l(t)})}function l(t){t=$(t);var e=t.children(".content"),a=$(document.createElement("div"));a.css({"white-space":"pre-wrap","word-wrap":"break-word",border:"2px solid red",position:"absolute",width:e.width(),"font-family":e.css("font-family"),"font-size":e.css("font-size"),"line-height":e.css("line-height"),"letter-spacing":e.css("letter-spacing"),"text-align":e.css("text-align")}).attr("contenteditable",!0).html(e.html()+" "),a.appendTo($("body"));var o=a.outerHeight();return a.remove(),o}function d(t,e){t=$(t),t.hasClass("editing")||(c(t,e),$(document).on("pointerdown.closeTextboxEditingMode",function(e){$(e.target).is(t.add(t.find("*")).add($(".edit_box_tool")).add($(".edit_box_tool").find("*")).add(x).add(x.find("*")))||p()||(t.children(".content").trigger("blur"),t.removeClass("editing"),$(document).off(".closeTextboxEditingMode"))}),t.data("selectionHandles").hide(),t.addClass("editing"))}function c(t,e){t=$(t),"spine"===t.parent().attr("data-num")?x.addClass("single-row"):x.removeClass("single-row");var a=n(t);x.data({el:t,initialText:a.content,callback:e}),x.hasClass("single-row")&&void 0!==a.content&&(a.content=a.content.replace(/[\r\n]/g,"")),S.val(a.content),art.dialog({id:"edit-text",title:"编辑",lock:!0,padding:0,content:document.querySelector("#text-slot-input-container")})}function g(t,e){t=$(t),"spine"===t.parent().attr("data-num")?x.addClass("single-row"):x.removeClass("single-row");var a=n(t);x.data({el:t,initialText:a.content,callback:e}),x.hasClass("single-row")&&void 0!==a.content&&(a.content=a.content.replace(/[\r\n]/g,"")),S.val(a.content).width(a.width/2*($(window).width()/1920)).height(a.height/2*($(window).height()/1080));var o=t[0].getBoundingClientRect();x.offAnimationEnd().css({display:"block",animation:"none"});var i,r;t.width()/t.height()>3?o.top+o.height/2<$(window).height()/2?(x.attr({"data-direction":"bottom"}),i=o.top+o.height+10,r=o.left-(x.outerWidth(!0)-o.width)/2):(x.attr({"data-direction":"top"}),i=o.top-x.outerHeight(!0)-10,r=o.left-(x.outerWidth(!0)-o.width)/2):o.left+(o.right-o.left)/2>$(window).width()/2?(x.attr({"data-direction":"left"}),i=o.top-(x.outerHeight()-o.height)/2,r=o.left-x.outerWidth()-10):(x.attr({"data-direction":"right"}),i=o.top-(x.outerHeight()-o.height)/2,r=o.right+10),i+=$(window).scrollTop(),i<5?i=5:i+x.outerHeight()>$(window).height()-5&&(i=$(window).height()-x.outerHeight()-5),r<5?r=5:r+x.outerWidth()>$(window).width()-5&&(r=$(window).width()-x.outerWidth()-5),x.offset({top:i,left:r}).oneAnimationEnd(function(t){var e=S[0];e.focus();var a=e.value.length;if(document.selection){var o=e.createTextRange();o.moveStart("character",a),o.collapse(),o.select()}else"number"==typeof e.selectionStart&&"number"==typeof e.selectionEnd&&(e.selectionStart=e.selectionEnd=a)}).css({animation:"jump-in 0.1s"})}function h(){SureUtil.closeDialog("edit-text"),"none"!==x.css("display")&&(x.oneAnimationEnd(function(t){$(this).css({display:"none"}),x.removeData("el")}).css({animation:"jump-out 0.1s forwards"}),x.removeData("initialText"),x.removeData("callback"),$(document).off(".hideDialogTextInput"))}function p(){var t=x.data("el");if("none"!==x.css("display")){var e=t.parent().attr("data-seq"),a=t.attr("data-name"),o=S.val();if(void 0===e)throw new Error("pageSeq为undefined");if(void 0===a)throw new Error("name为undefined");if(void 0===o)throw new Error("content为undefined");if(void 0!==x.data("initialText")&&o!==x.data("initialText")){var i=x.data("callback");"function"==typeof i&&i(t,o)}h()}}function u(t){return"true"===$(t).attr("data-locked")}var f=t("size-converter"),m=t("transform"),v=new f(108),b="#book_edit-template_textslot",x=$("#text-slot-input-container"),S=$("#text-slot-input-textarea");e.template=o,e.create=i,e.getAttr=n,e.setAttr=r,e.isLocked=u,e.setTextSlotModeToEditing=d,e.saveAndCloseTextInputDialog=p,e.showTextInputDialog=g,e.closeTextInputDialog=h,e.getTextSlotTextHeight=l}),define("imageSlot",["size-converter","transform","imgload","opEvent"],function(t,e,a){function o(){return $(b).html()}function i(t,e){var a=$(o()),i=t.x,n=t.y;if(a.attr({"data-name":t.name,"data-slot-id":t.slotId}),r(a,{locked:!1!==t.locked,index:t.index,x:v.mmToPx(i),y:v.mmToPx(n),width:v.mmToPx(t.width)+"px",height:v.mmToPx(t.height)+"px",rotation:t.rotation,borderWidth:v.ptToPx(t.borderWidth),borderColor:t.borderColor,opacity:t.opacity}),t.image&&e||t.themeImage){var s=function(){var o=t.themeImage||t.image,i=e&&e.width?e.width:void 0,n=e&&e.height?e.height:void 0;a.children(".content").children(".img").replaceWith($(this).addClass("img")),a.children(".content").children(".img").attr({"data-id":o.id,"data-filter":o.filter}).data("originalSize",{width:i,height:n}).css({visibility:"visible",width:this.width,height:this.height}),r(a,{image:{x:v.mmToPx(o.x),y:v.mmToPx(o.y),width:v.mmToPx(o.width),rotation:o.rotation}}),a.addClass("has-img").removeClass("img_loading")};a.addClass("img_loading");var l;l=t.themeImage?t.themeImage.url:e.ir.src,l&&f(l,function(){s.call(this)})}else t.image&&t.image.id&&""!=t.image.id&&!e&&a.addClass("photo_not_found"),a.children(".content").children(".img").remove();return t.image&&a.attr("data-fileName",t.image.fileName),a}function n(t){var e=$(t),a=e.children(".content").children(".img"),o=u.getCurrent(e),i={locked:"true"===e.attr("data-locked"),x:o.translationX,y:o.translationY,rotation:o.rotation,width:parseFloat(e.css("width")),height:parseFloat(e.css("height")),index:parseFloat(e.attr("data-index")),borderWidth:parseFloat(e.attr("data-borderWidth"))||0,borderColor:e.attr("data-borderColor")||"#ffffff",opacity:parseFloat(e.attr("data-opacity"))};if(0!==a.length){var n=u.getCurrent(a);i.image={id:a.attr("data-id"),width:n.scale*a.width(),x:n.translationX,y:n.translationY,rotation:n.rotation,url:a.attr("src")}}return i}function r(t,a){var o=$(t),i=o.children(".content").children(".img"),n=a.locked,r=a.borderWidth,s=a.borderColor,l=a.x,d=a.y,c=a.width,g=a.height,h=a.rotation,p=a.index,f=a.opacity,b=a.image?{x:a.image.x,y:a.image.y,width:a.image.width,rotation:a.image.rotation}:null===a.image?null:void 0;if(void 0!==n&&o.attr("data-locked",n),void 0!==r&&o.attr("data-borderWidth",r).css("border-width",r),void 0!==s&&o.attr("data-borderColor",s).css("border-color",s),void 0!==c&&(o.css("width",c),o.parent().attr("data-seq")&&m.eImageSlotResize.trigger(e,{pageSeq:o.parent().attr("data-seq"),name:o.attr("data-name"),width:o.width(),height:o.height(),widthMM:v.pxToMm(o.width()),heightMM:v.pxToMm(o.height())})),void 0!==g&&(o.css("height",g),o.parent().attr("data-seq")&&m.eImageSlotResize.trigger(e,{pageSeq:o.parent().attr("data-seq"),name:o.attr("data-name"),width:o.width(),height:o.height(),widthMM:v.pxToMm(o.width()),heightMM:v.pxToMm(o.height())})),void 0!==l&&void 0!==d?(u.translate(o,l,d),o.css("transform","translate("+o.outerWidth()/2+"px,"+o.outerHeight()/2+"px)"+u.getCurrentTransform(o)+"translate("+-o.outerWidth()/2+"px,"+-o.outerHeight()/2+"px)")):(void 0!==l&&(u.translateX(o,l),o.css("transform","translate("+o.outerWidth()/2+"px,"+o.outerHeight()/2+"px)"+u.getCurrentTransform(o)+"translate("+-o.outerWidth()/2+"px,"+-o.outerHeight()/2+"px)")),void 0!==d&&(u.translateY(o,d),o.css("transform","translate("+o.outerWidth()/2+"px,"+o.outerHeight()/2+"px)"+u.getCurrentTransform(o)+"translate("+-o.outerWidth()/2+"px,"+-o.outerHeight()/2+"px)"))),void 0!==h&&(u.rotate(o,h),o.css("transform","translate("+o.outerWidth()/2+"px,"+o.outerHeight()/2+"px)"+u.getCurrentTransform(o)+"translate("+-o.outerWidth()/2+"px,"+-o.outerHeight()/2+"px)")),void 0!==p&&o.css("z-index",p).attr("data-index",p),void 0!==f&&o.css("opacity",f).attr("data-opacity",f),void 0!==b)if(null!==b){var x;void 0!==b.x&&void 0!==b.y?(u.translate(i,b.x,b.y),x=u.getCurrent(i),i.css({transform:"translate("+(i.width()*x.scale/2).toFixed(6)+"px,"+(i.height()*x.scale/2).toFixed(6)+"px) "+u.getCurrentTransform(i)+"translate(-50%,-50%)"})):(void 0!==b.x&&(u.translateX(i,b.x),x=u.getCurrent(i),i.css({transform:"translate("+(i.width()*x.scale/2).toFixed(6)+"px,"+(i.height()*x.scale/2).toFixed(6)+"px) "+u.getCurrentTransform(i)+"translate(-50%,-50%)"})),void 0!==b.y&&(u.translateY(i,b.y),x=u.getCurrent(i),i.css({transform:"translate("+(i.width()*x.scale/2).toFixed(6)+"px,"+(i.height()*x.scale/2).toFixed(6)+"px) "+u.getCurrentTransform(i)+"translate(-50%,-50%)"}))),void 0!==b.width&&(u.scale(i,b.width/i.width()),x=u.getCurrent(i),i.css({transform:"translate("+(i.width()*x.scale/2).toFixed(6)+"px,"+(i.height()*x.scale/2).toFixed(6)+"px) "+u.getCurrentTransform(i)+"translate(-50%,-50%)"}),o.parent().attr("data-seq")),void 0!==b.rotation&&(u.rotate(i,b.rotation),x=u.getCurrent(i),i.css({transform:"translate("+(i.width()*x.scale/2).toFixed(6)+"px,"+(i.height()*x.scale/2).toFixed(6)+"px) "+u.getCurrentTransform(i)+"translate(-50%,-50%)"}))}else o.removeClass("has-img"),i.remove()}function s(t){return t=$(t),0==t.children(".content").children(".img").length}function l(t){t=$(t);var e=n(t),a=u.getCurrentTransform(t);t.css("transform",a+"translate(50%,50%)rotate("+-e.rotation+"deg)translate(-50%,-50%)");var o=t[0].getBoundingClientRect(),i=t.children(".content").children(".img")[0].getBoundingClientRect(),s=view.edit.getBookCurrentScale();t.css("transform",a);var l=e.image.x,d=e.image.y,c=!1;return i.width<=o.width?i.left<o.left?(l=e.image.x+(o.left-i.left)/s,c=!0):i.right>o.right&&(l=e.image.x+(o.right-i.right)/s,c=!0):i.left>o.left?(l=e.image.x+(o.left-i.left)/s,c=!0):i.right<o.right&&(l=e.image.x+(o.right-i.right)/s,c=!0),i.height<=o.height?i.top<o.top?(d=e.image.y+(o.top-i.top)/s,c=!0):i.bottom>o.bottom&&(d=e.image.y+(o.bottom-i.bottom)/s,c=!0):i.top>o.top?(d=e.image.y+(o.top-i.top)/s,c=!0):i.bottom<o.bottom&&(d=e.image.y+(o.bottom-i.bottom)/s,c=!0),c&&r(t,{image:{x:l,y:d}}),{x:l,y:d}}function d(t,a,o,i){var s,t=$(t),l=t.children(".content").children("img"),d=(l.height(),l.width(),n(t)),g=!1;switch(a){case"zoomin":s=d.image.width+v.mmToPx(10);break;case"zoomout":s=d.image.width-v.mmToPx(10);break;case"adjust":case"fill":r(t,{rotation:0});var h=l[0].getBoundingClientRect();r(t,{rotation:d.rotation});var p=view.edit.getBookCurrentScale();switch(a){case"adjust":s=h.width/h.height>d.width/d.height?d.width*d.image.width/(h.width/p):d.height*d.image.width/(h.height/p);break;case"fill":s=h.width/h.height>d.width/d.height?d.height*d.image.width/(h.height/p):d.width*d.image.width/(h.width/p)}g=!0}var f=c(t,s,g);t.data("backImgWrapper")&&t.data("backImgWrapper").css("transform",u.getCurrentTransform(l));var b=t.parent().attr("data-seq"),x=t.attr("data-name");$(t).data("zoomChangeEventClockToken")&&(clearTimeout($(t).data("zoomChangeEventClockToken")),$(t).removeData("zoomChangeEventClockToken")),$(t).data("zoomChangeEventClockToken",setTimeout(function(){m.eImageSlotChanged.trigger(e,{pageSeq:b,name:x,obj:{image:{x:v.pxToMm(f.x),y:v.pxToMm(f.y),width:v.pxToMm(f.width)}}}),"function"==typeof o&&o.call(view.edit)},i?0:400))}function c(t,e,a){var o=t.children(".content").children(".img"),i=o.height()/o.width();o.width()>o.height()?e<50&&(e=50):e*i<50&&(e=50/i);var s=n(t);r(t,{image:{width:e}});var d,c,g=e-s.image.width,h=(e-s.image.width)*i;a?(d=(s.width-e)/2,c=(s.height-e*i)/2):(d=s.image.x-g*(s.width/2-s.image.x)/s.image.width,c=s.image.y-h*(s.height/2-s.image.y)/(s.image.width*i)),r(t,{image:{x:d,y:c}});var p=l(t);return{x:p.x,y:p.y,width:e}}function g(t){if(t=$(t),t.hasClass("photo_not_found")&&SureMsg.error("这张照片没有上传完，请续传"),0!==t.children(".content").children(".img").length&&!t.hasClass("editing")){var e=t.children(".content").children(".img"),a=e.clone().removeAttr("style"),o=$($("#template_edit_move_img_backimg_wrapper").html()).append(a);t.data("backImgWrapper",o),o.attr("style",e.attr("style")).prependTo(t),$(document).on("pointerdown.hide.closeImgboxEditingMode",function(e){$(e.target).is(t.add(t.find("*")).add($(".edit_box_tool")).add($(".edit_box_tool").find("*")))||(t.removeClass("editing").data("backImgWrapper").remove(),t.removeData("backImgWrapper"),$(document).off(".closeImgboxEditingMode"))}),t.data("selectionHandles").hide(),t.addClass("editing")}}function h(t){return"true"===$(t).attr("data-locked")}var p=t("size-converter"),u=t("transform"),f=t("imgload"),m=t("opEvent"),v=new p(108),b="#book_edit-template_imageslot";e.template=o,e.create=i,e.getAttr=n,e.setAttr=r,e.isEmpty=s,e.isLocked=h,e.preventImgOutSlot=l,e.zoomImgInSlot=d,e.scaleImgInSlot=c,e.setImgSlotModeToEditing=g}),define("photo",["md5"],function(t,e,a){var o=t("md5"),i=!0;"undefined"!=typeof isTpl&&(i=isTpl);var n=[],r={getById:function(t){for(var e=0;e<n.length;e++)if(n[e].ir.checksum===t)return n[e];return null},delById:function(t){for(var e=0;e<n.length;e++)n[e].ir.checksum===t&&n.splice(e,1)},getPhotos:function(){return n},getPhotoInPage:function(t){t instanceof Array||(t=[t]);for(var e={},a=0;a<t.length;a++){var o=t[a];if(o&&o.imageSlotList)for(var i=0;i<o.imageSlotList.length;i++){var n=o.imageSlotList[i];n.image&&(e[n.image.id]=r.getById(n.image.id))}}return e},getBookPhoto:function(t,e){var a="/api/book/"+t+"/photo/?tpl=false";i&&(a="/api/book/"+t+"/photo/?tpl=true"),SureAjax.ajax({url:a,type:"GET",async:!1,headers:{Accept:"application/json"},success:function(t){n=t.data,"function"==typeof e&&e(n)}})},addPhoto:function(t,e,a,o,r){var s="/api/book/"+t+"/photo/?name="+e+"&desc="+a+"&tpl=false";i&&(s="/api/book/"+t+"/photo/?name="+e+"&desc="+a+"&tpl=true"),SureAjax.ajax({url:s,type:"POST",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",data:JSON.stringify(o),success:function(t){n.push(t),r(t)}})},getPhoto:function(t,e,a){var o="/api/book/"+t+"/photo/"+e+"?tpl=false";i&&(o="/api/book/"+t+"/photo/"+e+"?tpl=true"),SureAjax.ajax({url:o,type:"GET",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",success:a})},deletePhoto:function(t,e,a){var o="/api/book/"+t+"/photo/"+e+"?tpl=false";i&&(o="/api/book/"+t+"/photo/"+e+"?tpl=true"),SureAjax.ajax({url:o,type:"DELETE",headers:{Accept:"application/json"},success:function(t){"function"==typeof a&&a(t)},parseError:!1,error:function(){SureMsg.msg("图片已经入册，不能删除 !")}})},deletePhotoByChecksum:function(t,e,a){var o="/api/book/"+t+"/photo/"+e+"?tpl=false";i&&(o="/api/book/"+t+"/photo/"+e+"?tpl=true"),SureAjax.ajax({url:o,type:"DELETE",headers:{Accept:"application/json"},success:function(t){"function"==typeof a&&a(t)},parseError:!1,error:function(){SureMsg.msg("图片已经入册，不能删除 !")}})},checkILByChecksum:function(t,e,a,o,n){var r="/api/book/"+e+"/photo/"+t+"?tpl=false";i&&(r="/api/book/"+e+"/photo/"+t+"?tpl=true");var s="function"==typeof a;return 0==n&&(r+="?addToBook=false"),SureAjax.ajax({async:s,parseError:!1,url:r,type:"GET",headers:{Accept:"application/json"},success:function(t){"function"==typeof a&&a(t)},error:function(t){"function"==typeof o&&o(t)}}),null},isILExist:function(t,e,a,i,n){o.calMd5(t,function(t){var e=r.getById(t);null!=e?"function"==typeof a&&a(e):"function"==typeof i&&i(t)})}};return r}),define("book",["canvas"],function(t,e,a){function o(t){window.bookId=xt=t.bookId,window.userId=St=t.userId,yt=t,lt()}function i(){return yt}function n(t){void 0!=t.name&&(yt.name=t.name),void 0!=t.width&&(yt.width=t.width,$.each(g(!0),function(e,a){a.width=t.width})),void 0!=t.height&&(yt.height=t.height,$.each(g(!0),function(e,a){a.height=t.height})),void 0!=t.status&&(yt.status=t.status),void 0!=t.thumbnail&&(yt.thumbnail=t.thumbnail)}function r(t,e,a){t?bt("all",function(){n({status:"publish"}),ut(e,a)}):(n({status:"publish"}),ut(e,a))}function s(t,e){h(t).thumbnail=e,"front-cover"==t&&n({thumbnail:e})}function l(){return yt}function d(){return xt}function c(){return St}function g(t){var e;return e=t?[].concat(yt.innerPage):JSON.parse(JSON.stringify(yt.innerPage)),yt.flyleaf&&e.unshift(yt.flyleaf),yt.backFlap&&e.unshift(yt.backFlap),yt.frontFlap&&e.unshift(yt.frontFlap),yt.spine&&e.unshift(yt.spine),yt.cover&&e.unshift(yt.cover),yt.copyright&&e.push(yt.copyright),yt.backCover&&e.push(yt.backCover),e}function h(t){if(void 0===t)return null;if("front-cover"===t)return yt.cover;if("spine"===t)return yt.spine;if("front-flap"===t)return yt.frontFlap;if("back-flap"===t)return yt.backFlap;if("flyleaf"===t)return yt.flyleaf;if("copyright"===t)return yt.copyright;if("back-cover"===t)return yt.backCover;for(var e=0;e<yt.innerPage.length;e++){var a=yt.innerPage[e];if(a.seq.toString()===t.toString())return a}return null}function p(t,e){for(var a=h(t),o=0;o<a.imageSlotList.length;o++){var i=a.imageSlotList[o];if(i.name.toString()===e.toString())return i}return null}function u(t,e){for(var a=h(t),o=0;o<a.textSlotList.length;o++){var i=a.textSlotList[o];if(i.name.toString()===e.toString())return i}return null}function f(t,e){for(var a=h(t),o=0;o<a.shapeSlotList.length;o++){var i=a.shapeSlotList[o];if(i.name.toString()===e.toString())return i}return null}function m(t,e){for(var a=h(t),o=0;o<a.decorationSlotList.length;o++){var i=a.decorationSlotList[o];if(i.name.toString()===e.toString())return i}return null}function v(t,e){for(var a=h(t),o=0;o<a.shadingSlotList.length;o++){var i=a.shadingSlotList[o];if(i.name.toString()===e.toString())return i}return null}function b(t,e){for(var a=[],o=0;o<e.length;o++)a.push(e[o].name);var i,n=!1;for(o=1;!1===n;o++){i=t+"_"+o,n=!0;for(var r=0;r<a.length;r++)if(i===a[r]){n=!1;break}}return i}function x(t){for(var e,a=0,o=h(t),i=0;i<o.imageSlotList.length;i++){var n=o.imageSlotList[i];e=parseFloat(n.index),e>a&&(a=e)}for(i=0;i<o.textSlotList.length;i++){var r=o.textSlotList[i];e=parseFloat(r.index),e>a&&(a=e)}if(null!=o.decorationSlotList&&o.decorationSlotList.length>0)for(i=0;i<o.decorationSlotList.length;i++){var s=o.decorationSlotList[i];e=parseFloat(s.index),e>a&&(a=e)}if(null!=o.shapeSlotList&&o.shapeSlotList.length>0)for(i=0;i<o.shapeSlotList.length;i++){var l=o.shapeSlotList[i];e=parseFloat(l.index),e>a&&(a=e)}return a+1}function S(t,e){e=e||{};var a=h(t),o=a.imageSlotList,i=b(It.image,o),n=x(t);return o.push({name:i,index:n,width:80,height:60,x:(a.width-80)/2,y:(a.height-60)/2,slotId:"001",rotation:0,borderWidth:0,borderColor:"#ffffff",image:null,themeImage:null,locked:!1}),w(t,i,e),p(t,i)}function y(t,e,a,o){a&&ot(t),w(t,e,o)}function w(t,e,a){var o=a.locked,i=a.index,n=a.width,r=a.height,s=a.x,l=a.y,d=a.slotId,c=a.rotation,g=a.borderWidth,u=a.borderColor,f=a.opacity,m=a.image?{id:a.image.id,fileName:a.image.fileName,x:a.image.x,y:a.image.y,width:a.image.width,rotation:a.image.rotation,filter:a.image.filter,url:a.image.url}:null===a.image?null:void 0,v=p(t,e);void 0!==o&&(v.locked=o),void 0!==i&&(v.index=parseFloat(i)),void 0!==n&&(v.width=parseFloat(n)),void 0!==r&&(v.height=parseFloat(r)),void 0!==s&&(v.x=parseFloat(s)),void 0!==l&&(v.y=parseFloat(l)),void 0!==d&&(v.slotId=d),void 0!==c&&(v.rotation=parseFloat(c)),void 0!==g&&(v.borderWidth=parseFloat(g)),void 0!==u&&(v.borderColor=u),void 0!==f&&(v.opacity=f),void 0!==m&&(null!==m?(null===v.image&&(v.image={}),void 0!==m.id&&(v.image.id=m.id,v.themeImage&&(v.themeImage=null)),void 0!==m.fileName&&(v.image.fileName=m.fileName),void 0!==m.x&&(v.image.x=parseFloat(m.x),v.themeImage&&(v.themeImage.x=parseFloat(m.x))),void 0!==m.y&&(v.image.y=parseFloat(m.y),v.themeImage&&(v.themeImage.y=parseFloat(m.y))),void 0!==m.width&&(v.image.width=parseFloat(m.width),v.themeImage&&(v.themeImage.width=parseFloat(m.width))),void 0!==m.rotation&&(v.image.rotation=parseFloat(m.rotation),v.themeImage&&(v.themeImage.rotation=parseFloat(m.rotation))),void 0!==m.filter&&(v.image.filter=m.filter),void 0!==m.url&&(v.image.url=m.url)):(v.image=null,v.themeImage&&(v.themeImage=null))),kt[t]=h(t)}function k(t,e){for(var a=h(t),o=0;o<a.imageSlotList.length;o++)if(a.imageSlotList[o].name.toString()===e.toString())return ot(t),a.imageSlotList.splice(o,1),kt[t]=a,!0;return!1}function T(t,e){e=e||{};var a=h(t),o=a.textSlotList,i=b(It.text,o),n=x(t);return ot(t),o.push({name:i,index:n,width:100,height:20,x:(a.width-100)/2,y:(a.height-20)/2,content:"",pt:14,color:"#000000",rotation:0,fontId:window.globalFontId?window.globalFontId:"101",maxLine:-1,maxLength:-1,align:"left",space:0,leading:-1,locked:!1}),C(t,i,e),u(t,i)}function P(t,e,a,o){a&&ot(t),C(t,e,o)}function C(t,e,a){var o=a.locked,i=a.index,n=a.width,r=a.height,s=a.x,l=a.y,d=a.content,c=a.pt,g=a.color,p=a.rotation,f=a.fontId,m=a.align,v=a.space,b=a.leading,x=a.weight,S=a.decoration,y=a.style,w=a.borderWidth,k=a.borderColor,T=a.readonly,P=a.maxLine,$=a.maxLength,C=u(t,e);void 0!==T&&(C.readonly=T),void 0!==P&&(C.maxLine=P),void 0!==$&&(C.maxLength=$),void 0!==o&&(C.locked=o),void 0!==i&&(C.index=parseFloat(i)),void 0!==n&&(C.width=parseFloat(n)),void 0!==r&&(C.height=parseFloat(r)),void 0!==s&&(C.x=parseFloat(s)),void 0!==l&&(C.y=parseFloat(l)),void 0!==d&&(C.content=d),void 0!==c&&(C.pt=parseFloat(c)),void 0!==g&&(C.color=g),void 0!==p&&(C.rotation=parseFloat(p)),void 0!==f&&(C.fontId=f),void 0!==m&&(C.align=m),void 0!==v&&(C.space=parseFloat(v)),void 0!==b&&(C.leading=parseFloat(b)),void 0!==x&&(C.weight=x),void 0!=S&&(C.decoration=S),void 0!=y&&(C.style=y),void 0!==w&&(C.borderWidth=parseFloat(w)),void 0!==k&&(C.borderColor=k),kt[t]=h(t)}function I(t,e){for(var a=h(t),o=0;o<a.textSlotList.length;o++)if(a.textSlotList[o].name.toString()===e.toString())return ot(t),a.textSlotList.splice(o,1),kt[t]=a,!0;return!1}function _(t,e,a,o,i){var n=h(t);n.shadingSlotList||(n.shadingSlotList=[]);var r=b(It.shading,n.shadingSlotList);0==n.shadingSlotList.length?n.shadingSlotList.push({shadingId:e,thumbUrl:a,editUrl:o,name:r,width:n.width,height:n.height,rotation:0,index:0,locked:!0,imgWidth:i,x:0,y:0}):(r=n.shadingSlotList[0].name,q(t,r,!0,{shadingId:e,thumbUrl:a,editUrl:o,imgWidth:i}))}function q(t,e,a,o){a&&ot(t),E(t,e,o)}function E(t,e,a){var o=a.locked,i=a.index,n=a.width,r=a.height,s=a.x,l=a.y,d=a.rotation,c=a.imgWidth,g=a.shadingId,p=a.thumbUrl,u=a.editUrl,f=v(t,e);void 0!==o&&(f.locked=o),void 0!==i&&(f.index=parseFloat(i)),void 0!==n&&(f.width=parseFloat(n)),void 0!==r&&(f.height=parseFloat(r)),void 0!==s&&(f.x=parseFloat(s)),void 0!==l&&(f.y=parseFloat(l)),void 0!==d&&(f.rotation=d),void 0!==c&&(f.imgWidth=c),void 0!==g&&(f.shadingId=g),void 0!==p&&(f.thumbUrl=p),void 0!==u&&(f.editUrl=u),kt[t]=h(t)}function L(t,e,a,o,i,n){e=e||{};var r=h(t);r.decorationSlotList||(r.decorationSlotList=[]);var s=r.decorationSlotList,l=b(It.decoration,s),d=x(t);ot(t);var c=$.extend(!0,{},e);return s.push({name:l,index:d,decorationId:e.id,src:e.value,rotation:0,width:a,height:o,x:i||(r.width-80)/2,y:n||(r.height-60)/2,locked:!1}),c.width=a,c.height=o,M(t,l,c),m(t,l)}function A(t,e,a,o){a&&ot(t),M(t,e,o)}function M(t,e,a){var o=a.locked,i=a.index,n=a.width,r=a.height,s=a.x,l=a.y,d=a.decorationId,c=a.rotation,g=a.src,p=m(t,e);void 0!==o&&(p.locked=o),void 0!==i&&(p.index=i),void 0!==n&&(p.width=n),void 0!==r&&(p.height=r),void 0!==s&&(p.x=s),void 0!==l&&(p.y=l),void 0!==d&&(p.decorationId=d),void 0!==c&&(p.rotation=c),void 0!==g&&(p.src=g),kt[t]=h(t)}function B(t,e){for(var a=h(t),o=0;o<a.decorationSlotList.length;o++)if(a.decorationSlotList[o].name.toString()===e.toString())return ot(t),a.decorationSlotList.splice(o,1),kt[t]=a,!0;return!1}function j(t,e){e=e||{};var a=h(t);a.shapeSlotList||(a.shapeSlotList=[]);var o=a.shapeSlotList,i=b(It.shape,o),n=x(t);return ot(t),o.push({name:i,index:n,slotId:"301",shapeId:e.id,rotation:0,width:e.w||25,height:e.h||25,color:e.color||"#2db572",borderWidth:e.borderWidth,borderColor:e.borderColor,opacity:e.opacity,x:(a.width-80)/2,y:(a.height-60)/2,locked:!1}),F(t,i,e),f(t,i)}function z(t,e,a,o){a&&ot(t),F(t,e,o)}function F(t,e,a){var o=a.locked,i=a.index,n=a.width,r=a.height,s=a.x,l=a.y,d=a.slotId,c=a.shapeId,g=a.rotation,p=a.color,u=a.borderWidth,m=a.borderColor,v=a.opacity,b=f(t,e);void 0!==o&&(b.locked=o),void 0!==i&&(b.index=i),void 0!==n&&(b.width=n),void 0!==r&&(b.height=r),void 0!==s&&(b.x=s),void 0!==l&&(b.y=l),void 0!==d&&(b.slotId=d),void 0!==c&&(b.shapeId=c),void 0!==g&&(b.rotation=g),void 0!==v&&(b.opacity=v),void 0!==u&&(b.borderWidth=u),void 0!==m&&(b.borderColor=m),void 0!==p&&(b.color=p),kt[t]=h(t)}function H(t,e){for(var a=h(t),o=0;o<a.shapeSlotList.length;o++)if(a.shapeSlotList[o].name.toString()===e.toString())return ot(t),a.shapeSlotList.splice(o,1),kt[t]=a,!0;return!1}function W(t){if(ot(t.seq),"front-cover"===t.seq)return yt.cover=t,!0;if("spine"===t.seq)return yt.spine=t,!0;if("front-flap"===t.seq)return yt.frontFlap=t,!0;if("back-flap"===t.seq)return yt.backFlap=t,!0;if("flyleaf"===t.seq)return yt.flyleaf=t,!0;if("copyright"===t.seq)return yt.copyright=t,!0;if("back-cover"===t.seq)return yt.backCover=t,!0;for(var e=0;e<yt.innerPage.length;e++)if(yt.innerPage[e].seq.toString()===t.seq.toString())return yt.innerPage[e]=t,!0;return kt[t.seq]=t,!1}function D(t){var e=$t[t].pop(),a=h(t);if(!e)return null;Ct[t]||(Ct[t]=[]),Ct[t].push(JSON.stringify(a));var o=JSON.parse(e);if("front-cover"===t)yt.cover=o;else if("spine"===t)yt.spine=o;else if("front-flap"===t)yt.frontFlap=o;else if("back-flap"===t)yt.backFlap=o;else if("flyleaf"===t)yt.flyleaf=o;else if("back-cover"===t)yt.backCover=o;else for(var i=0;i<yt.innerPage.length;i++)yt.innerPage[i].seq.toString()===t.toString()&&(yt.innerPage[i]=o);return kt[t]=o,o}
function X(t){var e=Ct[t].pop(),a=h(t);if(!e)return null;$t[t].push(JSON.stringify(a));var o=JSON.parse(e);if("front-cover"===t)yt.cover=o;else if("spine"===t)yt.spine=o;else if("front-flap"===t)yt.frontFlap=o;else if("back-flap"===t)yt.backFlap=o;else if("flyleaf"===t)yt.flyleaf=o;else if("back-cover"===t)yt.backCover=o;else for(var i=0;i<yt.innerPage.length;i++)yt.innerPage[i].seq.toString()===t.toString()&&(yt.innerPage[i]=o);return kt[t]=o,o}function R(t){return $t[t]||($t[t]=[]),$t[t].length}function U(t){return Ct[t]||(Ct[t]=[]),Ct[t].length}function N(t){var e=[];t.forEach(function(t){e.some(function(e){return e===t.pageSeq})||e.push(t.pageSeq)}),e.forEach(function(t){ot(t)}),t.forEach(function(t){var e=t.pageSeq,a=t.name,o=t.type,i=h(e);switch(o){case _t.image:i.imageSlotList.remove(function(t){return t.name===a});break;case _t.decoration:i.decorationSlotList.remove(function(t){return t.name===a});break;case _t.shape:i.shapeSlotList.remove(function(t){return t.name===a});break;case _t.text:i.textSlotList.remove(function(t){return t.name===a});break;case _t.shading:i.shadingSlotList.remove(function(t){return t.name===a})}})}function Y(t,e,a){var o,i=h(t);if(i.imageSlotList)for(o=0;o<i.imageSlotList.length;o++)if(i.imageSlotList[o].x===e&&i.imageSlotList[o].y===a)return!0;if(i.textSlotList)for(o=0;o<i.textSlotList.length;o++)if(i.textSlotList[o].x===e&&i.textSlotList[o].y===a)return!0;if(i.decorationSlotList)for(o=0;o<i.decorationSlotList.length;o++)if(i.decorationSlotList[o].x===e&&i.decorationSlotList[o].y===a)return!0;if(i.shapeSlotList)for(o=0;o<i.shapeSlotList.length;o++)if(i.shapeSlotList[o].x===e&&i.shapeSlotList[o].y===a)return!0;return!1}function O(t,a,o){if(!["spine"].contains(t)&&0!==e.slotsClipboard.length){var i=h(t),n=x(t);ot(t);var r,s=!0,l=!0,d=function(e,r){for(void 0!==a&&void 0!==o&&(e.x=a-e.width/2,e.y=o-e.height/2);Y(t,e.x,e.y);){var d,c;d=s?parseFloat(e.x)+10:parseFloat(e.x)-10,c=l?parseFloat(e.y)+10:parseFloat(e.y)-10,d+e.width/2>i.width||d+e.width/2<0?s=!s:c+e.height/2>i.height||c+e.height/2<0?l=!l:(e.x=d,e.y=c)}e.index+=n,e.locked=!1};return e.slotsClipboard.forEach(function(t){switch(r=JSON.parse(JSON.stringify(t.slot)),t.type){case"imageslot":i.imageSlotList||(i.imageSlotList=[]),r.name=b(It.image,i.imageSlotList),d(r),i.imageSlotList.push(r);break;case"decorationslot":i.decorationSlotList||(i.decorationSlotList=[]),r.name=b(It.decoration,i.decorationSlotList),d(r),i.decorationSlotList.push(r);break;case"shapeslot":i.shapeSlotList||(i.shapeSlotList=[]),r.name=b(It.shape,i.shapeSlotList),d(r),i.shapeSlotList.push(r);break;case"textslot":i.textSlotList||(i.textSlotList=[]),r.name=b(It.text,i.textSlotList),d(r),i.textSlotList.push(r);break;case"shadingslot":i.shadingSlotList||(i.shadingSlotList=[]),r.name=b(It.shading,i.shadingSlotList),d(r),i.shadingSlotList.push(r)}}),r}}function J(t){var e=h(t);ot(t),e.imageSlotList=it(e.imageSlotList),e.textSlotList=it(e.textSlotList),e.shapeSlotList=it(e.shapeSlotList),e.decorationSlotList=it(e.decorationSlotList),e.shadingSlotList=it(e.shadingSlotList)}function V(t,e,a){(t=parseInt(t))%2==1&&(t+=1);var o={name:"empty",width:yt.width,height:yt.height,imageSlotList:[],textSlotList:[],shapeSlotList:[],decorationSlotList:[],shadingSlotList:[]};o.type="normal";var i=yt.innerPage.length;switch(a=parseInt(a),a%2==0&&(a+=1),e){case"front":a>0&&(a-=1);for(var n=0;n<t;n++)yt.innerPage.splice(a,0,G(i+n,"add","normal",o,!1));break;case"behind":a<i&&(a+=1);for(var n=0;n<t;n++)yt.innerPage.splice(a,0,G(i+n,"add","normal",o,!1));break;case"last":for(var n=0;n<t;n++)yt.innerPage.push(G(i+n,"add","normal",o,!1));break;case"first":for(var n=0;n<t;n++)yt.innerPage.unshift(G(i+n,"add","normal",o,!1))}lt()}function G(t,e,a,o,i){return{seq:t.toString(),name:e+"."+o.name,width:o.width,height:o.height,imageSlotList:function(){for(var t=[],e=0;e<o.imageSlotList.length;e++){var n;n=i&&3==a?K(o.imageSlotList[e]):Q(o.imageSlotList[e]),t.push(n)}return t}(),textSlotList:function(){for(var t=[],e=0;e<o.textSlotList.length;e++){var a=Z(o.textSlotList[e]);t.push(a)}return t}(),shapeSlotList:function(){var t=[];if(void 0==o.shapeBoxList)return t;for(var e=0;e<o.shapeSlotList.length;e++){var a=tt(o.shapeSlotList[e]);t.push(a)}return t}(),decorationSlotList:function(){var t=[];if(void 0==o.decorationSlotList)return t;for(var e=0;e<o.decorationSlotList.length;e++){var a=et(o.decorationSlotList[e]);t.push(a)}return t}(),shadingSlotList:function(){var t=[];if(void 0==o.shadingSlotList)return t;for(var e=0;e<o.shadingSlotList.length;e++){var a=at(o.shadingSlotList[e]);t.push(a)}return t}(),backgroundColor:o.backgroundColor||"#fff",type:a}}function Z(t){return{name:t.name,index:void 0==t.index?1:t.index,width:t.width,height:t.height,x:t.x,y:t.y,rotation:void 0==t.rotation?0:t.rotation,content:void 0==t.content?"":t.content,pt:t.pt,color:t.color,fontId:t.fontId||"101",align:t.align,space:t.space,leading:t.leading||-1,opacity:t.opacity||1,locked:void 0!=t.locked&&t.locked}}function Q(t){return{name:t.name,index:void 0==t.index?1:t.index,width:t.width,height:t.height,x:t.x,y:t.y,rotation:void 0==t.rotation?0:t.rotation,borderWidth:t.borderWidth||0,borderColor:t.borderColor||"#ffffff",slotId:t.slotId||null,image:null,locked:void 0!=t.locked&&t.locked}}function K(t){return{name:t.name,index:void 0==t.index?1:t.index,width:t.width,height:t.height,x:t.x,y:t.y,rotation:void 0==t.rotation?0:t.rotation,borderWidth:t.borderWidth||0,borderColor:t.borderColor||"#ffffff",slotId:t.slotId||null,image:t.image||null,themeImage:t.themeImage||null,locked:void 0!=t.locked&&t.locked}}function tt(t){return{border_color:t.border_color,border_width:t.border_width,color:t.color,color_id:t.color_id,height:t.height,index:void 0==t.index?1:t.index,name:t.name,opacity:t.opacity,rotation:void 0==t.rotation?0:t.rotation,width:t.width,x:t.x,y:t.y,locked:void 0!=t.locked&&t.locked}}function et(t){return{decorationId:t.decorationId,height:t.height,index:void 0==t.index?1:t.index,locked:!1,name:t.name,rotation:void 0==t.rotation?0:t.rotation,src:t.src,width:t.width,x:t.x,y:t.y}}function at(t){return{shadingId:t.shadingId,height:t.height,index:void 0==t.index?1:t.index,locked:!1,name:t.name,imgWidth:t.imgWidth,rotation:void 0==t.rotation?0:t.rotation,width:t.width,x:t.x,y:t.y,editUrl:t.editUrl,thumbUrl:t.thumbUrl}}function ot(t){$t[t]||($t[t]=[]),$t[t].push(JSON.stringify(h(t))),Ct[t]=[]}function it(t){for(var e=[],a=0;a<t.length;a++){1==t[a].readonly&&e.push(t[a])}return e}function nt(t){var e={};for(var a in t)e[a]=h(a.toString());for(a in e)e[a].seq=t[a].toString();yt.innerPage.sort(function(t,e){return t.seq-e.seq});for(a in e)kt[a]=e[a]}function rt(t){var e=null;return $.each(t,function(t,a){for(var t=0;t<yt.innerPage.length;t++)a.toString()==yt.innerPage[t].seq.toString()&&(yt.innerPage.splice(t,1),null==e&&(e=t-1))}),lt(),ut(),e<0?0:e<yt.innerPage.length-1?e+1:"back-cover"}function st(t,e,a){V(t,e,a),ut()}function lt(){for(var t=0;t<yt.innerPage.length;t++)yt.innerPage[t].seq=""+t}function dt(t,e,a){!0===a&&ot(t),ct(t,e)}function ct(t,e){var a=e.backgroundColor,o=h(t);o&&(void 0!==a&&(o.backgroundColor=a),kt[o.seq]=o)}function gt(t,e){for(var a=[],o=[],i=0;i<Math.max(t.length,pageNums2.length);i++)a.push(h(parseFloat(t[0])+i)),o.push(h(parseFloat(e[0])+i));for(i=0;i<Math.max(t.length,e.length);i++)a[i].seq=(parseFloat(e[0])+i).toString(),o[i].seq=(parseFloat(t[0])+i).toString();for(yt.innerPage.sort(function(t,e){return t.seq-e.seq}),i=0;i<a.length;i++)kt[a[i].seq]=a[i];for(i=0;i<o.length;i++)kt[o[i].seq]=o[i]}function ht(){var t,e=yt.innerPage,a=0;for(t=0;t<e.length;t++)e[t].imageSlotList&&e[t].imageSlotList.length&&!e[t].imageSlotList.some(function(t){return t.image})||(2===e[t].type?a+=2:a+=1);return a/e.length}function pt(){var t,e,a,o,i,n,r,s,l,d,c,h=g(!1),p=0;for(t=0;t<h.length;t++)if(o=h[t],"spine"!=o.num)if(r)r=!1,p++;else{for(r=2==o.type,s=o.imageSlotList.length,l=o.textSlotList.length,d=o.decorationSlotList?o.decorationSlotList.length:0,c=o.shapeSlotList?o.shapeSlotList.length:0,e=0;e<s&&(i=o.imageSlotList[e],"imglogo"==i.name||i&&i.image&&i.image.id);e++);if(0!=e&&e===s&&p++,0==s){for(a=0;a<l&&((n=o.textSlotList[a])&&""!=n.content&&null!=n.content);a++);0!=a&&a===l?p++:o.decorationSlotList&&d>0?p++:o.shapeSlotList&&c>0&&p++}0===s&&0===l&&0===d&&0===c&&p++}else p++;return p/h.length}function ut(t,a){qt=[];var o=function(t,e){for(var a=0;a<e.imageSlotList.length;a++){var o=e.imageSlotList[a];o.image&&o.image.id&&model.photo.getById(o.image.id)}a===e.imageSlotList.length?qt.contains(function(t){return t.num===e.num})||-1==$.inArray(e,qt)&&qt.push(e):Pt[t]=e};$.each(kt,function(){"front-cover"==this.seq&&(kt["front-flap"]=h("front-flap"))});for(var i in kt){var n=""==kt[i]?null:kt[i];delete kt[i],null!=n&&o(i,n)}for(var i in Tt){var n=Tt[i];delete Tt[i],o(i,n)}for(var i in Pt){var n=Pt[i];delete Pt[i],o(i,n)}var r=function(t){if(t.image){model.photo.getById(t.image.id)&&(t.image.uploaded=!0)}};yt.cover&&yt.cover.imageSlotList&&yt.cover.imageSlotList.forEach(r),yt.flyleaf&&yt.flyleaf.imageSlotList&&yt.flyleaf.imageSlotList.forEach(r),yt.frontFlap&&yt.frontFlap.imageSlotList&&yt.frontFlap.imageSlotList.forEach(r),yt.innerPage&&yt.innerPage.forEach(function(t){t.imageSlotList&&t.imageSlotList.forEach(r)}),yt.copyright&&yt.copyright.imageSlotList&&yt.copyright.imageSlotList.forEach(r),SureAjax.ajax({url:"/api/book/info/",type:"POST",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",data:JSON.stringify(model.book.getBookInfo()),success:function(a){"function"==typeof t&&t.call(e,a)},error:function(t){a.call(e,t)}})}function ft(t,e){var a=h(t);Api.template.addPageTemplate(mt(a),function(t){"function"==typeof e&&e(t)})}function mt(t){var e={};return e.name=t.name,e.width=t.width,e.height=t.height,e.type=t.type,e.level="U",e.tplId=xt,e.resource=vt(t),e}function vt(t){var e={};if($.extend(!0,e,t),null!==e.imageSlotList&&void 0!==e.imageSlotList)for(var a=0;a<e.imageSlotList.length;a++){var o=e.imageSlotList[a];o.image&&(o.image=null)}if(null!==e.textSlotList&&void 0!==e.textSlotList)for(var a=0;a<e.textSlotList.length;a++){var i=e.textSlotList[a];i.content=""}if(null!==e.shapeSlotList&&void 0!==e.shapeSlotList)for(var a=0;a<e.shapeSlotList.length;a++){var n=e.shapeSlotList[a];""!=n.borderColor&&null!=n.borderColor||(n.borderColor="#ffffff")}return null===e.decorationSlotList&&void 0===e.decorationSlotList||(e.decorationSlotList=null),e}function bt(t,a){if(void 0==t||"all"==t){var o=g(!0),i=o.length,n=0,r=function(){n<i?(SureMsg.updateLoadBar("已完成["+n+"/"+i+"]"),l()):n===i&&"function"==typeof a&&a.call(e)},l=function(){bt(o[n].seq,function(){n++,r()})};r()}else{var d=h(t),c=model.photo.getPhotoInPage(t);wt.generateThumbnail(d,c,function(o){var i=o.ir;s(t,i.src),"function"==typeof a&&a.call(e)},108)}}var xt,St,yt,wt=t("canvas"),kt=window.changed={},Tt={},Pt={},$t={},Ct={},It={image:"image",text:"text",shape:"shape",decoration:"decoration",shading:"shading"},_t={image:"imageslot",text:"textslot",shape:"shapeslot",decoration:"decorationslot",shading:"shadingslot"},qt=[];e.init=o,e.getBookInfo=i,e.get=l,e.update=n,e.publish=r,e.updateThumbnail=s,e.getBookId=d,e.getUserId=c,e.getAllPages=g,e.getPageBySeq=h,e.getImageSlotByPageSeqAndName=p,e.getTextSlotByPageSeqAndName=u,e.getShapeSlotByPageSeqAndName=f,e.getDecorationSlotByPageSeqAndName=m,e.getShadingSlotByPageSeqAndName=v,e.insertImageSlot=S,e.updateImageSlot=y,e.deleteImageSlot=k,e.insertTextSlot=T,e.updateTextSlot=P,e.deleteTextSlot=I,e.addShadingSlot=_,e.updateShadingSlot=q,e.insertDecorationSlot=L,e.updateDecorationSlot=A,e.deleteDecorationSlot=B,e.insertShapeSlot=j,e.updateShapeSlot=z,e.deleteShapeSlot=H,e.replacePage=W,e.sortPages=nt,e.exchangePages=gt,e.updatePage=dt,e.undo=D,e.redo=X,e.getHistoryLength=R,e.getUndoHistoryLength=U,e.removeSlots=N,e.pasteSlots=O,e.slotsClipboard=[],e.clearPage=J,e.saveChanges=ut,e.generateNewPage=G,e.addNewEmptyPage=V,e.generateNewImageSlot=Q,e.generateNewImageSlotFixImage=K,e.generateNewShadingSlot=at,e.generateNewDecorationSlot=et,e.generateNewShapeSlot=tt,e.generateNewTextSlot=Z,e.computeCompletedPercent=pt,e.computeCompletedPagePercent=ht,e.initSort=lt,e.saveMyTemplate=ft,e.generateThumb=bt,e.delPages=rt,e.addPages=st,e.slotsClipboard=[]}),define("leftTemplate",["event","canvas","pageUtil","size-converter"],function(t,e,a){function o(){$("#left-template-main select").chosen({placeholder_text:"请选择",no_results_text:"无",disable_search:!0}),n()}function i(t,e){var a=$("#left-template-item").html();$.each(e,function(e,i){var n=$(a);n.data("tpl",i),n.attr("data-id",i.id);var r=i.resource;if(null!=i.thumbnail){var s=n.find("img.page_thumbnail")[0],l=90*h.mmToPx(r.height)/h.mmToPx(r.width);Math.floor(s.height)!==Math.floor(l)&&$(s).attr("src",i.thumbnail).css({width:90,height:l}),n.css({height:l}).find("canvas").remove()}else{var g=n.find("canvas.page_thumbnail")[0],l=90*h.mmToPx(r.height)/h.mmToPx(r.width);Math.floor(g.height)!==Math.floor(l)&&$(g).attr({width:90,height:l}),n.css({height:l}).find("img").remove(),d.generatePreviewCanvas(r,{},function(t){var e=t.canvas,a=g.getContext("2d"),n=c.scaleImage(e,g.width,g.height);a.drawImage(n,0,0),null==i.thumbnail&&d.generateThumbnail(r,{},function(t){var e=t.ir;Api.template.updatePageTemplate(i.id,{thumbnail:e.src},function(t){templatePool.del(i.id),t.resource=i.resource,templatePool.add(t),o()})},108)},108)}t.append(n)})}function n(t){var e=$("#left-template-main select").val(),a=t;a=void 0==t?view.edit.getActivePage().attr("data-type"):t.type;var o=templatePool.getAll(e,a);u.empty(),0==o.length?u.append($("#empty").html()):i(u,o),$("#left-template-num").text(o.length)}function r(){p.unbind("click").on("click",".left-template-li",function(){var t=$(this).data("tpl");opEvent.eTemplateListItemSelected.trigger(e,{currentPageSeq:view.edit.getActivePageSeq(),template:t.resource})}).on("click",".delete_key",function(t){t.preventDefault(),t.stopPropagation();var e=$(this).parent(),a=e.data("tpl");Api.template.delPageTemplate(a.id,function(){templatePool.del(a.id),o(),SureMsg.success("删除成功")})}).on("change","select",function(){n()})}function s(){opEvent.ePageListItemSelected.register(function(t){var e=t.pageSeqs,a=t.selectedPageSeq;void 0===a&&(a=e[0]),n(model.book.getPageBySeq(a))})}var l=t("event"),d=t("canvas"),c=t("pageUtil"),g=t("size-converter"),h=new g(108),p=$("#left-template-main"),u=$("#left-template-list"),f={eTemplateListItemSelected:new l};e.init=o,e.bind=r,e.events=f,e.initEvent=s}),define("leftBackground",["size-converter","event"],function(t,e,a){function o(){i(),r(),s()}function i(){var t=["全部"];void 0!=typeof systemBgTag&&""!=systemBgTag&&(t=systemBgTag.split(","));var e="";$.each(t,function(t,a){e+="全部"==a?'<li class="active">'+a+"</li>":"<li >"+a+"</li>"}),$("#left-background-tag ul").empty().append(e)}function n(t,e){var a=$("#left-background-list-template").html();$.each(e,function(e,o){var i=$(a);i.data("background",o),i.attr("data-id",o.id),i.find("img").attr("src",o.value+"?imageView2/2/w/100"),t.append(i)})}function r(){var t=$("#left-background-tag li.active").text(),e=backgroundPool.getByTag(t);f.empty(),0==e.length?f.append($("#empty").html()):n(f,e),$("#left-background-total-system-num").text(e.length)}function s(){var t=backgroundPool.getUser();m.empty(),0==t.length?m.append($("#empty").html()):n(m,t),$("#left-background-total-user-num").text(t.length)}function l(){u.unbind("click").on("click","#backgroundUpload",function(){opEvent.ePopUpload.trigger(e,{type:"background",onUpload:function(t,e){Api.material.addUser(Api.material.createBackground(t),function(a){backgroundPool.addOne(a),e(t)})},onClose:function(){o()},check:function(t,e,a,o){backgroundPool.isExist(t,e,a,o)}})}).on("click",".left-background-item",function(){var t=$(this).data("background"),a=$(this).find("img").attr("src");opEvent.eNewShadingInsert.trigger(e,{bg:t,pageSeq:view.edit.getActivePageSeq(),shadingId:t.id,shadingEdit:t.url,shadingThumb:a,imgWidth:h.pxToMm(t.width)})}).on("click",".delete_key",function(t){t.preventDefault(),t.stopPropagation();var e=$(this).parent(),a=e.data("background");Api.material.del(a.id,function(){backgroundPool.deleteOne(a.id),o(),SureMsg.success("删除成功")})}).on("click","#left-background-tag li",function(t){$(this).addClass("active").siblings().removeClass("active"),r()})}function d(){}function c(){}var g=t("size-converter"),h=new g(108),p=t("event"),u=$("#left-background-main"),f=$("#left-background-system-list"),m=$("#left-background-user-list"),v={eNewShadingInsert:new p};e.init=o,e.bind=l,e.load=c,e.reload=d,e.events=v}),define("leftDecoration",["draggable","transform","size-converter","event"],function(t,e,a){function o(){i(),r(),s()}function i(){var t=["全部"];void 0!=typeof systemDeTag&&""!=systemDeTag&&(t=systemDeTag.split(","));var e="";$.each(t,function(t,a){e+="全部"==a?'<li class="active">'+a+"</li>":"<li >"+a+"</li>"}),$("#left-decoration-tag ul").empty().append(e)}function n(t,e){var a=$("#decoration-li-template").html();$.each(e,function(e,o){var i=$(a);i.data("decoration",o),i.attr("data-id",o.id),i.find("img").attr("src",o.value+"?imageView2/2/w/100"),t.append(i)})}function r(){var t=$("#left-decoration-tag li.active").text(),e=decorationPool.getByTag(t);b.empty(),0==e.length?b.append($("#empty").html()):n(b,e),$("#left-decoration-total-system-num").text(e.length)}function s(){var t=decorationPool.getUser();x.empty(),0==t.length?x.append($("#empty").html()):n(x,t),$("#left-decoration-total-user-num").text(t.length)}function l(){var t,a=new h("#left-decoration-main .decorate_main_box ","li",10,0,!1);a.dragStart.register(function(e){if(e.event.type.indexOf("touch")>-1){if(Math.abs(e.deltaX)<Math.abs(e.deltaY))return void e.prevent();e.event.preventDefault()}var a=$(e.currentTarget);if(a.attr("is-loading"))return void e.prevent();a.data("click",!1);var o=a.children("img");if(0===o.length)return void e.prevent();var i=a.data("decoration");t=o.clone(),t.data("decoration",i),t.css({position:"absolute","z-index":100,top:0,left:0,visibility:"hidden","backface-visibility:":"hidden"}).addClass("photo-drag-thumb"),$("body").addClass("dragging-decoration"),t.appendTo("body");var n=t.outerWidth(),r=t.outerHeight();p.translate(t,e.pageX-n/2,e.pageY-r/2),t.css({visibility:"visible"}),$("#section_book_edit").attr("data-strike","true")}),a.drag.register(function(e){var a=t.outerWidth(),o=t.outerHeight();a*o>0&&(t.css("visibility","visible"),p.translate(t,e.pageX-a/2,e.pageY-o/2)),t.data("cushionClockToken")&&clearTimeout(t.data("cushionClockToken")),t.data("cushionClockToken",setTimeout(function(){t.css("display","none");$(document.elementFromPoint(e.pageX-$(window).scrollLeft(),e.pageY-$(window).scrollTop()));t.css("display","block")},1e3/60))}),a.dragEnd.register(function(a){t.data("cushionClockToken")&&clearTimeout(t.data("cushionClockToken"));var o=t.data("decoration");t.remove(),t=null;var i,n,r,s,l=$(document.elementFromPoint(a.pageX-$(window).scrollLeft(),a.pageY-$(window).scrollTop()));if(l.is(".page, .page *")){i=l.hasClass("page")?l:l.parents(".page"),n=i.attr("data-seq"),r=view.edit.getPageRect(i,!0),s=view.edit.getBookCurrentScale();var d=view.edit.getActivePageSeq();"flyleaf"!=d&&"copyright"!=d&&opEvent.eNewDecorationInsert.trigger(e,{decoration:o,pageSeq:n,x:m.pxToMm((a.pageX-r.left)/s),y:m.pxToMm((a.pageY-r.top)/s)})}$("body").removeClass("dragging-decoration"),$("#section_book_edit").attr("data-strike","false")})}function d(){v.unbind("click").on("click","#decorationUpload",function(){opEvent.ePopUpload.trigger(e,{type:"decoration",onUpload:function(t,e){Api.material.addUser(Api.material.createDecoration(t),function(a){decorationPool.addOne(a),e(t)})},onClose:function(){o()},check:function(t,e,a,o){decorationPool.isExist(t,e,a,o)}})}).on("click",".delete_key",function(t){t.preventDefault(),t.stopPropagation();var e=$(this).parent(),a=e.data("decoration");Api.material.del(a.id,function(){decorationPool.deleteOne(a.id),o(),SureMsg.success("删除成功")})}).on("click","#left-decoration-tag li",function(t){$(this).addClass("active").siblings().removeClass("active"),r()}),l()}function c(){}function g(){}var h=t("draggable"),p=t("transform"),u=t("size-converter"),f=t("event"),m=new u(108),v=$("#left-decoration-main"),b=$("#left-decoration-system-list"),x=$("#left-decoration-user-list"),S={eNewDecorationInsert:new f};e.init=o,e.bind=d,e.load=g,e.reload=c,e.events=S}),define("leftPageList",["pageUtil","event"],function(t,e,a){function o(t){var e=model.photo.getPhotos();d.initPageList(c,t,e,"single",function(){})}function i(t,a,o,i){setTimeout(function(){d.initPageList(c,t,a,"single",function(){"function"==typeof i&&i.call(e)})},100)}function n(){$("#left-page-list-main").unbind("click").on("click",".j-add-page",function(){opEvent.ePopAddPage.trigger(e,{})}).on("click",".page_item",function(t){var a,o=$(this),i=o.attr("data-page-seq").split(",");a=$(t.target).hasClass("page_thumbnail")?$(t.target).attr("data-page-seq"):i[0],s()&&opEvent.eBookSaving.trigger(e,{}),opEvent.ePageListItemSelected.trigger(e,{currentPageSeqs:view.edit.getCurrentPageSeqs(),pageSeqs:i,selectedPageSeq:a})})}function r(t){c.find(".page_thumbnail").attr("aria-selected",!1).filter("[data-page-seq="+t+"]").attr("aria-selected",!0).parents(".page_item").attr("aria-selected",!0).siblings(".page_item").attr("aria-selected",!1);var e=c.children('.page_item[aria-selected="true"]'),a=e[0].getBoundingClientRect(),o=c.parent()[0].getBoundingClientRect();a.top<o.top?c.parent().stop(!0,!0).animate({scrollTop:"-="+(o.top-a.top+a.height)}):a.bottom>o.bottom&&c.parent().stop(!0,!0).animate({scrollTop:"+="+(a.bottom-o.bottom+a.height)})}function s(){for(var t in window.changed)return!0;return!1}function l(){opEvent.eDrawPageThumbnail.register(function(t){var e=t.pageInfo,a=t.photos,o=t.callback;d.drawPageThumbnail(c,e,a,o)}),opEvent.eSetPageActive.register(function(t){r(t.pageSeq)}),opEvent.eRefreshAll.register(function(t){i(t.book,t.photos,t.selectPageSeq,function(){})})}var d=t("pageUtil"),c=(t("event"),$("#left-page-list"));e.init=o,e.bind=n,e.events={},e.initEvent=l,e.refresh=i}),define("leftPhoto",["size-converter","event","draggable","transform","pageUtil"],function(t,e,a){function o(t){var e=m.html(),a=$(e);return a.find(".img_thumbnail").attr("src",t.ir.src+"?imageView2/2/w/100"),a.data("il",t),a.attr("data-photo-id",t.id),a.attr("data-photo-md5",t.ir.checksum),n(a),a}function i(){var t,a=new g(f,"li",10,0,!1);a.dragStart.register(function(e){if(e.event.type.indexOf("touch")>-1){if(Math.abs(e.deltaX)<Math.abs(e.deltaY))return void e.prevent();e.event.preventDefault()}var a=$(e.currentTarget);if(a.attr("is-loading"))return void e.prevent();a.data("click",!1);var o=a.children(".img_thumbnail");if(0===o.length)return void e.prevent();var i=a.data("il");t=o.clone(),t.data("il",i),t.css({position:"absolute","z-index":100,top:0,left:0,visibility:"hidden","backface-visibility:":"hidden"}).addClass("photo-drag-thumb"),$("body").addClass("dragging-photo"),t.appendTo("body");var n=t.outerWidth(),r=t.outerHeight();h.translate(t,e.pageX-n/2,e.pageY-r/2),t.css({visibility:"visible"}),$("#section_book_edit").attr("data-strike","true")}),a.drag.register(function(e){var a=t.outerWidth(),o=t.outerHeight();a*o>0&&(t.css("visibility","visible"),h.translate(t,e.pageX-a/2,e.pageY-o/2)),t.data("cushionClockToken")&&clearTimeout(t.data("cushionClockToken")),t.data("cushionClockToken",setTimeout(function(){t.css("display","none");var a=$(document.elementFromPoint(e.pageX-$(window).scrollLeft(),e.pageY-$(window).scrollTop()));if(t.css("display","block"),$(".imageslot").removeClass("dragover"),a.is(".imageslot,.imageslot *")){(a.hasClass("imageslot")?a:a.parents(".imageslot")).addClass("dragover"),t.removeClass("grabbing-cursor"),t.css({cursor:"copy"})}else t.addClass("grabbing-cursor")},1e3/60))}),a.dragEnd.register(function(a){t.data("cushionClockToken")&&clearTimeout(t.data("cushionClockToken"));var o=t.data("il");t.remove(),t=null;var i,n,r,s,l,d=$(document.elementFromPoint(a.pageX-$(window).scrollLeft(),a.pageY-$(window).scrollTop()));if(d.is(".imageslot,.imageslot *"))i=d.hasClass("imageslot")?d:d.parents(".imageslot"),r=i.parent().attr("data-seq"),opEvent.eInsertNewPhotoToSlot.trigger(e,{il:o,pageSeq:r,name:i.attr("data-name"),isNet:!0});else if(d.is(".page, .page *")){n=d.hasClass("page")?d:d.parents(".page"),r=n.attr("data-seq"),s=view.edit.getPageRect(n,!0),l=view.edit.getBookCurrentScale();var c=view.edit.getActivePageSeq();"flyleaf"!=c&&"copyright"!=c&&opEvent.eEmptyDrop.trigger(e,{il:o,pageSeq:r,x:u.pxToMm((a.pageX-s.left)/l),y:u.pxToMm((a.pageY-s.top)/l)})}$(".imageslot").removeClass("dragover"),$("body").removeClass("dragging-photo"),$("#section_book_edit").attr("data-strike","false")})}function n(t){var e=t.attr("data-photo-md5"),a=model.book.getAllPages();$.each(a,function(a,o){for(var i=o.imageSlotList,a=0;a<i.length;a++)if(i[a].image){var n=i[a].image.id;if(n==e){var r=o.seq;t.addClass("has_been_choice");var s=r;return"front-cover"==r&&(s="封"),"back-cover"==r&&(s="底"),"flyleaf"==r&&(s="扉"),"backFlap"==r&&(s="前"),"frontFlap"==r&&(s="后"),"spine"==r&&(s="脊"),"copyright"==r&&(s="版"),t.children("span").attr("data-page-seq",r).text(s),!1}}}),t.hasClass("has_been_choice")||t.children("span").remove()}function r(){var t=model.photo.getPhotos(model.book.getBookId());if(f.empty(),v.text(t.length),t.length>0)for(var e=0;e<t.length;e++)f.append(o(t[e]));else f.append($("#empty").html())}function s(){i(),$("#left-photo-main").on("click","#photoUploadFile",function(){opEvent.ePopUpload.trigger(e,{type:"photo",onUpload:function(t,e){model.photo.addPhoto(model.book.getBookId(),t.name,"",t,function(t){e(t)})},onClose:function(){r()},check:function(t,e,a,o){model.photo.isILExist(t,e,a,o)}})}).on("click",".delete_key",function(t){var e=$(this).parent(),a=e.data("il");model.photo.deletePhoto(model.book.getBookId(),a.ir.checksum,function(){model.photo.delById(a.ir.checksum),r(),SureMsg.success("删除成功")})}).on("click",".has_been_choice",function(){var t=$(this),e=(t.data("il"),t.children("span").attr("data-page-seq"));view.pagelist.goto(e)}).on("click",".add_new_photo",function(){$(this).toggleClass("open"),$(window).on("click",function(t){0==$(t.target).closest(".add_new_photo").length&&$(".add_new_photo").removeClass("open")})}).on("click",".btn_phone_upload",function(){art.dialog({title:"扫一扫",lock:!0,fixed:!0,content:document.querySelector(".phone_upload_pop")})}).on("ifChanged","#left-photo-hide-use",function(){"checked"==$(this).attr("checked")?$("#left-photo-main .has_been_choice").hide():$("#left-photo-main .has_been_choice").show()})}function l(){opEvent.eEmptyDrop.register(function(t){var e=t.pageSeq;if(!["blank","spine","front-flap"].some(function(t){return t===e})){var a=t.il,o=t.x,i=t.y,n=model.book.getPageBySeq(e),r={width:100,height:100};r.x=o-r.width/2,r.y=i-r.height/2,r.image={width:r.width,id:a.ir.checksum,fileName:a.name,rotation:0};var s=r.width/r.height,l=a.ir.width/a.ir.height;if(r.image.width=l>s?r.height*l:r.width,r.image.x=(r.width-r.image.width)/2,r.image.y=(r.height-r.image.width/l)/2,n){var r=model.book.insertImageSlot(n.seq,r);if(r.image&&r.image.id){model.photo.getById(r.image.id)}var d=model.photo.getPhotoInPage(n);view.edit.initPageSlot(n,d),p.triggerDrawPageThumbnail(n),view.edit.selectSlot(e,r.name)}}})}var d=t("size-converter"),c=t("event"),g=t("draggable"),h=t("transform"),p=t("pageUtil"),u=new d(108),f=$("#left-photo-list"),m=$("#left-photo-template"),v=$("#left-photo-total-num"),b={eEmptyDrop:new c};e.init=r,e.bind=s,e.events=b,e.initEvent=l,e.initPhoto=r}),define("addPage",["event"],function(t,e,a){function o(){}function i(){$("#addPageBox").unbind("click").on("click",".j-save",function(){var t=$("#addPageBox #popAddPageNum").val();null==t?t=2:(t=parseInt(t))%2==1&&(t+=1);var a=$('#addPageBox input[name="pagePosition"]:checked').val();opEvent.eAddPage.trigger(e,{addPageNum:t,addPostion:a}),SureUtil.closeDialog("popAddPage")}).on("click",".j-cancel",function(){SureUtil.closeDialog("popAddPage")})}function n(){}function r(){}function s(){opEvent.ePopAddPage.register(function(t){art.dialog({id:"popAddPage",title:"添加页面",lock:!0,padding:0,fixed:!0,content:document.querySelector("#addPageBox")})})}var l=t("event"),d={ePopAddPage:new l,eAddPage:new l};e.init=o,e.bind=i,e.load=r,e.reload=n,e.events=d,e.initEvent=s}),define("upload",["event","uploader","ImageRes"],function(t,e,a){function o(t){var e=null;return void 0!=window.createObjectURL?e=window.createObjectURL(t):void 0!=window.URL?e=window.URL.createObjectURL(t):void 0!=window.webkitURL&&(e=window.webkitURL.createObjectURL(t)),e}function i(t){t=o(t);var e='<li class="waitUp">';return e+='<a href="javascript:;">',e+='\t<img src="'+t+'" class="cm_cp">',e+="</a>",e+='<div class="load_per uploading">上传<span>0%</span></div>',e+="</li>"}function n(t,e){e=e||o(t.getNative());var a="<li  id="+t.id+">";return a+="\t<a class='preview' href='javascript:;'><img src='"+e+"'></a>",a+='<div class="load_per uploading">等待中</div>',a+="</li>"}function r(t){var e=t.ir;return void 0==e&&(e=t),'<li ilId="'+e.checksum+'"><a class="selected" href="javascript:;"><img src="'+e.src+'?imageView2/1/w/125/h/125/format/jpg" class="cm_cp"><span class="ybiconfont ybicon-ok"></span></a></li>'}function s(t){var e=r(t);$("#imageLink_upload_container .new_up .photo_list").prepend(e),$("#imageLink_upload_container .tips .up_num").removeClass("hidden");var a=$("#imageLink_upload_container .tips span").eq(0).text();a++,$("#imageLink_upload_container .tips span").eq(0).text(a)}function l(){b=[],x=[];var t="1";"undefined"!=typeof model&&(t=model.book.getBookId()),null==v&&SureAjax.ajax({url:"/qiniu/upToken?scope="+qiniu_book_bucket,success:function(e){v=new f({belongId:t,bucket:qiniu_book_bucket,domain:qiniu_book_domain,uptoken:e.uptoken,browse_button:"localFile_more",container:"upload",drop_element:"upload"},{FilesAdded:function(e,a){var o=a.length>12?12:a.length;$("#imageLink_upload_container .choose_img_con").removeClass("hidden"),$("#imageLink_upload_container .uploading").removeClass("hidden").removeClass("finished"),$("#imageLink_upload_container .to_upload").removeClass("hidden"),$("#imageLink_upload_container .to_upload .title .cm_fl span").text(a.length+b.length),$(".to_upload .photo_list .waitUp").remove(),$("#imageLink_upload_container .empty").addClass("hidden"),$("#imageLink_upload_container .choose_img_con .img_con").removeClass("hidden"),$("#imageLink_upload_container .complete").hide();var r=0;plupload.each(a,function(t){if(r++>11)return b.push(t.getNative()),e.removeFile(t),!0;t.name=t.name.replace(/\s+/g,""),t.name.length>50&&(t.name=t.name.substr(0,50));var a=n(t);$(".to_upload .photo_list").append(a)}),r=0,setTimeout(function(){plupload.each(a,function(a){if(r++>11)return!1;setTimeout(function(){w(a.getNative(),t,function(t){var n=t.ir;void 0==n&&(n=t),e.removeFile(a),$("#"+a.id).remove();var r=$("#imageLink_upload_container .to_upload .title .cm_fl span").text();if($("#imageLink_upload_container .to_upload .title .cm_fl span").text(r-1),b.length>0){var l=b.shift();x.push(l);var d=i(l);$(".to_upload .photo_list").append(d)}o--,$(".new_up li[ilId="+n.checksum+"]").length>0?SureMsg.msg("已经存在一张同样的图片了 "):s(t),0==o&&e.start()},function(t){a.md5=t,0==--o&&e.start()})},100)})},500)},UploadProgress:function(t,e){var a=125*(1-parseFloat(e.percent)/100);$("#"+e.id).find(".load_per").html("上传<span>"+e.percent+"%</span>"),$("#"+e.id).find(".load_per").height(a)},FileUploaded:function(t,e,a){var o=null;b.length>0&&(o=b.shift(),x.push(o));var n=$.parseJSON(a),r=$("#"+e.id).find("img")[0],l=$("#imageLink_upload_container .to_upload .title .cm_fl span").text();$("#imageLink_upload_container .to_upload .title .cm_fl span").text(l-1);var d={};if(EXIF.getData(r,function(){d=EXIF.getAllTags(this)}),$("#"+e.id).remove(),null!=o){var c=i(o);$(".to_upload .photo_list").append(c)}var g=m.createIRFromQiniu(t,e,n,d)
;!!S&&S(g,function(t){s(t)})},UploadComplete:function(t){x.length>0?(t.addFile(x),x=[]):($("#imageLink_upload_container .uploading").addClass("finished"),$("#imageLink_upload_container .to_upload").addClass("hidden"),$("#imageLink_upload_container .complete").show(),!!y&&y())}})}})}function d(){$("#imageLink_upload_container").unbind("click").on("click",".finish",function(){SureUtil.closeDialog("imageLinkUpload")}).on("click",".empty a.btn",function(){$("#imageLink_upload_container input[type=file]").trigger("click")}),$.os.mobile&&$("#imageLink_upload_container #localFile_more").unbind("click").on("click",function(){$("#imageLink_upload_container input[type=file]").trigger("click")})}function c(t){S=t.onUpload,y=t.onClose,w=t.check;var e=t.finishBtnName;e&&$(".finishBtnName").text(e),art.dialog({id:"imageLinkUpload",title:"上传图片",lock:!0,content:document.getElementById("imageLink_upload_container"),close:function(){null!=v&&(v.stopUpload(),v.qiniuUploader.destroy(),v=null),!!y&&y()},init:function(){$("#imageLink_upload_container .choose_img_con").addClass("hidden"),$("#imageLink_upload_container .empty").removeClass("hidden"),$("#imageLink_upload_container .tips .up_num span").text(0),$("#imageLink_upload_container .tips .up_num").addClass("hidden"),$("#imageLink_upload_container .uploading .photo_list").empty(),$("#imageLink_upload_container .to_upload .photo_list").empty(),l()}})}function g(){}function h(){}function p(){k.ePopUpload.register(function(t){c(t)})}var u=t("event"),f=t("uploader"),m=t("ImageRes"),v=null,b=[],x=[],S=function(){},y=function(){},w=function(){return!1},k={ePopUpload:new u};e.init=l,e.bind=d,e.load=h,e.reload=g,e.events=k,e.initEvent=p,e.popUploadDialog=c}),define("toptool",["event"],function(t,e,a){function o(t){i(t.name,model.book.computeCompletedPercent())}function i(t,e){$("#top-book-info .book_name").text("《"+t+"》"),$("#top-book-info .percent > span").text(100*e.toFixed(2)+"%")}function n(){$("#showBookInfo").click(function(){art.dialog({id:"editBookInfo",title:"作品基本信息",lock:!0,fixed:!0,content:document.querySelector("#tplInfoBox"),init:function(){var t=model.book.getBookInfo();$('#tplInfoBox .j-bookinfo[data-type="name"]').val(t.name),$('#tplInfoBox .j-bookinfo[data-type="width"]').val(t.width),$('#tplInfoBox .j-bookinfo[data-type="height"]').val(t.height)}})}),$("#tplInfoBox").unbind("click").on("click",".j-save",function(){var t={};$("#tplInfoBox .j-bookinfo").each(function(){var e=$(this).attr("data-type"),a=$(this).val();t[e]=a}),void 0!=t.width&&t.width!=model.book.getBookInfo().width||void 0!=t.height&&t.height!=model.book.getBookInfo().height?SureMsg.confirm("修改了书册的尺寸，将会影响整个所有书页，确定修改？",function(){opEvent.eChangeBookInfo.trigger(e,{book:t,refresh:!0}),SureUtil.closeDialog("editBookInfo")},function(){}):(opEvent.eChangeBookInfo.trigger(e,{book:t,refresh:!1}),SureUtil.closeDialog("editBookInfo"))}).on("click",".j-cancel",function(){SureUtil.closeDialog("editBookInfo")}),h.unbind("click").on("click",".top-tool-btn",function(t){t.stopPropagation();var a=$(this).attr("data-operation");switch(a){case"btn-undo":opEvent.ePageUndo.trigger(e,{pageSeq:view.edit.getActivePageSeq(),operation:a});break;case"btn-redo":opEvent.ePageRedo.trigger(e,{pageSeq:view.edit.getActivePageSeq(),operation:a});break;case"btn-imageslot":opEvent.eNewImageSlotInsert.trigger(e,{operation:a});break;case"btn-textslot":opEvent.eMewTextSlotInsert.trigger(e,{operation:a});break;case"btn-shapeslot":opEvent.eNewShapeSlotInsert.trigger(e,{operation:a});break;case"btn-auto":opEvent.eBookAutoComplete.trigger(e,{operation:a});break;case"btn-check":opEvent.eBookCheck.trigger(e,{operation:a});break;case"btn-save":opEvent.eBookSaving.trigger(e,{operation:a})}}),$(".edit_toolbar").unbind("click").on("click",".top-tool-btn",function(){var t=$(this).attr("data-operation");if("btn-preview"==t){var a=$("body").attr("data-mode"),o="preview-book";a==o&&(o="edit-book"),opEvent.eModeChange.trigger(e,{from:a,to:o})}"btn-publish"==t&&SureMsg.confirm("确定发布书册？点击确定之后会批量处理缩略图。",function(){SureMsg.showLoadBar("生成缩略图中..."),opEvent.eBookPublish.trigger(e,{isCreateThumb:!0,onSuccess:function(){SureMsg.hideLoadBar()}})},function(){})})}function r(t){h.find('.top-tool-btn[data-operation="'+t+'"]').attr("disabled",!1)}function s(t){h.find('.top-tool-btn[data-operation="'+t+'"]').attr("disabled",!0)}function l(t){h.find('.top-tool-btn[data-operation="'+t+'"]').addClass("active")}function d(t){h.find('.top-tool-btn[data-operation="'+t+'"]').removeClass("active")}function c(){opEvent.eChangeBookInfo.register(function(t){var e=t.book;void 0!=e.name&&$("#top-book-info .book_name").text("《"+e.name+"》")})}var g=t("event"),h=$("#top-tool-container"),p={eBookAutoComplete:new g,eSavePageRes:new g,ePageUndo:new g,ePageRedo:new g,eBookSaving:new g,eBookCheck:new g,eBookPublish:new g};e.init=o,e.bind=n,e.events=p,e.initEvent=c,e.enable=r,e.disable=s,e.active=l,e.inactive=d}),define("pagesort",["draggable","transform","event","pageUtil"],function(t,e,a){function o(t,e,a){u.removeData("sortedPages"),p.initPageList(f,t,e,a,function(){}),f.maskLoading({time:2e3,bgColor:"#EEEEEE",load:function(){f.children(".page_item").addClass("no-transition"),i(),f.children(".page_item").removeClass("no-transition"),d||($(window).on("resize",function(t){"pagesort"===$("body").attr("data-mode")&&i()}),d=new c(f,".page_item.sortable",0,0,!1),d.dragStart.register(function(t){var e=$(t.currentTarget),a=g.getCurrent(e);e.addClass("no-transition ignore-array"),e.data("dragStartXY",{x:a.translationX,y:a.translationY-f.parent().scrollTop()}).data("dragStartRect",e[0].getBoundingClientRect()).data("outerHeight",e.outerHeight(!0)),g.scale(e,1.2)}),d.drag.register(function(t){t.event.type.indexOf("touch")>-1&&t.event.preventDefault();var e=$(t.currentTarget),o=e.data("dragStartXY");g.translate(e,o.x+t.deltaX,o.y+f.parent().scrollTop()+t.deltaY),e.data("delayClockToken")&&(clearTimeout(e.data("delayClockToken")),e.removeData("delayClockToken")),e.data("delayClockToken",setTimeout(function(){var n=e.data("dragStartRect"),r=e.data("outerHeight"),s=e.data("lastPageX"),l=f.children(".page_item.sortable"),d=u.data("sortedPages");if("single"!=a)d=l.sort(function(a,o){var i=g.getCurrent(a),l=g.getCurrent(o);return $(a).is(e)&&(t.pageX>=s?i.translationX+=n.width/2:i.translationX-=n.width/2),$(o).is(e)&&(t.pageX>=s?l.translationX+=n.width/2:l.translationX-=n.width/2),i.translationX+1e6*Math.round(i.translationY/r)-(l.translationX+1e6*Math.round(l.translationY/r))});else{!d&&(d=l);var c=[];$.each(d,function(t){c.push(d[t]),"cross"==$(this).data("type")&&c.push("cross")}),d=c;var h,p=$.inArray(e[0],d),m=-1;if(d=function(){var t,a,o=g.getCurrent(e),i={x:o.translationX+e.width()/2,y:o.translationY+35};return $.each(d,function(o){if("cross"==this)return!0;var n="cross"==$(this).data("type")?2:1;t=g.getCurrent(this),a={x:t.translationX+$(this).width()/2,y:t.translationY+35},Math.abs(i.x-a.x)<70*n&&Math.abs(i.y-a.y)<45&&e[0]!==this&&(m=o)}),d}(),m>=0){(function(){for(var t=Math.min(p,m);t<=Math.max(p,m);t++)if("cross"!=d[t]&&"cross"==$(d[t]).data("type"))return!0;return!1})()?(h=d.splice(p%2==1&&"cross"!=e.data("type")?p-1:p,2),d.splice(m%2==1?m-1:m,0,h[0],h[1])):(d.splice(p,1),d.splice(m,0,e[0]))}$.each(d,function(){var t=$.inArray("cross",d);if(-1==t)return!1;d.splice(t,1)}),$.each(d,function(){if($(this).data("page-seq")%2==1&&"cross"==$(this).data("type"))return void console.log("数据错误")})}u.data("sortedPages",d),d=$.makeArray(f.children(".page_item.sortable:first").prevAll()).reverse().concat($.makeArray(d)).concat($.makeArray(f.children(".page_item.sortable:last").nextAll())),i(d),g.translate(e,o.x+t.deltaX,o.y+f.parent().scrollTop()+t.deltaY),e.data("lastPageX",t.pageX)},50))}),d.dragEnd.register(function(t){setTimeout(function(){var e=$(t.currentTarget),a=e.data("dragStartXY");g.translate(e,a.x+t.deltaX,a.y+f.parent().scrollTop()+t.deltaY),setTimeout(function(){e.removeClass("no-transition ignore-array");var t=e.data("xy");g.translate(e,t.x,t.y),g.scale(e,1)},100)},100)}))}})}function i(t){t=t||f.children("li"),t=$(t);var e,a,o=0,i=0;t.each(function(t,n){n=$(n),e=n.outerWidth(!0),a=n.outerHeight(!0),o+e>u.width()&&(i+=a,o=0),n.css({left:0,top:0}).data("xy",{x:o,y:i}),n.hasClass("ignore-array")||g.translate(n,o,i),o+=e}),f.css("height",i+a)}function n(t){o(t)}function r(){u.unbind("click").on("click",".page-sort-type",function(){var t=$(this).attr("data-type");$(".page-sort-type").attr("data-select",!1),$(this).attr("data-select",!0),o(model.book.getBookInfo(),model.photo.getPhotos(),t)}).on("click",".page-sort-save",function(){opEvent.eModeChange.trigger(e,{from:"sort-page",to:"edit-book",args:{save:!0}})}).on("click",".page-sort-cancel",function(){opEvent.eModeChange.trigger(e,{from:"sort-page",to:"edit-book"})})}function s(){return $('#page-sort .page-sort-type[data-select="true"]').attr("data-type")}function l(){var t={},a=u.data("sortedPages");if(a){if("single"==s())for(var o=0,i=0;o<a.length;o++,i++){var n=$(a[o]),r=n.attr("data-page-seq").split(",")[0];t[parseFloat(r)]=i,"cross"==n.attr("data-type")&&(i++,t[parseFloat(r)+1]=i)}else for(var o=0,i=0;o<a.length;o++,i+=2){var n=$(a[o]),r=n.attr("data-page-seq").split(",")[0];t[parseFloat(r)]=i,t[parseFloat(r)+1]=i+1}opEvent.ePagesSort.trigger(e,{sortData:t}),u.removeData("sortedPages")}}var d,c=t("draggable"),g=t("transform"),h=t("event"),p=t("pageUtil"),u=$("#page-sort"),f=$("#page-sort-preview");e.init=n,e.bind=r,e.events={ePagesSort:new h},e.initPageSort=function(){$('#page-sort .page-sort-type[data-type="double"]').trigger("click")},e.save=l}),define("pagelist",["pageUtil","event"],function(t,e,a){function o(t){var e=model.photo.getPhotos(),a=!1;p.initPageList(f,t,e,"double",function(){a=!0,g()}),f.maskLoading({time:2e3,load:function(){SureMsg.hideLoadBar(),f.find(".page_item:first").trigger("click"),i()||editPageGuide()}})}function i(){if("edit-book"==$("body").attr("data-mode"))return 1==SureDB.get("editGuideShow");return!0}function n(){$("#footerPageList").unbind("click").on("click",".page_control_header .act_btn",function(){var t=$(this).attr("data-type");if(!$(this).hasClass("selected")){$(".page_control_header .act_btn").removeClass("selected"),$(this).addClass("selected");var a=$("body").attr("data-mode");opEvent.eModeChange.trigger(e,{from:a,to:t})}}).on("click",".page_control .page_num",function(){$(this).closest(".page_control").toggleClass("active")}).on("click",".page_control #page-list-select > li",function(){s($(this).attr("data-page-seq").split(",")[0]),$("#footerPageList .page_control").removeClass("active")}).on("click",".page_item",function(t){var a,o=$(this),i=o.attr("data-page-seq").split(",");a=$(t.target).hasClass("page_thumbnail")?$(t.target).attr("data-page-seq"):i[0],c()&&opEvent.eBookSaving.trigger(e,{});var n=$("body").data("refresh");1==n&&$("body").data("refresh",!1),opEvent.ePageListItemSelected.trigger(e,{currentPageSeqs:view.edit.getCurrentPageSeqs(),pageSeqs:i,selectedPageSeq:a,force:1==n?"force":""})}).on("click",".j-page-controller-pagination",function(t){t.stopPropagation(),t.preventDefault(),s($(this).attr("data-value"))}).on("click","#addEmptyPage",function(t){opEvent.ePopAddPage.trigger(e,{})}).on("click","#subDeletePages",function(t){var a=view.edit.getActivePageSeq();if(!SureUtil.isInteger(a))return void SureMsg.error("当前页面不支持删除。");SureMsg.confirm("确定删除当前编辑页面吗？",function(){opEvent.eDeletePages.trigger(e,{pageSeqs:view.edit.getCurrentPageSeqs()})})})}function r(t,a,o,i){"function"==typeof o&&(i=o),setTimeout(function(){var n=o||d().attr("data-page-seq");p.initPageList(f,t,a,"double",function(){"function"==typeof i&&i.call(e)});var r=0;f.children("li").each(function(t,e){r+=$(e).outerWidth(!0)}),f.css("width",r+6).scrollLeft(0);var s=f.find('.page_thumbnail[data-page-seq="'+n+'"]');0===s.length&&(s=f.find(".page_thumbnail:first")),s.trigger("click")},100)}function s(t){if("next"==t){var e=f.children('.page_item[aria-selected="true"]').next();e.length>0&&e.trigger("click")}else if("prev"==t){var a=f.children('.page_item[aria-selected="true"]').prev();a.length>0&&a.trigger("click")}else f.find('.page_thumbnail[data-page-seq="'+t+'"]').trigger("click")}function l(t){f.find(".page_thumbnail").attr("aria-selected",!1).filter("[data-page-seq="+t+"]").attr("aria-selected",!0).parents(".page_item").attr("aria-selected",!0).siblings(".page_item").attr("aria-selected",!1);var e=f.children('.page_item[aria-selected="true"]');$("#footerPageList .page_num").find("span").text(e.attr("data-text"));var a=e[0].getBoundingClientRect(),o=f.parent()[0].getBoundingClientRect();a.left<o.left?f.stop(!0,!0).animate({scrollLeft:"-="+(o.left-a.left+a.width)}):a.right>o.right&&f.stop(!0,!0).animate({scrollLeft:"+="+(a.right-o.right+a.width)})}function d(){return f.find('.page_thumbnail[aria-selected="true"]')}function c(){for(var t in window.changed)return!0;return!1}function g(){var t="";f.find("li").each(function(){var e=$(this).attr("data-text"),a=$(this).attr("data-page-seq");t+='<li data-page-seq="'+a+'">'+e+"</li>"}),m.empty().append(t)}function h(){opEvent.eSetPageActive.register(function(t){l(t.pageSeq)}),opEvent.eDrawPageThumbnail.register(function(t){var e=t.pageInfo,a=t.photos,o=t.callback,i=t.reDrawCurrentPages;p.drawPageThumbnail(f,e,a,o),i&&$('#section_book_edit > .page[data-seq="'+e.seq+'"]').length&&view.edit.initPageSlot(e,a)}),opEvent.eRefreshAll.register(function(t){var e=t.book,a=t.photos,o=t.selectPageSeq;$("body").data("refresh",!0),r(e,a,o,function(){g()})})}var p=t("pageUtil"),u=t("event"),f=$("#page-list-preview"),m=$("#page-list-select"),v={eSetPageActive:new u,ePageListItemSelected:new u,eRefreshPage:new u,eDeletePages:new u,eRefreshAll:new u};e.init=o,e.bind=n,e.events=v,e.initEvent=h,e.refresh=r,e.goto=s,e.setPageSelected=l,e.getPageSelected=d}),define("edit",["size-converter","selection-handles","transform","draggable","zoombar","slot","imgload","event"],function(t,e,a){function o(){bt.data("rect",bt[0].getBoundingClientRect()),i(),n(),r(),v()}function i(){st=new ht(St),st.change.register(function(t){var e=ct.getCurrent(xt);u(t.scale);var a=m(),o=xt.width()*(a-e.scale),i=xt.height()*(a-e.scale),n=bt.offset(),r=xt.outerWidth(),s=xt.outerHeight(),l=e.translationX-o*($(window).width()/2-n.left-e.translationX)/r/e.scale,d=e.translationY-i*($(window).height()/2-n.top-e.translationY)/s/e.scale,c=f(l,d);ct.translate(xt,c.x,c.y),xt.children(".page").children(".slot").each(function(t,e){var a=$(e).data("selectionHandles");a&&a.isOn&&a.resetPosition()})})}function n(){var t=new gt(xt,null,10);t.dragStart.register(function(t){var e=$(t.currentTarget);if("preview"!==$("body").attr("data-mode")&&($(t.target).is("[aria-selected=true], [aria-selected=true] *, .photo_change")||"true"===xt.attr("data-locked"))||xt.hasClass("scaling")||$("body").hasClass("dragging-photo"))return void t.prevent();var a=ct.getCurrent(e);e.data({dragStartXY:{x:a.translationX,y:a.translationY},click:!1})}),t.drag.register(function(t){var e=$(t.currentTarget),a=e.data("dragStartXY"),o=a.x+t.deltaX,i=a.y+t.deltaY,n=f(o,i);if(ct.translate(e,n.x,n.y),$(t.target).is(".transformable-box,.transformable-box *")){var r;r=$(t.target).hasClass("transformable-box")?$(t.target).data("selectionHandles"):$(t.target).parents(".transformable-box").data("selectionHandles"),r.resetPosition()}}),t.dragEnd.register(function(t){$(t.currentTarget).removeData("dragStartXY")})}function r(){var t=new gt(xt,pt.getAllSlotClass());t.dragStart.register(function(t){var e=$(t.currentTarget);if(e.is('[aria-selected!="true"]'))return void t.prevent();if(e.data("click",!1),e.is(".imageslot.editing")){var a=pt.getAttr(e);e.children(".content").children("img").data("dragStartXY",{x:a.image.x,y:a.image.y})}else{if("true"===e.attr("data-locked"))return SureMsg.info("请先解锁元素"),void t.prevent();var o=ct.getCurrent(e);e.data("dragStartXY",{x:o.translationX,y:o.translationY}),e.data("selectionHandles").hide(),bt.data("rect",bt[0].getBoundingClientRect())}X(e.parent())}),t.drag.register(function(t){var e,a,o,i=$(t.currentTarget),n=m();if(i.hasClass("imageslot")&&i.hasClass("editing")){e=i.children(".content").children("img").data("dragStartXY");var r=pt.getAttr(i),s=t.pageX-t.startPoint.x,l=t.startPoint.y-t.pageY,d=Math.sqrt(s*s+l*l),c=Math.acos(l/d);t.pageX<t.startPoint.x&&(c=-c);var g=c-r.rotation*Math.PI/180;a=e.x+d*Math.sin(g)/n,o=e.y+d*-Math.cos(g)/n,pt.setAttr(i,{image:{x:a,y:o}}),pt.image.preventImgOutSlot(i),i.data("backImgWrapper").css("transform",ct.getCurrentTransform(i.children(".content").children("img")))}else{e=i.data("dragStartXY"),a=e.x+t.deltaX/n,o=e.y+t.deltaY/n,L(i,a,o),R(i,"move");var h=i[0].getBoundingClientRect(),p=i.siblings(".locator"),u=p.data("rect");u||p.data("rect",u=p[0].getBoundingClientRect());var n=m();_(t.pageX,t.pageY,"Ｘ："+mt.pxToMm((h.left-u.left)/n).toFixed(1)+"mm\r\nＹ："+mt.pxToMm((h.top-u.top)/n).toFixed(1)+"mm")}}),t.dragEnd.register(function(t){var a=$(t.currentTarget),o=pt.getAttr(a),i={};if(pt.isImageSlot(a)&&a.hasClass("editing")){a.children(".content").children(".img");i={image:{x:mt.pxToMm(o.image.x),y:mt.pxToMm(o.image.y)}}}else i={x:mt.pxToMm(o.x),y:mt.pxToMm(o.y)};a.data("selectionHandles").resetPosition(),a.data("selectionHandles").show(),opEvent.eSlotChanged.trigger(e,{el:a,pageSeq:a.parent().attr("data-seq"),name:a.attr("data-name"),obj:i}),U(),q()})}function s(){$(window).on("resize",function(t){$(document).triggerHandler("pointerdown.hide"),v()}),xt.unbind("pointerdown").on("pointerdown",function(t){"mousedown"===t.originalType&&t.preventDefault(),$(t.currentTarget).data("click",!0)}),l(),h(),p(),c(),d()}function l(){var t=[[{text:"粘贴",func:function(){opEvent.ePasteSlots.trigger(e,{destPageSeq:K().attr("data-seq")})}}]];xt.smartMenu(t,{name:"bookEditEmptyMenu",beforeShow:function(){},afterShow:function(){}})}function d(){$("#text-slot-input-container").on("click",".j-save-text",function(t){if(!pt.text.saveAndCloseTextInputDialog()){var e=$("#text-slot-input-container").data("el");$(document).scrollTop(0).triggerHandler("pointerdown.closeTextboxEditingMode"),D(e)}}).on("keydown",function(t){if(t.ctrlKey&&13===t.which){if(pt.text.saveAndCloseTextInputDialog())return;$(document).triggerHandler("pointerdown.closeTextboxEditingMode"),D($("#text-slot-input-container").data("el"))}})}function c(){$("body").on("click",".select_item, .select_color_item, .j-select_color_item",function(t){var a=$(this).closest("[data-type]").attr("data-type"),o=$(this).attr("data-value"),i=$(this).closest(".set_property_box").attr("id"),n=$("body").data("opEl"),r=$("#"+i).data("sender");if(null!=r&&(a=r.attr("data-type"),r.is(".j-pageinfo")))return void opEvent.eChangePageInfo.trigger(e,{seq:tt(),type:a,value:o,btnId:i});null!=n&&opEvent.eSlotBtnOpEvent.trigger(e,{el:n,type:a,value:o,btnId:i}),$(document).triggerHandler("pointerdown.hideSubBtn#"+i)}).on("click","#showDetailColors",function(t){$("#detailColorsBox").toggleClass("active")}).on("change","#color_value_input",function(t){var a=$(this).val();if(/^[A-Fa-f0-9]{6}$/.test(a)){var o=$(this).closest("[data-type]").attr("data-type"),i=$(this).closest(".set_property_box").attr("id"),n=$("body").data("opEl"),r=$("#"+i).data("sender");null!=r&&(o=r.attr("data-type"),r.is(".j-pageinfo")&&opEvent.eChangePageInfo.trigger(e,{seq:tt(),type:o,value:"#"+a,btnId:i})),null!=n&&opEvent.eSlotBtnOpEvent.trigger(e,{el:n,type:o,value:"#"+a,btnId:i}),$(this).val(""),$(document).triggerHandler("pointerdown.hideSubBtn#"+i)}else SureMsg.error("输入有误")})}function g(){return"edit-book"==$("body").attr("data-mode")}function h(){bt.on("click",".page_nav",function(t){t.preventDefault(),view.pagelist.goto($(this).attr("data-value"))}).on("click",pt.getAllSlotClass(),function(t){t.preventDefault();var a=t.originalEvent.ctrlKey||t.originalEvent.metaKey;if(g()){var o=$(t.currentTarget);!1!==o.data("click")&&!1!==xt.data("click")&&("true"!==o.attr("aria-selected")?D(o,a):o.hasClass("editing")?pt.isImageSlot(o)?($(document).triggerHandler("pointerdown.closeImgboxEditingMode"),D(o,a)):pt.isTextSlot(o)&&($(document).triggerHandler("pointerdown.closeTextboxEditingMode"),D(o,a)):pt.isImageSlot(o)?pt.image.setImgSlotModeToEditing(o):pt.isTextSlot(o)&&pt.text.setTextSlotModeToEditing(o,function(t,a){var o=t.parent().attr("data-seq");if("front-flap"==o||"spine"==o)pt.setAttr(t,{content:a,doNotAutoSetTextboxHeight:!0}),opEvent.eTextSlotChanged.trigger(e,{pageSeq:t.parent().attr("data-seq"),name:t.attr("data-name"),obj:{content:a}});else{pt.setAttr(t,{content:a});var i=mt.pxToMm(pt.text.getTextSlotTextHeight(t));opEvent.eTextSlotChanged.trigger(e,{pageSeq:t.parent().attr("data-seq"),name:t.attr("data-name"),obj:{content:a,height:i}})}}))}}).on("pointerdown",pt.getAllSlotClass(),function(t){"mousedown"===t.originalType&&t.preventDefault(),$(t.currentTarget).data("click",!0)}).on("pointerdown",".page",function(t){"mousedown"===t.originalType&&t.preventDefault();var a=$(this),o=a.attr("data-seq");opEvent.ePageListItemSelected.trigger(e,{currentPageSeqs:b(),pageSeqs:b(),selectedPageSeq:o})}).on("click",".edit_box_tool .edit_btn",function(t){t.preventDefault(),Y();var a=$(this).attr("data-sub-template");if(void 0!=a){var o=$(this),i=$("#"+a),n=o[0].getBoundingClientRect();if(i.data("sender",o),"none"!==i.css("display"))return void $(document).triggerHandler("pointerdown.hideSubBtn#"+a);if(i.css({display:"block",visibility:"hidden",animation:"none"}),i.offset({left:n.left+1,top:n.bottom+7+$(window).scrollTop()+i.outerHeight(!0)>$(window).height()?$(window).height()-i.outerHeight(!0)-3:n.bottom+$(window).scrollTop()+7}),0!==i.find(".select_list_box").length){var r=n.width-2;r<60&&(r=60,i.offset({left:n.left-12})),i.css({width:r})}else i.is(".set_opacity_box")&&i.offset({left:n.left-50});i.offAnimationEnd().oneAnimationEnd(function(){$(document).on("pointerdown.hide.hideSubBtn#"+a,function(t){$(t.target).is(o.add(o.find("*")).add(i).add(i.find("*")))||(i.css({display:"none"}),i.removeData("sender"),$(document).off(".hideSubBtn#"+a))})}).css({visibility:"visible",animation:"jump-in 0.1s"})}else{var s=$("body").data("opEl"),l={};l.type=$(this).attr("data-type"),l.value=$(this).attr("data-value"),l.el=s,l.sender=$(this),opEvent.eSlotBtnOpEvent.trigger(e,l)}})}function p(){key("del",function(){if(g()){var t=G();0!=t.length&&(pt.isImageSlot(t)&&!pt.isEmpty(t)?j(t):opEvent.eSlotDelete.trigger(e,{el:G(),name:G().attr("data-name"),pageSeq:K().attr("data-seq")}))}return!1}),key("ctrl+z",function(){return!!g()&&(opEvent.ePageUndo.trigger(e,{pageSeq:K().attr("data-seq")}),!1)}),key("ctrl+y",function(){return!!g()&&(opEvent.ePageRedo.trigger(e,{pageSeq:K().attr("data-seq")}),!1)}),key("ctrl+s",function(){return!!g()&&(opEvent.eBookSaving.trigger(e,{refresh:!1}),!1)}),key("ctrl+0",function(){return!!g()&&(v(),!1)}),key("ctrl+c",function(){if(!g())return!1;var t=Z();return opEvent.eCopySlots.trigger(e,{slots:t}),!1}),key("ctrl+v",function(){return!!g()&&(opEvent.ePasteSlots.trigger(e,{destPageSeq:K().attr("data-seq")}),!1)}),key("ctrl+x",function(){if(!g())return!1;var t=Z();return opEvent.eCutSlots.trigger(e,{slots:t}),!1}),key("up, down, left, right",function(t,a){var o=G();if(0==o.length)"right"==a.key?view.pagelist.goto("next"):"left"==a.key&&view.pagelist.goto("prev");else{if(!g())return!1;for(var i=0;i<o.length;i++)!function(){var t=i;if(o.eq(t).length&&!o.eq(t).hasClass("editing"))if("true"!==o.eq(t).attr("data-locked")){var n=pt.getAttr(o.eq(t));switch(a.key){case"left":n.x-=1;break;case"up":n.y-=1;break;case"right":n.x+=1;break;case"down":n.y+=1}L(o.eq(t),n.x,n.y),o.eq(t).data("selectionHandles").hide();var r=o.eq(t).data("moveEndClockToken");r&&clearTimeout(r),o.eq(t).data("moveEndClockToken",setTimeout(function(){"true"!==o.eq(t).attr("aria-selected")||o.eq(t).hasClass("editing")||o.eq(t).data("selectionHandles").show(),o.eq(t).data("moveEndClockToken",null);var a=pt.getAttr(o.eq(t));opEvent.eSlotChanged.trigger(e,{pageSeq:o.eq(t).parent().attr("data-seq"),name:o.eq(t).attr("data-name"),el:o.eq(t),obj:{x:mt.pxToMm(a.x),y:mt.pxToMm(a.y)}})},600))}else SureMsg.error("槽位已经锁定")}()}return!1})}function u(t){var e=ct.getCurrent(xt);ct.scale(xt,t);var a=xt.width()*(t-e.scale),o=xt.height()*(t-e.scale),i=e.translationX-a/2,n=e.translationY-o/2,r=f(i,n);ct.translate(xt,r.x,r.y),xt.attr("data-locked",!1)}function f(t,e){return t>bt.width()-100?t=bt.width()-100:t+xt.outerWidth()*m()<100&&(t=100-xt.outerWidth()*m()),e>bt.height()-100?e=bt.height()-100:e+xt.outerHeight()*m()<100&&(e=100-xt.outerHeight()*m()),{x:t,y:e}}function m(){return parseFloat(xt.attr("data-scale"))}function v(){var t=parseFloat(xt.css("width")),e=parseFloat(xt.css("height")),a=bt.width(),o=bt.height(),i=Math.min((a-250)/t,(o-250)/e);"create-tpl"==vt.attr("data-type")&&(i=Math.min((a-220)/t,(o-160)/e)),ct.scale(xt,i),st.setCursorPosition(i),ct.translate(xt,(a-t*i)/2,(o-e*i)/2),xt.attr("data-locked",!0);var n=G();if(0!=n.length){var r=n.data("selectionHandles");r.isOn&&r.resetPosition()}}function b(){var t=[];return xt.children(".page").each(function(e,a){t.push($(a).attr("data-seq"))}),t}function x(t,e){var a=e.seq,o=e.backgroundColor;void 0!==a&&t.attr("data-seq",a),void 0!==o&&t.attr("data-backgroundColor",o).css("background-color",o)}function S(t,a){var o=xt.children(".page[data-seq="+t.seq+"]");if(0==o.length)throw new Error("编辑页不可为空");o.attr("data-name",t.name),x(o,{backgroundColor:t.backgroundColor}),$(document).triggerHandler("pointerdown.hide"),o.children(pt.getAllSlotClass()).remove();var i=0;for(i=0;i<t.imageSlotList.length;i++){var n,r=t.imageSlotList[i];t.imageSlotList[i].image&&(n=a[t.imageSlotList[i].image.id]);var s=pt.create(pt.getImageSlotName(),r,n);w(s),y(s,t.seq),o.append(s),opEvent.eImageSlotRendered.trigger(e,{pageSeq:s.parent().attr("data-seq"),name:s.attr("data-name")})}for(i=0;i<t.textSlotList.length;i++){var l=t.textSlotList[i],d=pt.create(pt.getTextSlotName(),l);w(d),y(d,t.seq),o.append(d)}if(null!=t.decorationSlotList)for(i=0;i<t.decorationSlotList.length;i++){var c=t.decorationSlotList[i],g=pt.create(pt.getDecorationSlotName(),c);"spine"===t.seq&&pt.setAttr(g,{x:mt.mmToPx(c.x),y:mt.mmToPx(c.y)}),w(g),y(g,t.seq),o.append(g)}if(null!=t.shadingSlotList)for(i=0;i<t.shadingSlotList.length;i++){var h=pt.create(pt.getShadingSlotName(),t.shadingSlotList[i]);w(h),y(h,t.seq),o.append(h)}if(null!=t.shapeSlotList)for(var p=0;p<t.shapeSlotList.length;p++){var u=pt.create(pt.getShapeSlotName(),t.shapeSlotList[p]);"spine"===t.seq&&pt.setAttr(u,{x:mt.mmToPx(t.shapeSlotList[p].x),y:mt.mmToPx(t.shapeSlotList[p].y)}),w(u),y(u,t.seq),o.append(u)}}function y(t,a){var o=t.attr("data-name"),i=[{text:"复制",func:function(){var t=Z();opEvent.eCopySlots.trigger(e,{slots:t})}},{text:"删除",func:function(){var t=$(this);pt.isImageSlot(t)&&!pt.isEmpty(t)?j(t):t.is(".slot")&&opEvent.eSlotDelete.trigger(e,{el:t,name:t.attr("data-name"),pageSeq:t.attr("data-seq")})}}],n={text:"层级",data:[[{text:"置顶",func:function(){ot(this,"top")}},{text:"置底",func:function(){ot(this,"bottom")}},{text:"上移",func:function(){ot(this,"op")}},{text:"下移",func:function(){ot(this,"down")}}]]},r={text:"操作",data:[[{text:"自适应",func:function(){opEvent.eSlotBtnOpEvent.trigger(e,{el:this,type:"adjust"})}},{text:"填充",func:function(){opEvent.eSlotBtnOpEvent.trigger(e,{el:this,type:"fill"})}},{text:"放大",func:function(){opEvent.eSlotBtnOpEvent.trigger(e,{el:this,type:"zoomin"})}},{text:"缩小",func:function(){opEvent.eSlotBtnOpEvent.trigger(e,{el:this,type:"zoomout"})}}]]},s=[i,[n]];t.smartMenu(s,{name:"slotMenu-"+a+o,beforeShow:function(){D(t,!1);var e=G();$.smartMenu.remove(),pt.isImageSlot(e)&&(pt.isEmpty(e)?s[1]=[n]:s[1]=[n,r])},afterShow:function(){}})}function w(t){var e=new dt({element:t});e.rotate.register(k),e.rotateEnd.register(T),e.resizeStart.register(P),e.resize.register(C),e.resizeEnd.register(I),t.data("selectionHandles",e)}function k(t){var e=this.getCurrentRotation();e>-1&&e<1&&t.element.css("transform",ct.getCurrentTransform(t.element)+"translate(50%,50%)rotate("+-e+"deg)translate(-50%,-50%)"),_(t.originalEvent.pageX,t.originalEvent.pageY,e.toFixed(1)+"°")}function T(t){var a=t.element;pt.setAttr(a,{rotation:t.rotation}),opEvent.eSlotChanged.trigger(e,{el:a,pageSeq:this.element.parent().attr("data-seq"),name:this.element.attr("data-name"),obj:{rotation:t.rotation}}),q()}function P(t){var e=$(t.element);if(pt.isImageSlot(e)&&!pt.isEmpty(e)){var a=pt.getAttr(e);e.data({resizeStartImgXY:{x:a.image.x,y:a.image.y},resizeStartWidth:a.width,resizeStartHeight:a.height})}X(e.parent())}function C(t){var a=$(t.element);if(A(a),R(a,t.type,this.locators[t.type.split("-")[1]+t.type.split("-")[2][0].toUpperCase()+t.type.split("-")[2].substring(1)]),pt.isImageSlot(a)&&!pt.isEmpty(a)){var o=a.data("resizeStartImgXY"),i=t.type.split("-"),n=i[1],r=i[2],s={};switch(n){case"left":s.x=o.x+(a.width()-a.data("resizeStartWidth"))}switch(r){case"top":s.y=o.y+ +(a.height()-a.data("resizeStartHeight"))}pt.setAttr(a,{image:s}),pt.image.preventImgOutSlot(a)}var l=mt.pxToMm(a.width()),d=mt.pxToMm(a.height());_(t.originalEvent.pageX,t.originalEvent.pageY,"宽："+l.toFixed(1)+"mm\r\n高："+d.toFixed(1)+"mm"),a.hasClass("imageslot")&&opEvent.eImageSlotResize.trigger(e,{pageSeq:a.parent().attr("data-seq"),name:a.attr("data-name"),widthMM:l,heightMM:d}),E(a)}function I(t){var a=$(t.element),o=pt.getAttr(a),i={},n=M(a);if(i.x=mt.pxToMm(n.x),i.y=mt.pxToMm(n.y),i.width=mt.pxToMm(o.width),i.height=mt.pxToMm(o.height),pt.isImageSlot(a)){var r=a.children(".content").children(".img");pt.setAttr(a,n),0!==r.length&&(i.image={x:mt.pxToMm(o.image.x),y:mt.pxToMm(o.image.y)}),opEvent.eSlotChanged.trigger(e,{el:a,pageSeq:a.parent().attr("data-seq"),name:a.attr("data-name"),obj:i})}else opEvent.eSlotChanged.trigger(e,{el:a,pageSeq:a.parent().attr("data-seq"),name:a.attr("data-name"),obj:i});U(),q(),E(a)}function _(t,e,a){var o=$("#slot_size_tooltip");o.html(a);var i=bt.data("rect");ct.translate(o,t-i.left+300,e-i.top+70),"none"===o.css("display")&&(o.css({display:"block",visibility:"hidden"}),o.offAnimationEnd().css({visibility:"visible",animation:"fade-in 0.1s"}))}function q(){$("#slot_size_tooltip").hide()}function E(t){var e=t.width(),a=t.height(),o=t.children(".bg_icon");o.text(""),e>=a?o.css({width:a/2,height:a/2}):o.css({width:e/2,height:e/2})}function L(t,e,a,o,i,n){t=$(t),pt.setAttr(t,{x:e,y:a,width:o,height:i,rotation:n}),A(t)}function A(t){t=$(t);var e,a=t.parent(),o=t.siblings(".locator")[0].getBoundingClientRect(),i=t[0].getBoundingClientRect(),n={x:i.left-o.left+i.width/2,y:i.top-o.top+i.height/2},r=pt.getAttr(t);return n.x<0?(e=e||M(t),e.x=-r.width/2):n.x>o.width&&(e=e||M(t),e.x=a.innerWidth()-r.width/2),n.y<0?(e=e||M(t),e.y=-r.height/2):n.y>o.height&&(e=e||M(t),e.y=a.innerHeight()-r.height/2),e&&pt.setAttr(t,{x:e.x,y:e.y}),e||{x:r.x,y:r.y}}function M(t){t=$(t);var e=function(){var e=t[0].getBoundingClientRect(),a={};return a.x=e.left+e.width/2,a.y=e.top+e.height/2,a}(),a=m(),o=function(){var e=$(document.createElement("span"));e.css({position:"absolute",top:0,left:0,height:0,width:0}),e.appendTo(t.parent());var a=e[0].getBoundingClientRect();return e.remove(),a}(),i=t.outerWidth(),n=t.outerHeight(),r={};return r.x=(e.x-i/2*a-o.left)/a,r.y=(e.y-n/2*a-o.top)/a,r}function B(t,e,a){var o=xt.children(".page[data-seq="+t+"]").children(".imageslot[data-name="+e+"]"),i=Math.floor(a.width),n=Math.floor(a.height);o.data({requireSize:{width:i,height:n}}).children(".require_size").html(i+"*"+n)}function j(t){"string"==typeof arguments[0]&&"string"==typeof arguments[1]&&(t=xt.children('.page[data-seq="'+arguments[0]+'"]').children('.imageslot[data-seq="'+arguments[1]+'"]')),t.removeAttr("data-id"),pt.setAttr(t,{image:null}),$(document).triggerHandler("pointerdown.closeImgboxEditingMode"),D(t),opEvent.eImageSlotChanged.trigger(e,{pageSeq:t.parent().attr("data-seq"),name:t.attr("data-name"),obj:{image:null}})}function z(t,e,a,o,i,n){var r=$("> .page[data-seq="+e+"] > .imageslot[data-name="+a+"]",xt)
;if(null==t||!t.src)throw new Error("photo没有可用的数据源");r.addClass("img_loading"),F(t.src,t.id,t.name,t.width,t.height,e,a,n)}function F(t,a,o,i,n,r,s,l){var d=$("> .page[data-seq="+r+"] > .imageslot[data-name="+s+"]",xt);d.children(".content").children(".img").remove(),d.removeClass("has-img").removeClass("photo_not_found"),d.addClass("img_loading").attr("data-photoid",a),ut(t,function(){$(this).attr({"data-id":a,"data-filename":o}).data({originalSize:{width:this.width,height:this.height}}).css({"transform-origin":"0 0",width:this.width,height:this.height}),$(this).addClass("img").prependTo(d.children(".content")),d.addClass("has-img").removeClass("img_loading");var i;i=this.width/this.height>d.width()/d.height()?d.height()*this.width/this.height:d.width();var n=H(d,i,!0);opEvent.eImageSlotChanged.trigger(e,{pageSeq:r,name:s,obj:{image:{id:$(this).attr("data-id"),x:mt.pxToMm(n.x),y:mt.pxToMm(n.y),width:mt.pxToMm(n.width),fileName:o,src:t,url:t,rotation:0}}}),"function"==typeof l&&l.call(e)})}function H(t,e,a){var o=t.children(".content").children(".img"),i=o.height()/o.width();o.width()>o.height()?e<50&&(e=50):e*i<50&&(e=50/i);var n=pt.getAttr(t);pt.setAttr(t,{image:{width:e}});var r,s,l=e-n.image.width,d=(e-n.image.width)*i;a?(r=(n.width-e)/2,s=(n.height-e*i)/2):(r=n.image.x-l*(n.width/2-n.image.x)/n.image.width,s=n.image.y-d*(n.height/2-n.image.y)/(n.image.width*i)),pt.setAttr(t,{image:{x:r,y:s}});var c=pt.image.preventImgOutSlot(t);return{x:c.x,y:c.y,width:e}}function W(t,e,a){var o=xt.children(".page[data-seq="+t+"]").children(".imageslot[data-name="+e+"],.textslot[data-name="+e+"],.decorationslot[data-name="+e+"],.shadingslot[data-name="+e+"],.shapeslot[data-name="+e+"]");if(0===o.length)throw new Error("没有找到slot");D(o,a,!1)}function D(t,a,o){opEvent.eSlotSelected.trigger(e,{el:t,multiple:a,notShowToolbar:!1})}function X(t){t=$(t);var e,a,o=t.children(".locator")[0].getBoundingClientRect(),i=t.data("rects",[{name:"page",left:o.left,right:o.right,top:o.top,bottom:o.bottom,centerX:o.left+o.width/2,centerY:o.top+o.height/2}]).data("rects"),n=t.children(pt.getAllSlotClass());for(e=0;e<n.length;e++)a=n[e].getBoundingClientRect(),i.push({name:$(n[e]).parent().attr("data-seq")+"."+$(n[e]).attr("data-name"),left:a.left,right:a.right,top:a.top,bottom:a.bottom,centerX:a.left+a.width/2,centerY:a.top+a.height/2})}function R(t,e,a){t=$(t),a=$(a);var o=a.length>0?a[0].getBoundingClientRect():t[0].getBoundingClientRect();o={name:t.parent().attr("data-seq")+"."+t.attr("data-name"),left:o.left,right:o.right,top:o.top,bottom:o.bottom,centerX:o.left+o.width/2,centerY:o.top+o.height/2};var i,n,r,s,l,d=t.parent(),c={x:null,y:null};for(s=d.data("rects"),i=0;i<s.length;i++)if(l=s[i],l.name!==o.name)for(n in o)for(r in l)switch(n){case"left":case"right":case"centerX":if(!["left","right","centerX"].contains(r))continue;var g=o[n]-l[r];Math.abs(g)<6&&(!c.x||Math.abs(g)<Math.abs(c.x.delta))&&(c.x={type:n,targetType:r,targetRect:l,delta:g});case"top":case"bottom":case"centerY":if(["top","bottom","centerY"].contains(r)){var g=o[n]-l[r];Math.abs(g)<6&&(!c.y||Math.abs(g)<Math.abs(c.y.delta))&&(c.y={type:n,targetType:r,targetRect:l,delta:g})}}bt.children(".align_guide_line").remove();var h,p=m(),u=pt.getAttr(t),f={};if("move"===e)c.x&&(f.x=u.x-c.x.delta/p),c.y&&(f.y=u.y-c.y.delta/p),pt.setAttr(t,f);else if("resize"===(h=e.split("-"))[0]){var v=h[1],b=h[2],x=ct.getCurrentTransform(t),S=u.rotation/180*Math.PI,y=t.width(),w=t.height();if(c.x){var k=c.x.delta/p;"left"===v&&"top"===b?(f.transform=x+="translateX("+-k*Math.cos(S)+"px)",f.transform=x+="translateY("+-k*-Math.sin(S)+"px)",f.width=y+=k*Math.cos(S),f.height=w+=k*-Math.sin(S)):"left"===v&&"center"===b?(f.transform=x+="translateX("+-k*Math.cos(S)+"px)",f.width=y+=k*Math.cos(S)):"left"===v&&"bottom"===b?(f.transform=x+="translateX("+-k*Math.cos(S)+"px)",f.width=y+=k*Math.cos(S),f.height=w+=-k*-Math.sin(S)):"right"===v&&"top"===b?(f.transform=x+="translateY("+-k*-Math.sin(S)+"px)",f.width=y+=-k*Math.cos(S),f.height=w+=k*-Math.sin(S)):"right"===v&&"center"===b?f.width=y+=-k*Math.cos(S):"right"===v&&"bottom"===b&&(f.width=y+=-k*Math.cos(S),f.height=w+=-k*-Math.sin(S))}if(c.y){var T=c.y.delta/p;"left"===v&&"top"===b?(f.transform=x+="translateX("+-T*Math.sin(S)+"px)",f.transform=x+="translateY("+-T*Math.cos(S)+"px)",f.width=y+=T*Math.sin(S),f.height=w+=T*Math.cos(S)):"center"===v&&"top"===b?(f.transform=x+="translateY("+-T*Math.cos(S)+"px)",f.height=w+=T*Math.cos(S)):"right"===v&&"top"===b?(f.transform=x+="translateY("+-T*Math.cos(S)+"px)",f.width=y+=-T*Math.sin(S),f.height=w+=T*Math.cos(S)):"left"===v&&"bottom"===b?(f.transform=x+="translateX("+-T*Math.sin(S)+"px)",f.width=y+=T*Math.sin(S),f.height=w+=-T*Math.cos(S)):"center"===v&&"bottom"===b?f.height=w+=-T*Math.cos(S):"right"===v&&"bottom"===b&&(f.width=y+=-T*Math.sin(S),f.height=w+=-T*Math.cos(S))}t.css(f)}o=t[0].getBoundingClientRect(),o={name:t.parent().attr("data-seq")+"."+t.attr("data-name"),top:o.top,bottom:o.bottom,left:o.left,right:o.right,centerX:o.left+o.width/2,centerY:o.top+o.height/2};var P,C,I,_,q=bt.data("rect"),E={x:{left:null,centerX:null,right:null},y:{top:null,centerY:null,bottom:null}};for(i=0;i<s.length;i++)if(l=s[i],l.name!==o.name)for(n in o)for(r in l)switch(n){case"left":case"right":case"centerX":if(!["left","right","centerX"].contains(r))continue;P=Math.min(l.top,o.top),C=Math.max(l.bottom,o.bottom),Math.abs(l[r]-o[n])<1*p&&(E.x[n]?P<E.x[n].top?(E.x[n].top=P,E.x[n].targetRect=l,E.x[n].targetType=r):C>E.x[n].bottom&&(E.x[n].bottom=C,E.x[n].targetRect=l,E.x[n].targetType=r):E.x[n]={value:o[n],top:P,bottom:C,targetRect:l,targetType:r});case"top":case"bottom":case"centerY":if(!["top","bottom","centerY"].contains(r))continue;I=Math.min(l.left,o.left),_=Math.max(l.right,o.right),Math.abs(l[r]-o[n])<1*p&&(E.y[n]?I<E.y[n].left?(E.y[n].left=I,E.y[n].targetRect=l,E.y[n].targetType=r):_>E.y[n].right&&(E.y[n].right=_,E.y[n].targetRect=l,E.y[n].targetType=r):E.y[n]={value:o[n],left:I,right:_,targetRect:l,targetType:r})}var L,A;for(n in E.x)(L=E.x[n])&&(A=$(document.createElement("span")),A.addClass("align_guide_line").css({position:"absolute",borderLeft:"1px solid "+("page"===L.targetRect.name?"#00ffff":(L.targetType.indexOf("center"),"#00ffff")),height:L.bottom-L.top+"px",top:L.top-q.top+"px",left:0,transform:"translateX(-50%)translateX("+(L.value-q.left)+"px)"}),bt.append(A));for(n in E.y)(L=E.y[n])&&(A=$(document.createElement("span")),A.addClass("align_guide_line").css({position:"absolute",width:L.right-L.left+"px",borderTop:"1px solid "+("page"===L.targetRect.name?"#00ffff":(L.targetType.indexOf("center"),"#00ffff")),left:L.left-q.left+"px",top:0,transform:"translateY(-50%)translateY("+(L.value-q.top)+"px)"}),bt.append(A))}function U(){$(".align_guide_line").remove()}function N(){var t=fontPool.getFonts(),e=$("#btn-select-font-family-template ul");0==e.find("li").length&&$.each(t,function(t,a){var o=$('<li class="select_item"></li>');o.attr("data-value",a.value).css({"font-family":"font"+a.value+",serif"}).text(a.name),e.append(o)})}function Y(){$(".simple-tooltip").remove()}function O(t){if(t=$(t),pt.isImageSlot(t)){var e;e=pt.isEmpty(t)?$("#edit-slot-btn-template_imageslot-empty").html():$("#edit-slot-btn-template_imageslot").html(),yt.empty().append(e).show()}else if(pt.isTextSlot(t)){N();var a=$("#edit-slot-btn-template_textslot").html();yt.empty().append(a).show()}else if(pt.isDecorationSlot(t)){var o=$("#edit-slot-btn-template_decorationslot").html();yt.empty().append(o).show()}else if(pt.isShapeSlot(t)){var i=$("#edit-slot-btn-template_shapeslot").html();yt.empty().append(i).show()}else if(pt.isShadingSlot(t)){var i=$("#edit-slot-btn-template_shadingslot").html();yt.empty().append(i).show()}wt.empty().append($("#edit-slot-btn-template_common").html()).show(),J(t,$("#pageEditMain .edit_box_tool")),$("body").data("opEl",t),$(".edit_box_tool .edit_btn").simpletooltip({position:"bottom"})}function J(t,e){t=$(t);var a=pt.getAttr(t);a.locked?e.find('[data-type="locked"]').attr("data-locked",!0).attr("data-value",!1):e.find('[data-type="locked"]').attr("data-locked",!1).attr("data-value",!0),pt.isTextSlot(t)?("bold"==a.weight&&e.find('[data-type="weight"]').attr("data-select",!0),"italic"==a.style&&e.find('[data-type="style"]').attr("data-select",!0),"underline"==a.decoration&&e.find('[data-type="decoration"]').attr("data-select",!0),"left"==a.align&&e.find('[data-type="align"][data-value="left"]').attr("data-select",!0),"center"==a.align&&e.find('[data-type="align"][data-value="center"]').attr("data-select",!0),"right"==a.align&&e.find('[data-type="align"][data-value="right"]').attr("data-select",!0),e.find('[data-type="font-color"]').val(a.color).attr("data-value",a.color).children(".color").css({"background-color":a.color}),e.find('[data-type="font-family"]').attr("data-value",a.fontId).children("span").css({"font-family":"font"+a.fontId+",serif"}).text(fontPool.getFontName(a.fontId)),e.find('[data-type="font-size"]').attr("data-value",a.pt).children("span").text(a.pt+"pt")):pt.isImageSlot(t)?e.find('[data-type="bordercolor"]').val(a.borderColor).attr("data-value",a.borderColor).children(".color").css({"background-color":a.borderColor}):pt.isShapeSlot(t)&&(e.find('[data-type="bordercolor"]').val(a.borderColor).attr("data-value",a.borderColor).children(".color").css({"background-color":a.borderColor}),e.find('[data-type="color"]').val(a.color).attr("data-value",a.color).children(".color").css({"background-color":a.color}))}function V(){wt.hide(),yt.hide()}function G(){return xt.children(".page").children(".slot[aria-selected=true],.imageslot[aria-selected=true],.textslot[aria-selected=true]")}function Z(){var t,e=G();if(e.length&&(t=e),0!==t.length){return Array.prototype.map.call(t,function(t){return t=$(t),{pageSeq:t.parent().attr("data-seq"),name:t.attr("data-name"),type:t.attr("data-type")}})}}function Q(){$(document).triggerHandler("pointerdown.hideSelectionHandles")}function K(){return xt.children(".page.active")}function tt(){return K().attr("data-seq")}function et(t){at(xt.children(".page[data-seq="+t+"]"))}function at(t){t=$(t);var a=t.attr("data-seq");"blank"!==t.attr("data-type")&&(t.addClass("active").siblings(".page").removeClass("active"),opEvent.eSetPageActive.trigger(e,{pageSeq:a,pageType:t.hasClass("left_page")?"left":"right"}))}function ot(t,a){function o(t){return i.children('.textslot[data-index="'+d+'"],.imageslot[data-index="'+d+'"]')}t=$(t);var i=t.parent(),n=pt.getAttr(t),r=n.index,s=0,l=r;t.parent().children(pt.getAllSlotClass()).each(function(t,e){var a=pt.getAttr(e).index;a>s?s=a:a<l&&(l=a)}),"top"===a?a=s+1:"bottom"===a?a=l-1:"up"===a?a=r+1:"down"===a&&(a=r-1),a>s+1&&(a=s+1),a<l-1&&(a=l-1);var d;if(a<r)for(d=a;d<r;d++)pt.setAttr(o(d),{index:d+1});else{if(!(a>r))return;for(d=a;d>r;d--)pt.setAttr(o(d),{index:d-1})}pt.setAttr(t,{index:a});var c=i.children(pt.getAllSlotClass()).sort(function(t,e){return pt.getAttr(t).index-pt.getAttr(e).index});for(d=0;d<c.length;d++){var g=c.eq(d);pt.setAttr(g,{index:d});var h=!1;d===a&&(h=!0),opEvent.eSlotChanged.trigger(e,{el:g,pageSeq:g.parent().attr("data-seq"),name:g.attr("data-name"),saveToHistory:h,obj:{index:d}})}}function it(t,e,a,o){var i,n=$("#book_edit-template_page").html();for(i=0;i<t.length;i++)t[i]||t.splice(i,1);var r=t.length;for($(document).triggerHandler("pointerdown.hide"),xt.children(".page").remove(),i=0;i<r;i++){var s=$(n),l=t[i],d=l.width,c=l.height;if(s.attr({"data-width-mm":l.width,"data-height-mm":l.height,"data-type":l.type,"data-background-color":l.backgroundColor,"data-page":0===i?"left_page":"right_page"}).addClass(0===i?"left_page":"right_page").css({width:mt.mmToPx(d)+"px",height:mt.mmToPx(c)+"px",left:0===xt.children(".page:last").length?0:xt.children(".page:last").outerWidth()}),x(s,{seq:l.seq}),xt.append(s),S(l,e),xt.attr("data-type",l.type),"normal"==l.type&&(1===r&&xt.attr("data-type","single"),1===r&&1===i&&(l.num%2==0?(xt.children(".left_page").children(pt.getAllSlotClass()).remove(),xt.children(".right_page").attr({"data-type":"blank","data-seq":"blank"}).children(pt.getAllSlotClass()).appendTo(xt.children(".left_page"))):xt.children(".left_page").attr({"data-type":"blank","data-seq":"title_page_back"}).css({background:"white"}).children(pt.getAllSlotClass()).remove())),o?et(o):at(xt.children(".page:first")),!a){var g=function(){var t=0;return xt.children(".page").each(function(e,a){t+=$(a).outerWidth(!0)}),t}(),h=function(){var t=0;return xt.children(".page").each(function(e,a){$(a).outerHeight()>t&&(t=$(a).outerHeight(!0))}),t}();xt.css({width:g,height:h}),v()}}}function nt(t,e){var a=t.data("rect");return a&&!e||t.data("rect",a=t[0].getBoundingClientRect()),a}function rt(){opEvent.eSlotSelected.register(function(t){var e=t.el,a=(t.multiple,t.notShowToolbar);e=$(e);var o=e.data("selectionHandles"),i=G();0!=i.length&&e[0]!==i[0]&&Q(),o.isOn?(o.resetPosition(),o.show()):o.on(),e.is('.slot[data-locked="true"],.page[data-seq="front-flap"] > .slot,.page[data-slot="back-flap"] > .slot')&&o.hideHandles(),a||(O(e),view.right.showSetSlot()),"true"!==e.attr("aria-selected")&&(e.attr("aria-selected",!0),at(e.parent()),$(document).on("pointerdown.hide.hideSelectionHandles",function(t){if(!($(t.target).is(".colorpicker, .colorpicker *")||$(t.target).is(".smart_menu_box, .smart_menu_box *")||$(t.target).is(".selection-handle")||$(t.target).is(".edit_box_tool,.edit_box_tool *")||$(t.target).is(".set_property_box,.set_property_box *")||$(t.target).is(".edit_toolbar,.edit_toolbar *")||$(t.target).is($(".slot").add($(".slot *")))||$(t.target).is(".preventHideSelectionHandles,.preventHideSelectionHandles *")||$(t.target).is(".slot_attr_wrapper,.slot_attr_wrapper *"))){var e=G();e.data("selectionHandles").off(),V(),view.right.showSetPageInfo(),e.removeAttr("aria-selected"),$(document).off(".hideSelectionHandles")}}))})}var st,lt=t("size-converter"),dt=t("selection-handles"),ct=t("transform"),gt=t("draggable"),ht=t("zoombar"),pt=t("slot"),ut=t("imgload"),ft=t("event"),mt=new lt(108),vt=$("body"),bt=$(".edit_wrapper"),xt=$(".book_edit"),St=$("#bookScaleZoombar"),yt=$("#edit-slot-btn-change"),wt=$("#edit-slot-btn-fixed"),kt={eSlotBtnOpEvent:new ft,eInsertNewPhotoToSlot:new ft,eNewImageSlotInsert:new ft,eImageSlotRendered:new ft,eImageSlotResize:new ft,eImageSlotChanged:new ft,eImageSlotImageScale:new ft,eImageSlotDelete:new ft,eNewDecorationSlotInsert:new ft,eNewShapeSlotInsert:new ft,eShapeSlotDelete:new ft,eShapeSlotChanged:new ft,eDecorationSlotChanged:new ft,eDecorationSlotDelete:new ft,eDecorationSlotImgResize:new ft,eShadingSlotChanged:new ft,eMewTextSlotInsert:new ft,eTextSlotChanged:new ft,eTextSlotDelete:new ft,eSlotChanged:new ft,eSlotSelected:new ft,eSlotsRemove:new ft,eSlotDelete:new ft,eDrawPageThumbnail:new ft,eChangePageInfo:new ft,eCopySlots:new ft,eCutSlots:new ft,ePasteSlots:new ft};e.init=o,e.bind=s,e.events=kt,e.initEvent=rt,e.render=it,e.initPageSlot=S,e.setPageActive=et,e.getActivePage=K,e.getActivePageSeq=tt,e.getBookCurrentScale=m,e.resetBookScaleAndPosition=v,e.getPageRect=nt,e.getCurrentPageSeqs=b,e.computeSlotXY=M,e.selectSlot=W,e.getSelectedSlotsInfo=Z,e.getSelectedSlot=G,e.setSlotZIndex=ot,e.setImgSlotRequireSize=B,e.removeImgSlotImg=j,e.insertPhotoIntoImgSlot=z}),define("right",["slot","transform","draggable","event","size-converter"],function(t,e,a){function o(){$('#right-slot-attr .tab_body[data-type="page"]').empty().append($(k).html())}function i(){$("#right-slot-attr").unbind("click").on("click",".attr_tab > a[data-type]",function(){var t=$(this).attr("data-type");$(this).addClass("active").siblings().removeClass("active"),$("#right-slot-attr .tab_body[data-type="+t+"]").addClass("active").siblings().removeClass("active")}).on("click",".edit_btn, .edit_select_btn",function(t){t.preventDefault(),r();var a=$(this).attr("data-sub-template");if(void 0!=a){var o=$(this),i=$("#"+a),n=o[0].getBoundingClientRect();if(i.data("sender",o),"none"!==i.css("display"))return void $(document).triggerHandler("pointerdown.hideSubBtn#"+a);if(i.css({display:"block",visibility:"hidden",animation:"none"}),i.offset({left:n.left+1,top:n.bottom+7+$(window).scrollTop()+i.outerHeight(!0)>$(window).height()?$(window).height()-i.outerHeight(!0)-3:n.bottom+$(window).scrollTop()+7}),0!==i.find(".select_list_box").length){var s=n.width-2;s<60&&(s=60,i.offset({left:n.left-12})),i.css({width:s})}else i.is(".set_opacity_box")&&i.offset({left:n.left-50});i.offAnimationEnd().oneAnimationEnd(function(){$(document).on("pointerdown.hide.hideSubBtn#"+a,function(t){$(t.target).is(o.add(o.find("*")).add(i).add(i.find("*")))||(i.css({display:"none"}),i.removeData("sender"),$(document).off(".hideSubBtn#"+a))})}).css({visibility:"visible",animation:"jump-in 0.1s"})}else{var l=$("body").data("opEl"),d={};d.type=$(this).attr("data-type"),d.value=$(this).attr("data-value"),d.el=l,opEvent.eSlotBtnOpEvent.trigger(e,d)}}).on("ifChanged",'input[type="checkbox"]',function(t){var a=$(this).is(":checked"),o=$(this).attr("data-type"),i=$("body").data("opEl"),n={};n.type=o,n.value=a,n.el=i,opEvent.eSlotBtnOpEvent.trigger(e,n)}).on("change",'input[type="text"], input[type="number"]',function(){var t=$(this).val(),a=$(this).attr("data-type"),o=$(this).attr("type"),i=$("body").data("opEl"),n=$(this).attr("data-value-type"),r=$(this).parent().is(".mm"),s={};s.type=a,s.isMM=r,s.value="text"==o?t:"integer"==n?parseInt(t):parseFloat(t).toFixed(1),"opacity"==a&&(s.value=parseFloat(t/100)),s.el=i,opEvent.eSlotBtnOpEvent.trigger(e,s)}).on("click",".j-save-as-template",function(){var t=view.edit.getActivePageSeq();opEvent.eSaveAsTemplate.trigger(e,{pageSeq:t})}).on("change",'select[data-type="fontId"]',function(){var t=$("body").data("opEl"),a=$('#right-slot-attr [data-type="fontId"]').val();if("front_flap"==t.parent().attr("data-num"))v.setAttr(t,{fontId:a,doNotAutoSetTextSlotHeight:!0}),opEvent.eTextSlotChanged.trigger(e,{pageSeq:t.parent().attr("data-seq"),name:t.attr("data-name"),obj:{fontId:a}});else{v.setAttr(t,{fontId:a});var o=w.pxToMm(v.text.getTextSlotTextHeight(t));opEvent.eTextSlotChanged.trigger(e,{pageSeq:t.parent().attr("data-seq"),name:t.attr("data-name"),obj:{fontId:a,height:o}})}}),$('#right-slot-attr .attr_tab > a[data-type="page"]').trigger("click")}function n(t){$('#right-slot-attr .j-pageinfo[data-type="name"]').val(t.name),$('#right-slot-attr .j-pageinfo[data-type="width"]').val(t.width),$('#right-slot-attr .j-pageinfo[data-type="height"]').val(t.height),$('#right-slot-attr .j-pageinfo[data-type="backgroundColor"]').attr("data-value",t.backgroundColor).find(".color").css({"background-color":t.backgroundColor})}function r(){$(".simple-tooltip").remove()}function s(t){var e=fontPool.getFonts(),a=t.find('[data-type="fontId"]');a.empty(),$.each(e,function(t,e){var o=$($("#right-attr-font-item").html());o.attr("value",e.value).css({"font-family":"font"+e.value+",serif"}).text(e.name),a.append(o)})}function l(t){t=$(t),$("body").data("opEl",t);var e="#right-attr-set-slot-common",a=$(e).html();v.isTextSlot(t)?e="#right-attr-set-slot-text":v.isImageSlot(t)&&!v.isEmpty(t)?e="#right-attr-set-slot-image":v.isImageSlot(t)&&v.isEmpty(t)?e="#right-attr-set-slot-image-empty":v.isDecorationSlot(t)?e="#right-attr-set-slot-decoration":v.isShadingSlot(t)?(a=$("#right-attr-set-slot-common-shading").html(),e="#right-attr-set-slot-shading"):v.isShapeSlot(t)&&(e="#right-attr-set-slot-shape"),a+=$(e).html();var o=$(a);v.isTextSlot(t)&&s(o),c(t,o),$('#right-slot-attr .tab_body[data-type="slot"]').empty().append(o),$("#right-slot-attr .cm_zoombar .zoombar_cursor").each(function(){h($(this))})}function d(){$("#right-slot-attr").find(".select_color").each(function(){var t=$(this).attr("data-value");null==$(this).data("colorpickerId")&&$(this).ColorPicker({color:t,onShow:function(t){return $(t).is(":visible")?$(t).fadeOut(500):$(t).fadeIn(500),!1},onHide:function(t){return $(t).fadeOut(500),!1},onSubmit:function(t,a,o,i){$(i).find("span").css("backgroundColor","#"+a),$(i).ColorPickerHide();var n=$(i).attr("data-type"),r="#"+a,s=$("body").data("opEl");$(i).is(".j-pageinfo")?opEvent.eChangePageInfo.trigger(e,{seq:view.edit.getActivePageSeq(),type:n,value:r}):null!=s&&opEvent.eSlotBtnOpEvent.trigger(e,{el:s,type:n,value:r})}})})}function c(t,e){t=$(t);var a=v.getAttr(t);e.find('input[data-type="name"]').val(t.attr("data-name")),a.locked?e.find('input[data-type="locked"]').iCheck("check"):e.find('input[data-type="locked"]').iCheck("uncheck"),a.readonly?e.find('input[data-type="readonly"]').iCheck("check"):e.find('input[data-type="readonly"]').iCheck("uncheck"),e.find('input[data-type="opacity"]').val(100*a.opacity),e.find('input[data-type="width"]').val(w.pxToMm(a.width).toFixed(1)),e.find('input[data-type="height"]').val(w.pxToMm(a.height).toFixed(1)),e.find('input[data-type="x"]').val(w.pxToMm(a.x).toFixed(1)),e.find('input[data-type="y"]').val(w.pxToMm(a.y).toFixed(1)),e.find('input[data-type="rotation"]').val(a.rotation),v.isTextSlot(t)?(e.find('input[data-type="pt"]').val(a.pt),e.find('[data-type="font-color"]').val(a.color).attr("data-value",a.color).children(".color").css({"background-color":a.color}),e.find('select[data-type="fontId"]').val(a.fontId),e.find('input[data-type="maxLine"]').val(a.maxLine),e.find('input[data-type="maxLength"]').val(a.maxLength)):v.isImageSlot(t)?(e.find('input[data-type="borderwidth"]').val(w.pxToPt(a.borderWidth)),e.find('[data-type="bordercolor"]').val(a.borderColor).attr("data-value",a.borderColor).children(".color").css({"background-color":a.borderColor})):v.isShapeSlot(t)&&(e.find('input[data-type="borderwidth"]').val(w.pxToPt(a.borderWidth)),e.find('[data-type="bordercolor"]').val(a.borderColor).attr("data-value",a.borderColor).children(".color").css({"background-color":a.borderColor}),e.find('[data-type="color"]').val(a.color).attr("data-value",a.color).children(".color").css({"background-color":a.color}))}function g(){var t=$("#right-slot-attr .cm_zoombar .zoombar_cursor"),e=new x(t);e.dragStart.register(function(t){var e=$(t.currentTarget),a=b.getCurrent(e);e.data({dragStartXY:{x:a.translationX,y:a.translationY},click:!1})}),e.drag.register(function(e){var a=$(e.currentTarget),o=a.closest(".cm_zoombar").width()-t.innerWidth(),i=a.data("dragStartXY"),n=i.x+e.deltaX;n>o?n=o:n<0&&(n=0),b.translate(a,n,0);var r,s=a.closest(".cm_zoombar").next(),l=s.find(".zoombar_value");s.hasClass("deg")?r=Math.round(n/o*360-180):s.hasClass("percent")&&(r=Math.round(n/o*100)),l.val(r)}),e.dragEnd.register(function(t){var e=$(t.currentTarget);e.closest(".cm_zoombar").next().find(".zoombar_value").trigger("change"),e.removeData("dragStartXY")})}function h(t,e){var a=t.closest(".cm_zoombar"),o=a.width()-t.innerWidth(),i=t.closest(".cm_zoombar").next(),n=t.closest(".cm_zoombar").next();e=e?parseInt(e):parseInt(i.find(".zoombar_value").val()),i.hasClass("deg")?n=(e+180)/360*o:i.hasClass("percent")&&(n=e/100*o),b.translate(t,n,0)}function p(){g(),$("#right-slot-attr select").chosen({placeholder_text:"请选择字体...",no_results_text:"无字体",disable_search:!0}),SureUtil.changeButtonCss(),$("#right-slot-attr  .edit_btn").simpletooltip({position:"bottom"})}function u(){$('#right-slot-attr .attr_tab > a[data-type="page"]').trigger("click")}function f(){$('#right-slot-attr .attr_tab > a[data-type="slot"]').trigger("click")}function m(){opEvent.eSlotSelected.register(function(t){var e=t.el,a=t.multiple;f(),l(e,a),p(),d()}),opEvent.ePageListItemSelected.register(function(t){var e=t.pageSeqs,a=t.selectedPageSeq;if(void 0===e)throw new Error("pageSeqs为undefined");void 0===a&&(a=e[0]),n(model.book.getPageBySeq(a)),d()}),opEvent.eSlotChanged.register(function(t){var a=$("body").data("opEl"),o=t.pageSeq,i=t.name;a.parent().attr("data-seq")==o&&a.attr("data-name")==i&&opEvent.eSlotSelected.trigger(e,{el:a,multiple:!1})})}var v=t("slot"),b=t("transform"),x=t("draggable"),S=t("event"),y=t("size-converter"),w=new y(108),k="#right-page-info",T={eChangeBookInfo:new S,eSaveAsTemplate:new S};e.init=o,e.bind=i,e.events=T,e.initEvent=m,e.showSetPageInfo=u,e.showSetSlot=f}),define("left",function(t,e,a){function o(){}function i(){$(".aside_left .left_tab a, .aside_left .sub_tab > a").click(function(){var t=$(this).attr("data-type");$(this).addClass("active").siblings().removeClass("active"),$(".aside_left .tab_body[data-type="+t+"]").addClass("active").siblings().removeClass("active"),$(".aside_left .tab_body[data-type="+t+"]").maskLoading({time:600,bgColor:"#3f464d",load:function(){}}),"template"==t&&view.leftTemplate.init()}),$('.aside_left .left_tab a[data-type="photo"]').trigger("click")}e.init=o,e.bind=i,e.events={}}),define("mainv",["event"],function(t,e,a){function o(){$("body").attr("data-type",editType),r(c.edit,c.edit),l(),SureUtil.changeButtonCss()}function i(){$("#switchSortpage").unbind("click").on("click",function(){var t=$(this).attr("data-type");$(".page_control_header .act_btn").removeClass("selected"),$(this).addClass("selected");var a=$("body").attr("data-mode");opEvent.eModeChange.trigger(e,{from:a,to:t})})}function n(){$("body").attr({"data-bookscale-bottom":"scalehide","data-bookscale-left":"scalehide","data-bookscale-right":"scalehide","data-mode":"preview-book"}),$(".preview-hide").hide()}function r(t,a,o){o=o||{};o.onSuccess;switch($("body").attr("data-mode",a),"create-tpl"==editType?($("body").attr({"data-bookscale-bottom":"scaleshow","data-bookscale-left":"scaleshow","data-bookscale-right":"scaleshow"}),$("#pageEditMain .edit_box_tool").hide()):"user-edit"==editType?$("body").attr({"data-bookscale-bottom":"scaleshow","data-bookscale-left":"scaleshow"}):"user-preview"==editType&&n(),a){case"sort-page":view.pagesort.initPageSort(),$("#switchSortpage").html('<span class="icon-th"></span>编辑模式').attr("data-type","edit-book").attr("title","编辑模式"),$("#footerPageList .page_control_header .act_btn[data-type]").removeClass("selected"),$("#changeEditModeToSortPage").addClass("selected");break;case"edit-book":o&&o.book&&opEvent.eRefreshAll.trigger(e,{book:o.book,photos:o.photos,selectPageSeq:view.edit.getActivePageSeq()}),$("#switchSortpage").html('<span class="icon-th"></span>列表模式').attr("data-type","sort-page").attr("title","列表模式"),$("#footerPageList .page_control_header .act_btn[data-type]").removeClass("selected"),$("#changeEditModeToEditBook").addClass("selected");break;case"preview-book":"preivew-book"==t?$("body").attr({"data-bookscale-bottom":"scaleshow","data-bookscale-left":"scaleshow","data-bookscale-right":"scaleshow"}):$("body").attr({"data-bookscale-bottom":"scalehide","data-bookscale-left":"scalehide","data-bookscale-right":"scalehide"})}"preview-book"!=t&&"preview-book"!=a||view.edit.resetBookScaleAndPosition()}function s(){opEvent.eModeChange.register(function(t){var e=t.from,a=t.to,o=t.args||{};switch(e){case"sort-page":o.save&&view.pagesort.save()}var i,n;switch(i=model.book.getBookInfo(),n=model.photo.getPhotos(),a){case"edit-book":o.save?r(e,a,{book:i,photos:n}):r(e,a);break;case"sort-page":case"preview-book":r(e,a,{book:i,photos:n})}})}function l(){function t(){r.attr("data-bookscale-left","scalehide"),s.attr("data-lock","true")}function e(){r.attr("data-bookscale-right","scalehide"),l.attr("data-lock","true")}function a(){r.attr("data-bookscale-left","scaleshow"),s.attr("data-lock","false")}function o(){r.attr("data-bookscale-right","scaleshow"),l.attr("data-lock","false")}function i(){r.attr("data-bookscale-bottom","scalehide"),d.attr("data-lock","true")}function n(){r.attr("data-bookscale-bottom","scaleshow"),d.attr("data-lock","false")}var r=(window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,$("body")),s=$(".aside_left_lock"),l=$(".aside_right_lock"),d=$(".footer_lock"),c=$("#hideAside");!function(){s.on("click",function(e){e.preventDefault();var o=s.attr("data-lock");"true"==o?a():"false"==o&&t(),view.edit.resetBookScaleAndPosition()}),l.on("click",function(t){t.preventDefault();var a=l.attr("data-lock");"true"==a?o():"false"==a&&e(),view.edit.resetBookScaleAndPosition()}),d.on("click",function(t){t.preventDefault();var e=d.attr("data-lock");"true"==e?n():"false"==e&&i(),view.edit.resetBookScaleAndPosition()}),c.on("click",function(){"false"==$(this).attr("data-lock")?(i(),t(),c.attr("data-lock",!0)):(n(),a(),c.attr("data-lock",!1)),view.edit.resetBookScaleAndPosition()})}()}var d=t("event"),c={edit:"edit-book",sort:"sort-page",preview:"preview-book"};e.init=o,e.bind=i,e.events={eModeChange:new d},e.initEvent=s,e.setEditMode=r,e.onEditescaleByWin=l}),define("canvas",["size-converter"],function(t,e,a){function o(t,e,a){return new SureIR.uploader({bucket:qiniu_book_bucket,domain:qiniu_book_domain,multi_selection:!1,auto_start:!0,progressText:"上传缩略图({0}%)...",initToken:a},{FilesAdded:function(t,e){},UploadProgress:function(t,e){},FileUploaded:function(t,a,o){var i=$.parseJSON(o),n=SureIR.createIRFromQiniu(t,a,i,{});SureIR.addIR(n,function(t){"function"==typeof e&&e(t)})},Key:function(e,a){var o=a.md5||(new UUID).id;return"thumbnail/"+App.data.bookId+"/"+t.seq+"/"+o},UploadComplete:function(t){}})}function i(t,a,i,r){n(t,a,function(a){var n=a.canvas,r=o(t,function(t){"function"==typeof i&&i.call(e,{ir:t})},function(){var t=n.toDataURL();r.addLoaclImg(t)})},r)}function n(t,a,o,i){var n=document.createElement("canvas"),s=u;i&&(s=new p(i)),n.width=s.mmToPx(t.width),n.height=s.mmToPx(t.height);var d=n.getContext("2d");d.fillStyle=t.backgroundColor,d.fillRect(0,0,n.width,n.height),t.decorationSlotList||(t.decorationSlotList=[]),t.shapeSlotList||(t.shapeSlotList=[]),t.shadingSlotList||(t.shadingSlotList=[]);var f=t.imageSlotList.concat(t.textSlotList).concat(t.decorationSlotList).concat(t.shapeSlotList).concat(t.shadingSlotList);if(f.sort(function(t,e){return t.index-e.index}),0===f.length)"function"==typeof o&&o.call(e,{canvas:n});else{var m=0,v=function(){m<f.length?b():m===f.length&&"function"==typeof o&&o.call(e,{canvas:n})},b=function(){if("image"in f[m]){var e=f[m];if("copyright"===t.seq)if(["black","#000000","#000"].some(function(e){return e===t.backgroundColor})){if("imglogo"===e.name)return m++,void v()}else if("imglogoblackbg"===e.name)return m++,void v();var a=null;e.image&&(a=model.photo.getById(e.image.id)),r({context:d,borderWidth:s.ptToPx(e.borderWidth||0),borderColor:e.borderColor||"#ffffff",width:s.mmToPx(e.width),height:s.mmToPx(e.height),x:s.mmToPx(e.x),y:s.mmToPx(e.y),rotation:e.rotation,image:e.image?{x:s.mmToPx(e.image.x),y:s.mmToPx(e.image.y),width:s.mmToPx(e.image.width),rotation:e.image.rotation}:null,themeImage:e.themeImage?{x:s.mmToPx(e.themeImage.x),y:s.mmToPx(e.themeImage.y),width:s.mmToPx(e.themeImage.width),rotation:e.themeImage.rotation,url:e.themeImage.url}:null},a,function(){m++,v()})}else if("content"in f[m]){var o=f[m];l({context:d,width:s.mmToPx(o.width),height:s.mmToPx(o.height),x:s.mmToPx(o.x),y:s.mmToPx(o.y),content:o.content,rotation:o.rotation,fontId:o.fontId,px:s.ptToPx(o.pt),color:o.color||"#000",align:o.align,lineheight:o.leading<0?1.2*s.ptToPx(o.pt):u.ptToPx(o.leading),letterSpacing:o.space/1e3*s.ptToPx(o.pt)}),m++,v()}else if("src"in f[m]){var i=f[m];if("copyright"===t.seq)if(["black","#000000","#000"].some(function(e){return e===t.backgroundColor})){if("imglogo"===i.name)return m++,void v()}else if("imglogoblackbg"===i.name)return m++,void v();c({context:d,borderWidth:0,borderColor:"#ffffff",width:s.mmToPx(i.width),height:s.mmToPx(i.height),x:s.mmToPx(i.x),y:s.mmToPx(i.y),rotation:i.rotation,src:i.src},function(){m++,v()})}else if("color"in f[m]){var n=f[m];if("copyright"===t.seq)if(["black","#000000","#000"].some(function(e){return e===t.backgroundColor})){if("imglogo"===n.name)return m++,void v()}else if("imglogoblackbg"===n.name)return m++,void v();g({context:d,borderWidth:n.borderWidth,opacity:n.opacity,color:n.color,borderColor:n.borderColor,width:s.mmToPx(n.width),height:s.mmToPx(n.height),x:s.mmToPx(n.x),y:s.mmToPx(n.y),rotation:n.rotation},function(){m++,v()})
}else if(f[m].name.indexOf("shading")>=0){var p=f[m];h({id:p.id,editUrl:p.editUrl,context:d,width:s.mmToPx(p.width),height:s.mmToPx(p.height),x:s.mmToPx(p.x),y:s.mmToPx(p.y),rotation:p.rotation,imgWidth:s.mmToPx(p.imgWidth)},function(){m++,v()})}};v()}}function r(t,e,a){var o=t.context,i=t.width,n=t.height,r=t.x,l=t.y,d=t.rotation,c=t.borderWidth,g=t.borderColor,h=t.image?{x:t.image.x,y:t.image.y,width:t.image.width,rotation:t.image.rotation}:null,p=t.themeImage?{x:t.themeImage.x,y:t.themeImage.y,width:t.themeImage.width,rotation:t.themeImage.rotation,url:t.themeImage.url}:null,u=function(t){o.save(),o.translate(r+c+i/2,l+c+n/2),o.rotate(d*Math.PI/180),o.translate(-i/2,-n/2),o.strokeStyle=g,o.lineWidth=c,o.strokeRect(-c/2,-c/2,i+c,n+c),o.beginPath(),o.rect(0,0,i,n),t(),o.restore()};if(h&&e||p){var f=document.createElement("img");f.crossOrigin="anonymous",f.onload=function(){u(function(){o.clip(),o.translate(h.x+h.width/2,h.y+h.width/2*f.height/f.width);var t=h.width/f.width;o.scale(t,t),o.rotate(h.rotation*Math.PI/180),o.translate(-f.width/2,-f.width/2*f.height/f.width),o.drawImage(f,0,0)}),f=null,"function"==typeof a&&a.call(this)},f.onerror=function(){f=null,"function"==typeof a&&a.call(this)},e?e.ir.src&&(f.src=s(e.ir.src)):p&&p.url&&(f.src=s(p.url))}else u(function(){o.fillStyle="#a1a1a1",o.fill()}),"function"==typeof a&&a.call(this)}function s(t){return t}function l(t){var e=t.context,a=t.width,o=t.height,i=t.x,n=t.y,r=t.content,s=t.rotation,l=t.fontId,c=t.px,g=t.color,h=t.align,p=t.lineheight,u=t.letterSpacing;if(e.save(),e.font=c+"px "+d(l)+",font"+l,e.fillStyle=g,e.textAlign=h,e.textBaseline="middle",e.translate(i+a/2,n+o/2),e.rotate(s*Math.PI/180),e.translate(-a/2,-o/2),e.beginPath(),e.rect(0,0,a,o),r&&0!==r.length){switch(e.clip(),e.translate(0,p/2),e.textAlign){case"center":e.translate(a/2,0);break;case"right":e.translate(a,0)}var f,m,v,b=/([^\x00-\xff])|([\x00-\xff]+|\n)/g,x=r&&b.test(r)?r.match(b):[],S="",y=0,w=0;for(f=0,v=x.length;f<v;f++){var k=x[f];if("\n"!==k&&(e.measureText(S+k).width+(S+k).length*u<=a||1===(S+k).length)){if(S+=k,w++,f<v-1)continue}else if(e.measureText(S+k).width+(S+k).length*u>a){if(0===w&&/^[\x00-\xff]+$/.test(k)){var T="";for(m=0;m<k.length;m++){var P=k.charAt(m);if(!(e.measureText(T+P).width+(T+P).length*u<=a||1===(T+P).length)){S=T,x[f]=k.substring(m);break}T+=P}}"\n"!==k&&f--}var $=0,C=e.measureText(S).width+u*S.length;switch(e.textAlign){case"center":$=-C/2;break;case"right":$=-C}for(m=0;m<S.length;m++){var I=S.substring(0,m);e.fillText(S[m],$+e.measureText(I).width+u*I.length,0)}S="",w=0,e.translate(0,p),y++}}else e.fillStyle="#ccc",e.fill();e.restore()}function d(t){return fontPool.getFontName(t)}function c(t,e){var a=t.context,o=t.width,i=t.height,n=t.x,r=t.y,s=t.rotation,l=(t.borderWidth,t.borderColor,t.src),d=function(t){a.save(),a.beginPath(),a.rect(n,r,o,i),t(),a.restore()},c=document.createElement("img"),g=l.replace("medium","preview");c.crossOrigin="anonymous",c.onload=function(){d(function(){a.translate(n+o/2,r+i/2),a.rotate(s*Math.PI/180);var t=o/c.width,e=i/c.height;a.scale(t,e),a.translate(-c.width/2,-c.height/2),a.drawImage(c,0,0)}),"function"==typeof e&&e.call(this)},c.onerror=function(){"function"==typeof e&&e.call(this)},c.src=g}function g(t,e){var a=t.context,o=t.width,i=t.height,n=t.x,r=t.y,s=t.rotation,l=t.borderWidth,d=t.borderColor,c=t.opacity,g=t.color;!function(t){a.save(),a.translate(n+l+o/2,r+l+i/2),a.rotate(s*Math.PI/180),a.translate(-o/2,-i/2),a.roundRect(0,0,o,i,5,5,5,5),a.strokeStyle=d,a.lineWidth=l,a.strokeRect(-l/2,-l/2,o+l,i+l),a.beginPath(),a.globalAlpha=c,a.rect(0,0,o,i),t(),a.restore()}(function(){a.fillStyle=g,a.fill()}),"function"==typeof e&&e.call(this)}function h(t,e){var a=t.context,o=(t.id,t.thumbUrl,t.editUrl),i=t.width,n=t.height,r=t.rotation,s=t.x,l=t.y,d=t.imgWidth,c=document.createElement("img");c.crossOrigin="anonymous",c.onload=function(){a.save(),a.translate(s+i/2,l+n/2),a.rotate(r*Math.PI/180),a.translate(-i/2,-n/2),a.beginPath(),a.rect(0,0,i,n),a.clip(),a.drawImage(c,0,0,d,d*this.height/this.width),a.restore(),c=null,"function"==typeof e&&e.call(this)},c.onerror=function(){c=null,"function"==typeof e&&e.call(this)},c.src=o}var p=t("size-converter"),u=new p(108);e.generatePreviewCanvas=n,e.generateThumbnail=i,e.drawImgSlotOnCanvas=r,e.drawTextSlotOnCanvas=l,e.drawDecorationSlotOnCanvas=c,e.drawShapeSlotOnCanvas=g,e.drawShadingSlotOnCanvas=h}),define("pageUtil",["size-converter","canvas"],function(t,e,a){function o(t){for(var e=[],a=-5;a<t.innerPage.length+2;a++){var o=t.innerPage[a];if(-5===a){if(!t.cover)continue;o=t.cover}else if(-4===a){if(!t.spine)continue;o=t.spine}else if(-3===a){if(!t.frontFlap)continue;o=t.frontFlap}else{if(-2===a)continue;if(-1===a){if(!t.flyleaf)continue;o=t.flyleaf}else if(a===t.innerPage.length){if(!t.copyright)continue;o=t.copyright}else if(a===t.innerPage.length+1){if(!t.backCover)continue;o=t.backCover}}e.push(o)}return e}function i(t,e,a,i,r){t.empty();var s,l,d=o(e);for(l=0;l<d.length;l++){s=d[l];var p=$(g),u=p.children(".page_preview");t.append(p);var f,m;switch(s.type){case"front-cover":p.attr({"data-page-seq":s.seq,"data-text":"封面","data-width":s.width,"data-type":"front-cover"}),u.width(c.mmToPx(s.width)*(u.height()/c.mmToPx(s.height))),f=$(h),u.append(f),f.attr({"data-page-seq":s.seq,width:c.mmToPx(s.width)*u.height()/c.mmToPx(s.height),height:u.height()});break;case"back-cover":p.attr({"data-page-seq":s.seq,"data-text":"封底","data-width":s.width,"data-type":"back-cover"}),u.width(c.mmToPx(s.width)*(u.height()/c.mmToPx(s.height))),f=$(h),u.append(f),f.attr({"data-page-seq":s.seq,width:c.mmToPx(s.width)*u.height()/c.mmToPx(s.height),height:u.height()});break;case"copyright":p.attr({"data-page-seq":s.seq,"data-text":"版权页","data-width":s.width,"data-type":"copyright"}),u.width(c.mmToPx(s.width)*(u.height()/c.mmToPx(s.height))),f=$(h),u.append(f),f.attr({"data-page-seq":s.seq,width:c.mmToPx(s.width)*u.height()/c.mmToPx(s.height),height:u.height()});break;case"spine":p.attr({"data-page-seq":s.seq,"data-text":"书脊","data-width":s.width,"data-type":"spine"}),u.width(c.mmToPx(s.width)*(u.height()/c.mmToPx(s.height))),f=$(h),u.append(f),f.attr({"data-page-seq":s.seq,width:c.mmToPx(s.width)*u.height()/c.mmToPx(s.height),height:u.height()});break;case"flap":p.attr({"data-page-seq":s.seq,"data-text":"折页","data-type":"flap"}),u.width(c.mmToPx(s.width)*(u.height()/c.mmToPx(s.height))),f=$(h),u.append(f),f.attr({"data-page-num":"frontFlap",width:c.mmToPx(s.width)*u.height()/c.mmToPx(s.height),height:u.height()});break;case"flyleaf":p.attr({"data-page-seq":s.seq,"data-text":"1(扉页)","data-type":"flyleaf"}),u.width(c.mmToPx(s.width)*(u.height()/c.mmToPx(s.height))),f=$(h),u.append(f),f.attr({"data-page-seq":s.seq,width:c.mmToPx(s.width)*u.height()/c.mmToPx(s.height),height:u.height()});break;case"normal":if("single"==i){var v,b;b=parseFloat(s.seq)%2==1,parseFloat(s.seq)+(b?1:2),v=b?"left_page":"right_page",parseFloat(s.seq)+(b?0:1),p.attr({"data-page-seq":s.seq,"data-text":parseFloat(s.seq)+2,"data-width":s.width,"data-type":"normal"}).addClass("sortable"),u.width(c.mmToPx(s.width)*(u.height()/c.mmToPx(s.height))),f=$(h),u.append(f),f.addClass(v).attr({"data-page-seq":s.seq,width:c.mmToPx(s.width)*u.height()/c.mmToPx(s.height),height:u.height()})}else"1"!==s.seq&&s.seq--,p.attr({"data-page-seq":[parseFloat(s.seq)+1,parseFloat(s.seq)+2].join(),"data-text":[parseFloat(s.seq)+3,parseFloat(s.seq)+4].join(" - "),"data-type":"normal"}).addClass("sortable"),u.width(2*c.mmToPx(s.width)*(u.height()/c.mmToPx(s.height))),f=$(h),m=$(h),u.append(f).append(m),f.addClass("left_page").attr({"data-page-seq":parseFloat(s.seq)+1,width:c.mmToPx(s.width)*u.height()/c.mmToPx(s.height),height:u.height()}),m.addClass("right_page").attr({"data-page-seq":parseFloat(s.seq)+2,width:c.mmToPx(s.width)*u.height()/c.mmToPx(s.height),height:u.height()}),"1"!==s.seq&&s.seq++,l++;break;case"cross":p.attr({"data-page-seq":s.seq,"data-text":[parseFloat(s.seq)+2,parseFloat(s.seq)+3].join(" - "),"data-type":"cross"}).addClass("sortable"),u.width(c.mmToPx(s.width)*(u.height()/c.mmToPx(s.height))),f=$(h),m=$(h),u.append(f).append(m),f.attr({"data-page-num":s.seq,width:c.mmToPx(s.width)*u.height()/c.mmToPx(s.height),height:u.height()}),m.addClass("right_page").attr({"data-page-seq":parseFloat(s.seq)+1,width:0,height:u.height()}).css("display","none"),l++}}t.find("li").each(function(){var t=$(this).attr("data-page-seq");$(this).children(".page_num.right_page").remove(),"front-cover"==t?$(this).children(".page_num.left_page").text("封面"):"back-cover"==t?$(this).children(".page_num.left_page").text("封底"):(t=t.split(","),void 0!=t[1]?$(this).children(".page_num.left_page").text("P"+t[0]+"-"+t[1]):$(this).children(".page_num.left_page").text("P"+t[0]))});var x=0,S=function(e){++x===t.find(".page_thumbnail").length&&"function"==typeof r&&r.call(this)};setTimeout(function(){for(l=0;l<d.length;l++)s=d[l],n(t,s,a,S)},500)}function n(t,e,a,o){var i=$(t).find("canvas.page_thumbnail[data-page-seq="+e.seq+"]")[0],n=$(i).parent(),s=n.parent();if(i){var l=c.mmToPx(e.width)*n.height()/c.mmToPx(e.height);switch(Math.floor(i.width)!==Math.floor(l)&&$(i).attr({width:l}),e.type){case"normal":var g;e.seq%2==1?g=[parseFloat(e.seq)-1,e.seq]:(g=[e.num,parseFloat(e.seq)+1],"cross"===s.attr("data-type")&&($(i).addClass("left_page").siblings(".page_thumbnail").css("display","block"),s.attr({"data-page-nums":g.join(),"data-type":"normal"})));break;case"cross":"normal"===s.attr("data-type")&&(s.attr({"data-page-nums":e.num,"data-type":"cross"}),$(i).removeClass("left_page").siblings(".page_thumbnail").css("display","none"))}d.generatePreviewCanvas(e,a,function(t){var e=t.canvas,a=i.getContext("2d"),n=r(e,i.width,i.height);a.drawImage(n,0,0),"function"==typeof o&&o.call(this,t)},108)}}function r(t,e,a){var o=document.createElement("canvas");o.width=e,o.height=a;var i=o.getContext("2d"),n=document.createElement("canvas");t.width>=t.height?(n.width=3*o.width,n.width>2500&&(n.width=2500),n.height=n.width*t.height/t.width):(n.height=3*o.height,n.height>2500&&(n.height=2500),n.width=n.height*t.width/t.height);var r=n.getContext("2d");return r.fillStyle="white",r.fillRect(0,0,n.width,n.height),r.drawImage(t,0,0,n.width,n.height),r.drawImage(n,0,0,n.width,n.height,0,0,n.width/2,n.height/2),i.drawImage(n,0,0,n.width/2,n.height/2,0,0,o.width,o.height),o}function s(t,a,o,i){opEvent.eDrawPageThumbnail.trigger(e,{pageInfo:t,photos:a,reDrawCurrentPages:o,callback:i})}var l=t("size-converter"),d=t("canvas"),c=new l(108),g=$("#template-page-item").html(),h=$("#template-page-item-thumbnail").html();e.initPageList=i,e.drawPageThumbnail=n,e.scaleImage=r,e.triggerDrawPageThumbnail=s,e.getPageList=o}),define("size-converter",function(t,e,a){function o(t){if(!t)throw new Error("请给个dpi！");this.DPI=t}o.prototype.mmToPx=function(t){return t*this.DPI*(1/25.4)},o.prototype.pxToMm=function(t){return t/this.DPI/(1/25.4)},o.prototype.mmToPt=function(t){return t*(72/25.4)},o.prototype.ptToMm=function(t){return t*(25.4/72)},o.prototype.ptToPx=function(t){return t/72*this.DPI},o.prototype.pxToPt=function(t){return t/this.DPI*72},a.exports=o}),define("transform",function(t,e,a){function o(t,e){t=$(t);var a=l(t);d(t,{scale:e,rotation:a.rotation,translationX:a.translationX,translationY:a.translationY})}function i(t,e){t=$(t);var a=l(t);d(t,{scale:a.scale,rotation:e,translationX:a.translationX,translationY:a.translationY})}function n(t,e,a){t=$(t);var o=l(t);d(t,{scale:o.scale,rotation:o.rotation,translationX:e,translationY:a})}function r(t,e){t=$(t);var a=l(t);d(t,{scale:a.scale,rotation:a.rotation,translationX:e,translationY:a.translationY})}function s(t,e){t=$(t);var a=l(t);d(t,{scale:a.scale,rotation:a.rotation,translationX:a.translationX,translationY:e})}function l(t){return t=$(t),{scale:parseFloat(t.attr("data-scale"))||1,rotation:parseInt(t.attr("data-rotation"))||0,translationX:parseFloat(t.attr("data-translation-x"))||0,translationY:parseFloat(t.attr("data-translation-y"))||0}}function d(t,e){t=$(t);var a=parseFloat(e.scale).toFixed(6),o=parseFloat(e.rotation).toFixed(6),i=parseFloat(e.translationX).toFixed(6),n=parseFloat(e.translationY).toFixed(6);t.css({transform:"translate("+i+"px,"+n+"px) rotate("+o+"deg) scale("+a+")"}),t.attr({"data-scale":a,"data-rotation":o,"data-translation-x":i,"data-translation-y":n})}function c(t){t=$(t),t.css({transform:""}).removeAttr("data-scale,data-rotation,data-translation-x,data-translation-y")}function g(t){t=t;var e=t.css("transform"),a=e.match(/[0-9.]+?e-[0-9]+/);return a&&a.forEach(function(t){e=e.replace(new RegExp(t,"g"),parseFloat(t).toFixed(6))}),e}e.scale=o,e.rotate=i,e.translate=n,e.translateX=r,e.translateY=s,e.set=d,e.clear=c,e.getCurrent=l,e.getCurrentTransform=g}),define("slot",["imageSlot","textSlot","decorationSlot","shadingSlot","shapeSlot","defaultSlot"],function(t,e,a){function o(t){return"imageslot"===t||$(t).is("imageslot")||$(t).hasClass("imageslot")}function i(t){return"textslot"===t||$(t).is("textslot")||$(t).hasClass("textslot")}function n(t){return"decorationslot"===t||$(t).is("decorationslot")||$(t).hasClass("decorationslot")}function r(t){return"shadingslot"===t||$(t).is("shadingslot")||$(t).hasClass("shadingslot")}function s(t){return"shapeslot"===t||$(t).is("shapeslot")||$(t).hasClass("shapeslot")}function l(){return"imageslot"}function d(){return"textslot"}function c(){return"decorationslot"}function g(){return"shadingslot"}function h(){return"shapeslot"}function p(){return".textslot,.imageslot,.decorationslot,.shadingslot,.shapeslot"}function u(t){return o(t)?l():i(t)?d():n(t)?c():r(t)?g():s(t)?h():"default"}function f(t){var e=I[u(t)];if(null!=e)return e.template()}function m(t){var e=I[u(t)];if(null!=e)return e.getAttr(t)}function v(t,e){var a=I[u(t)];if(S(t))if(void 0!==e.locked){if(null!=a)return a.setAttr(t,e)}else SureMsg.error("请先解锁槽位!");else if(null!=a)return a.setAttr(t,e)}function b(t,e,a){var o=I[u(t)];if(null!=o)return o.create(e,a)}function x(t){var e=I[u(t)];if(null!=e)return e.isEmpty(t)}function S(t){var e=I[u(t)];if(null!=e)return e.isLocked(t)}var y=t("imageSlot"),w=t("textSlot"),k=t("decorationSlot"),T=t("shadingSlot"),P=t("shapeSlot"),C=t("defaultSlot"),I={imageslot:y,textslot:w,decorationslot:k,shadingslot:T,shapeslot:P,default:C};e.template=f,e.getAttr=m,e.setAttr=v,e.create=b,e.isEmpty=x,e.isLocked=S,e.slotType=u,e.isImageSlot=o,e.isTextSlot=i,e.isDecorationSlot=n,e.isShadingSlot=r,e.isShapeSlot=s,e.getImageSlotName=l,e.getTextSlotName=d,e.getDecorationSlotName=c,e.getShadingSlotName=g,e.getShapeSlotName=h,e.getAllSlotClass=p,e.image=y,e.text=w,e.decoration=k,e.shading=T,e.shape=P}),define("pool",["md5","material"],function(t,e,a){function o(t){this.user=[],this.admin=[],this.tags=[],this.datasByTag={},this.styles=[],this.datasByStyle={};var e=this;n.getByType(t,0,-1,function(t){e.user=t.data}),n.getAdminByType(t,0,-1,function(t){e.admin=t.data,e.analysis()})}var i=t("md5"),n=t("material");o.prototype.analysis=function(){var t=this.admin,e=this;$.each(t,function(t,a){var o=a.tag,i=a.style;o=null!=o?o.split(","):[],$.each(o,function(t,o){$.inArray(o,e.tags)<0&&e.tags.push(o),void 0==e.datasByTag[o]&&(e.datasByTag[o]=[]),e.datasByTag[o].push(a)}),i=null!=i?i.split(","):[],$.each(i,function(t,o){$.inArray(o,e.styles)<0&&e.styles.push(o),void 0==e.datasByStyle[o]&&(e.datasByStyle[o]=[]),e.datasByStyle[o].push(a)})})},o.prototype.getByTag=function(t){if("全部"==t||"all"==t)return this.admin;var e=this.datasByTag[t];return void 0!=e?e:[]},o.prototype.getByStyle=function(t){var e=this.datasByStyle[t];return void 0!=e?e:[]},o.prototype.getUser=function(){return this.user},o.prototype.getAdmin=function(){return this.admin},o.prototype.add=function(t){"U"==t.level?this.user.unshift(t):this.admin.unshift(t)},o.prototype.del=function(t){for(var e=0;e<this.user.length;e++){this.user[e].id==t&&this.user.splice(e,1)}},o.prototype.getById=function(t){var e=this.getUserById(t);return null==e&&(e=this.getAdminById(t)),e},o.prototype.getAdminById=function(t){for(var e=0;e<this.admin.length;e++){var a=this.admin[e];if(a.id==t)return a}return null},o.prototype.getUserById=function(t){for(var e=0;e<this.user.length;e++){var a=this.user[e];if(a.id==t)return a}return null},o.prototype.getUserByCode=function(t){for(var e=0;e<this.user.length;e++){var a=this.user[e];if(a.code==t)return a}return null},o.prototype.isExist=function(t,e,a,o){var n=this;i.calMd5(t,function(t){var e=n.getUserByCode(t);null!=e?"function"==typeof a&&a(e):"function"==typeof o&&o(t)})},a.exports=o}),define("md5",function(t,e,a){var o=function(t,e){try{var a,o=File.prototype.mozSlice||File.prototype.webkitSlice||File.prototype.slice;if(1048576<t.size){var i=o.call(t,0,50),n=o.call(t,t.size/2-50,t.size/2+50),r=o.call(t,t.size-50,t.size);a=new Blob([i,n,r])}else a=new Blob([o.call(t,0,t.size)]);var s=new FileReader,l=new SparkMD5;s.onload=function(t){l.appendBinary(t.target.result);var a=l.end();"function"==typeof e&&e(a)},s.readAsDataURL(a)}catch(a){console.log(a),this.calMd5_fullFile(t,e)}},i=function(t,e){function a(){var e=r*i,a=e+i>=t.size?t.size:e+i;"readAsBinaryString"in l?l.readAsBinaryString(o.call(t,e,a)):l.readAsText(o.call(t,e,a))}var o=File.prototype.mozSlice||File.prototype.webkitSlice||File.prototype.slice,i=2097152,n=Math.ceil(t.size/i),r=0,s=new SparkMD5,l=new FileReader;l.onload=function(t){if(s.appendBinary(t.target.result),++r<n)a();else{var o=s.end();"function"==typeof e&&e(o)}},a()};e.calMd5=o,e.calMd5FullFile=i}),define("index",["size-converter","book","photo"],function(t,e,a){var o=t("size-converter");return{book:t("book"),photo:t("photo"),definitionSizeConverter:new o(250)}}),define("opEvent",function(t,e,a){function o(t){$.extend(e,t),s=e}function i(t){var e=s[t];if(void 0!=e)return e;throw Error(t+" 不存在")}function n(t,a){i(t).trigger(e,a)}function r(t,e){i(t).register(e)}var s={};e.add=o,e.get=i,e.trigger=n,e.register=r}),define("view",["mainv","left","right","edit","pagelist","pagesort","toptool","upload","addPage","leftPhoto","leftPageList","leftDecoration","leftBackground","leftTemplate"],function(t,e,a){function o(t){b.each(function(e){e.init(t),"function"==typeof e.bind&&e.bind(),void 0!==e.events&&opEvent.add(e.events)}),b.each(function(t){"function"==typeof t.initEvent&&t.initEvent()})}var i=t("mainv"),n=t("left"),r=t("right"),s=t("edit"),l=t("pagelist"),d=t("pagesort"),c=t("toptool"),g=t("upload"),h=t("addPage"),p=t("leftPhoto"),u=t("leftPageList"),f=t("leftDecoration"),m=t("leftBackground"),v=t("leftTemplate"),b=[i,n,r,s,l,d,c,g,h,p,f,m,v];e.init=o,e.index=i,e.edit=s,e.left=n,e.leftPhoto=p,e.leftDecoration=f,e.leftPageList=u,e.leftDecoration=f,e.leftBackground=m,e.leftTemplate=v,e.right=r,e.toptool=c,e.pagelist=l,e.pagesort=d,e.upload=g}),define("presenter",["slot","transform","size-converter","pageUtil","canvas"],function(t,e,a){function o(){function t(t){var e=t.pageSeq,a=t.name,o=t.obj;if(void 0===e)throw new Error("pageSeq为undefined");if(void 0===a)throw new Error("imageSlotName为undefined");if(void 0===o)throw new Error("obj为undefined");model.book.updateImageSlot(e,a,!0,o);var i=model.book.getPageBySeq(e),n=model.photo.getPhotoInPage(i);g.triggerDrawPageThumbnail(i,n),view.edit.setPageActive(e),view.leftPhoto.initPhoto()}function a(t){var e=t.pageSeq,a=t.name,o=!1!==t.saveToHistory,i=t.obj;if(void 0===e)throw new Error("pageSeq为undefined");if(void 0===a)throw new Error("namee为undefined");if(void 0===i)throw new Error("obj为undefined");"front-cover"===e&&void 0!==i.content||"spine"===e&&"txt1"===a&&i.content,model.book.updateTextSlot(e,a,o,i);var n=model.book.getPageBySeq(e),r=model.photo.getPhotoInPage(n);g.triggerDrawPageThumbnail(n,r),view.edit.setPageActive(e)}function o(t){var e=t.pageSeq,a=t.name,o=!1!==t.saveToHistory,i=t.obj;if(void 0===e)throw new Error("pageSeq为undefined");if(void 0===a)throw new Error("name为undefined");if(void 0===i)throw new Error("obj为undefined");model.book.updateDecorationSlot(e,a,o,i);var n=model.book.getPageBySeq(e),r=model.photo.getPhotoInPage(n);g.triggerDrawPageThumbnail(n,r),view.edit.setPageActive(e)}function s(t){var e=t.pageSeq,a=t.name,o=!1!==t.saveToHistory,i=t.obj;if(void 0===e)throw new Error("pageSeq为undefined");if(void 0===a)throw new Error("name为undefined");if(void 0===i)throw new Error("obj为undefined");model.book.updateShapeSlot(e,a,o,i);var n=model.book.getPageBySeq(e),r=model.photo.getPhotoInPage(n);g.triggerDrawPageThumbnail(n,r),view.edit.setPageActive(e)}function c(t){var e=t.pageSeq,a=t.name,o=!1!==t.saveToHistory,i=t.obj;if(void 0===e)throw new Error("pageSeq为undefined");if(void 0===a)throw new Error("name为undefined");if(void 0===i)throw new Error("obj为undefined");model.book.updateShadingSlot(e,a,o,i);var n=model.book.getPageBySeq(e),r=model.photo.getPhotoInPage(n);g.triggerDrawPageThumbnail(n,r),view.edit.setPageActive(e)}function u(t){var a=$(t.el),o=t.type,i=a.parent().attr("data-seq"),n=a.attr("data-name");if(l.isImageSlot(a))l.image.zoomImgInSlot(a,o);else if(l.isShadingSlot(a)){var r,s=l.getAttr(a);switch(o){case"zoomin":r=s.imgWidth+s.imgWidth/100;break;case"zoomout":r=s.imgWidth-s.imgWidth/100;break;case"fill":var d=model.book.getPageBySeq(i),c=backgroundPool.getById(s.shadingId),g=parseFloat(c.width)/parseFloat(c.height);r=p.pxToMm(s.imgWidth),r>d.width&&(r=d.width);var h=r/g;h<d.height&&(r=d.height/c.height*c.width),r=p.mmToPx(r)}r<100&&(r=100);var u={imgWidth:r};l.setAttr(a,u),opEvent.eSlotChanged.trigger(e,{el:a,pageSeq:i,name:n,obj:{imgWidth:p.pxToMm(r)}})}}function f(t){var a=$(t.el),o=t.value,i=t.type,n=t.isMM,r={};r[i]=!n||"width"!=i&&"height"!=i&&"x"!=i&&"y"!=i?o:p.mmToPx(o),l.setAttr(a,r),r[i]=o,opEvent.eSlotChanged.trigger(e,{el:a,pageSeq:a.parent().attr("data-seq"),name:a.attr("data-name"),obj:r})}function m(t){var a=$(t.el),o=t.value,i=t.sender,n=l.getAttr(a),r=n.style===o?"normal":o;l.setAttr(a,{style:r}),opEvent.eTextSlotChanged.trigger(e,{pageSeq:a.parent().attr("data-seq"),name:a.attr("data-name"),obj:{style:r}}),void 0!=i&&("normal"==r?i.removeAttr("data-select"):i.attr("data-select",!0))}function v(t){var a=$(t.el),o=t.value,i=t.sender,n=l.getAttr(a),r=n.weight===o?"normal":o;l.setAttr(a,{weight:r}),opEvent.eTextSlotChanged.trigger(e,{pageSeq:a.parent().attr("data-seq"),name:a.attr("data-name"),obj:{weight:r}}),void 0!=i&&("normal"==r?i.removeAttr("data-select"):i.attr("data-select",!0))}function b(t){var a=$(t.el),o=t.value,i=t.sender,n=l.getAttr(a),r=n.decoration===o?"none":o;l.setAttr(a,{decoration:r}),opEvent.eTextSlotChanged.trigger(e,{pageSeq:a.parent().attr("data-seq"),name:a.attr("data-name"),obj:{decoration:r}}),void 0!=i&&("none"==r?i.removeAttr("data-select"):i.attr("data-select",!0))}function x(t){var a=$(t.el),o=t.value,i=t.sender,n=a.parent().attr("data-seq"),r=a.attr("data-name");"front-flap"==a.parent().attr("data-seq")?l.setAttr(a,{align:o,doNotAutoSetTextboxHeight:!0}):l.setAttr(a,{align:o}),opEvent.eTextSlotChanged.trigger(e,{pageSeq:n,name:r,obj:{align:o}}),void 0!=i&&i.attr("data-select",!0).siblings(".edit-text-align").removeAttr("data-select")}function S(t){var a=$(t.el),o=t.value,i=a.parent().attr("data-seq"),n=a.attr("data-name"),r=t.btnId;if(void 0!=r){var s=$("#"+r).data("sender");s.attr({"data-value":o});s.find("span").css({"font-family":"font"+o+",serif"}).text(fontPool.getFontName(o))}"front-flap"==a.parent().attr("data-seq")?l.setAttr(a,{fontId:o,doNotAutoSetTextboxHeight:!0}):l.setAttr(a,{fontId:o}),opEvent.eTextSlotChanged.trigger(e,{pageSeq:i,name:n,obj:{fontId:o}})}function y(t){var a=$(t.el),o=t.value,i=a.parent().attr("data-seq"),n=a.attr("data-name"),r=t.btnId;if(void 0!=r){$("#"+r).data("sender").attr({"data-value":o}).children("span").css({"background-color":o})}"front-flap"==a.parent().attr("data-seq")?l.setAttr(a,{color:o,doNotAutoSetTextboxHeight:!0}):l.setAttr(a,{color:o}),opEvent.eTextSlotChanged.trigger(e,{pageSeq:i,name:n,obj:{color:o}})}function w(t){var a=$(t.el),o=t.value,i=t.btnId;if(void 0!=i){$("#"+i).data("sender").attr({"data-value":o,"data-text":o+"点"}).children("span").text(o+"pt")}if("front-flap"==a.parent().attr("data-seq"))l.setAttr(a,{pt:o,doNotAutoSetTextboxHeight:!0}),opEvent.eTextSlotChanged.trigger(e,{pageSeq:a.parent().attr("data-seq"),name:a.attr("data-name"),obj:{pt:o}});else{l.setAttr(a,{pt:o});var n=p.pxToMm(l.text.getTextSlotTextHeight(a));opEvent.eTextSlotChanged.trigger(e,{pageSeq:a.parent().attr("data-seq"),name:a.attr("data-name"),obj:{pt:o,height:n}})}a.data("selectionHandles").resetPosition()}function k(t){var a=$(t.el),o=t.value,i=t.btnId;if(void 0!=i){$("#"+i).data("sender").attr({"data-value":o})}if("front-flap"==a.parent().attr("data-num"))l.setAttr(a,{space:o,doNotAutoSetTextboxHeight:!0}),opEvent.eTextSlotChanged.trigger(e,{pageSeq:a.parent().attr("data-seq"),name:a.attr("data-name"),obj:{space:o}});else{l.setAttr(a,{space:o});var n=p.pxToMm(l.text.getTextSlotTextHeight(a));opEvent.eTextSlotChanged.trigger(e,{pageSeq:a.parent().attr("data-seq"),name:a.attr("data-name"),obj:{space:o,height:n}})}a.data("selectionHandles").resetPosition()}function T(t){var a=$(t.el),o=t.value,i=t.btnId;if(void 0!=i){$("#"+i).data("sender").attr({"data-value":o})}if("front-flap"==a.parent().attr("data-num"))l.setAttr(a,{space:o,doNotAutoSetTextboxHeight:!0}),opEvent.eTextSlotChanged.trigger(e,{pageSeq:a.parent().attr("data-seq"),name:a.attr("data-name"),obj:{leading:o}});else{l.setAttr(a,{leading:o});var n=p.pxToMm(l.text.getTextSlotTextHeight(a));opEvent.eTextSlotChanged.trigger(e,{pageSeq:a.parent().attr("data-seq"),name:a.attr("data-name"),obj:{leading:o,height:n}})}a.data("selectionHandles").resetPosition()}function P(t){var a=$(t.el),o=a.attr("data-name"),i=a.parent().attr("data-seq");l.isLocked(a)?SureMsg.error("请先解锁槽位"):l.isImageSlot(a)?opEvent.eImageSlotDelete.trigger(e,{pageSeq:i,name:o}):l.isTextSlot(a)?opEvent.eTextSlotDelete.trigger(e,{pageSeq:i,name:o}):l.isDecorationSlot(a)?opEvent.eDecorationSlotDelete.trigger(e,{pageSeq:i,name:o}):l.isShapeSlot(a)?opEvent.eShapeSlotDelete.trigger(e,{pageSeq:i,name:o}):l.isShadingSlot(a)&&opEvent.eSlotsRemove.trigger(e,{slots:[{pageSeq:i,name:o,type:l.getShadingSlotName()}]})}function C(t){var a,o=$(t.el),i=t.value,n=o.children(".content").children(".img"),r=l.getAttr(o);switch(i){case"-90":a={image:{rotation:(r.image.rotation-90)%360}};break;case"90":a={image:{rotation:(r.image.rotation+90)%360}}}l.setAttr(o,a),l.image.preventImgOutSlot(o),o.data("backImgWrapper")&&o.data("backImgWrapper").css("transform",d.getCurrentTransform(n)),o.data("rotateChangeEventClockToken")&&(clearTimeout(o.data("rotateChangeEventClockToken")),o.removeData("rotateChangeEventClockToken")),o.data("rotateChangeEventClockToken",setTimeout(function(){opEvent.eImageSlotChanged.trigger(e,{pageSeq:o.parent().attr("data-seq"),name:o.attr("data-name"),obj:a})},400))}function I(t){var a=$(t.el),o=t.value,i=t.btnId;if(void 0!=i){$("#"+i).data("sender").attr({"data-value":o})}l.setAttr(a,{borderWidth:p.ptToPx(o)});var n=view.edit.computeSlotXY(a);l.setAttr(a,{x:n.x,y:n.y}),a.data("selectionHandles").resetPosition(),opEvent.eSlotChanged.trigger(e,{el:a,pageSeq:a.parent().attr("data-seq"),name:a.attr("data-name"),obj:{borderWidth:o,x:p.pxToMm(n.x),y:p.pxToMm(n.y)}}),$(document).triggerHandler("pointerdown.hideSubBtn#"+i)}function _(t){var a=$(t.el),o=t.value,i=t.btnId;if(void 0!=i){$("#"+i).data("sender").attr({"data-value":o}).find(".ybicon-border-color, .color").css({color:o,"background-color":o})}l.setAttr(a,{borderColor:o}),opEvent.eSlotChanged.trigger(e,{el:a,pageSeq:a.parent().attr("data-seq"),name:a.attr("data-name"),obj:{borderColor:o}})}function q(t){var a=$(t.el),o=t.value,i=t.btnId;if(void 0!=i){$("#"+i).data("sender").attr({"data-value":o}).children("span").css({"background-color":o})}l.setAttr(a,{color:o}),opEvent.eSlotChanged.trigger(e,{el:a,pageSeq:a.parent().attr("data-seq"),name:a.attr("data-name"),obj:{color:o}})}function E(t,a){var o=$(t.el),i=o.parent().attr("data-seq"),n=o.attr("data-name"),r=t.sender,s=t.value;void 0==a&&(a=s),l.setAttr(o,{locked:a}),view.edit.selectSlot(i,n),opEvent.eSlotChanged.trigger(e,{el:o,pageSeq:i,name:n,obj:{locked:a},saveToHistory:!1}),void 0!=r&&(r.attr("data-locked",a),"false"!=a?r.attr("data-value",!0):r.attr("data-value",!1))}function L(t){var e=$(t.el),a=t.value;view.edit.setSlotZIndex(e,a)}opEvent.eCopySlots.register(function(t){var e=t.slots;model.book.slotsClipboard=e.map(function(t){switch(t.type){case l.getImageSlotName():t.slot=model.book.getImageSlotByPageSeqAndName(t.pageSeq,t.name);break;case l.getDecorationSlotName():t.slot=model.book.getDecorationSlotByPageSeqAndName(t.pageSeq,t.name);break;case l.getShapeSlotName():t.slot=model.book.getShapeSlotByPageSeqAndName(t.pageSeq,t.name);break;case l.getTextSlotName():t.slot=model.book.getTextSlotByPageSeqAndName(t.pageSeq,t.name);break;case l.getShadingSlotName():t.slot=model.book.getShadingSlotByPageSeqAndName(t.pageSeq,t.name)}return t})}),opEvent.eCutSlots.register(function(t){var a=t.slots;opEvent.eCopySlots.trigger(e,{slots:a}),opEvent.eSlotsRemove.trigger(e,{slots:a})}),opEvent.ePasteSlots.register(function(t){var e=t.destPageSeq,a=t.x,o=t.y;if(model.book.pasteSlots(e,a,o)){var i=model.book.getPageBySeq(e),r=model.photo.getPhotoInPage(i);view.edit.initPageSlot(i,r),g.triggerDrawPageThumbnail(i),n(e)}}),opEvent.eAddPage.register(function(t){var a=t.addPageNum,o=t.addPostion,i=view.edit.getActivePageSeq();model.book.addPages(a,o,i),opEvent.eRefreshAll.trigger(e,{book:model.book.get(),photos:model.photo.getPhotos(),selectPageSeq:i})}),opEvent.eDeletePages.register(function(t){var a=t.pageSeqs,o=model.book.delPages(a);opEvent.eRefreshAll.trigger(e,{book:model.book.get(),photos:model.photo.getPhotos(),selectPageSeq:o})}),opEvent.eTemplateListItemSelected.register(function(t){var e=t.currentPageSeq,a=t.template;r({page:model.book.getPageBySeq(e),template:a})}),opEvent.eSaveAsTemplate.register(function(t){var e=t.pageSeq;model.book.saveMyTemplate(e,function(t){templatePool.add(t),view.leftTemplate.init(),SureMsg.success("模板保存成功")})}),opEvent.eSetPageActive.register(function(t){n(t.pageSeq)}),opEvent.eChangeBookInfo.register(function(t){model.book.update(t.book),t.refresh&&opEvent.eBookSaving.trigger(e,{refresh:t.refresh})}),opEvent.eChangePageInfo.register(function(t){var e=t.seq,a=t.type,o=t.value,i=t.btnId;if(void 0!=i){var n=$("#"+i).data("sender");"backgroundColor"==a&&n.attr({"data-value":o}).children("span").css({"background-color":o})}var r=model.book.getPageBySeq(e);r[a]=o;var s=model.photo.getPhotoInPage(r);view.edit.initPageSlot(r,s),g.triggerDrawPageThumbnail(r)}),opEvent.ePageUndo.register(function(t){var e=t.pageSeq,a=model.book.undo(e);if(a){var o;switch(a.type){case"normal":o=a.seq%2==1?[model.book.getPageBySeq(a.seq-1),a]:[a,model.book.getPageBySeq(parseInt(a.seq)+1)];break;case"back-flap":o=[a,model.book.getPageBySeq("back-flap")];break;case"front-flap":o=[model.book.getPageBySeq("front-flap"),a];break;default:o=[a]}var i=model.photo.getPhotoInPage(o);view.edit.render(o,i,!0),view.edit.setPageActive(a.seq),g.triggerDrawPageThumbnail(a,o),n(e)}}),opEvent.ePageRedo.register(function(t){var e=t.pageSeq,a=model.book.redo(e);if(a){var o;switch(a.type){case"normal":o=a.num%2==1?[model.book.getPageBySeq(a.seq-1),a]:[a,model.book.getPageBySeq(parseInt(a.seq)+1)];break;case"back-flap":o=[a,model.book.getPageBySeq("back-flap")];break;case"front-flap":o=[model.book.getPageBySeq("front-flap"),a];break;default:o=[a]}var i=model.photo.getPhotoInPage(o);view.edit.render(o,i,!0),view.edit.setPageActive(a.seq),g.triggerDrawPageThumbnail(a,i),n(e)}}),opEvent.ePagesSort.register(function(t){var e=t.sortData;model.book.sortPages(e)}),opEvent.eNewDecorationInsert.register(function(t){var e=t.pageSeq,a=t.decoration,o=t.x,n=t.y,r=document.createElement("img");r.src=a.value,r.onload=function(){var t,s=model.definitionSizeConverter.pxToMm(r.width),l=model.definitionSizeConverter.pxToMm(r.height);t=35*l/s
;var d=model.book.insertDecorationSlot(e,a,35,t,o,n),c=model.book.getPageBySeq(e),h=model.photo.getPhotoInPage(c);view.edit.initPageSlot(c,h),g.triggerDrawPageThumbnail(c),view.edit.selectSlot(e,d.name),i()}}),opEvent.eNewImageSlotInsert.register(function(t){var e=t.pageSeq||view.edit.getActivePage().attr("data-seq"),a=t.obj,o=model.book.insertImageSlot(e,a),i=model.book.getPageBySeq(e),n=model.photo.getPhotoInPage(i);view.edit.initPageSlot(i,n),g.triggerDrawPageThumbnail(i),view.edit.selectSlot(e,o.name)}),opEvent.eMewTextSlotInsert.register(function(t){var e=t.pageSeq||view.edit.getActivePage().attr("data-seq"),a=t.obj,o=model.book.insertTextSlot(e,a),n=model.book.getPageBySeq(e),r=model.photo.getPhotoInPage(n);view.edit.initPageSlot(n,r),g.triggerDrawPageThumbnail(n,r),view.edit.selectSlot(e,o.name),i()}),opEvent.eNewShapeSlotInsert.register(function(t){var e=t.pageSeq||view.edit.getActivePage().attr("data-seq"),a=(t.obj,model.book.insertShapeSlot(e,{borderColor:"",borderWidth:0,color:"#2db572",opacity:1,w:25,h:25})),o=model.book.getPageBySeq(e),n=model.photo.getPhotoInPage(o);view.edit.initPageSlot(o,n),g.triggerDrawPageThumbnail(o,n),view.edit.selectSlot(e,a.name),i()}),opEvent.eBookAutoComplete.register(function(t){SureMsg.success("自动排版")}),opEvent.eBookCheck.register(function(t){SureMsg.success("检查书册")}),opEvent.eBookSaving.register(function(t){var e=view.edit.getActivePageSeq();if(model.book.saveChanges(function(){SureMsg.success("保存书册"),n(e),void 0!=t.refresh&&t.refresh&&SureUtil.refresh()},function(){SureMsg.error("更新失败")}),void 0==t.updateThumbnail||t.updateThumbnail){var a=model.book.getPageBySeq(e),o=model.photo.getPhotoInPage(a);h.generateThumbnail(a,o,function(t){var a=t.ir;model.book.updateThumbnail(e,a.src),model.book.saveChanges()},108)}}),opEvent.eBookPublish.register(function(t){var e=t.isCreateThumb,a=t.onSuccess;model.book.publish(e,function(){SureMsg.success("发布书册成功"),"function"==typeof a&&a()},function(){SureMsg.error("更新失败")})}),opEvent.ePageListItemSelected.register(function(t){var e=t.currentPageSeqs,a=t.pageSeqs,o=t.selectedPageSeq,i=t.force;if(void 0===a)throw new Error("pageSeqs为undefined");void 0===o&&(o=a[0]);for(var n=[],r=0;r<a.length;r++){var s=model.book.getPageBySeq(a[r]);n.push(s)}var l=model.photo.getPhotoInPage(n);"force"==i&&view.edit.render(n,l,!1,o),e&&e.join()===a.join()?o&&view.edit.setPageActive(o):view.edit.render(n,l,!1,o)}),opEvent.eSlotChanged.register(function(e){var i=$(e.el);switch(l.slotType(i)){case"imageslot":t(e);break;case"textslot":a(e);break;case"decorationslot":o(e);break;case"shapeslot":s(e);break;case"shadingslot":c(e)}var r=i.data("selectionHandles");null!=r&&r.isOn&&r.resetPosition(),n()}),opEvent.eImageSlotChanged.register(function(e){t(e)}),opEvent.eTextSlotChanged.register(function(t){a(t)}),opEvent.eDecorationSlotChanged.register(function(t){o(t)}),opEvent.eShapeSlotChanged.register(function(t){s(t)}),opEvent.eImageSlotRendered.register(function(t){var e=t.pageSeq,a=t.name,o=model.book.getImageSlotByPageSeqAndName(e,a),i={width:model.definitionSizeConverter.mmToPx(o.width),height:model.definitionSizeConverter.mmToPx(o.height)};view.edit.setImgSlotRequireSize(e,a,i)}),opEvent.eImageSlotResize.register(function(t){var e=t.pageSeq,a=t.name,o=t.widthMM,i=t.heightMM,n={width:model.definitionSizeConverter.mmToPx(o),height:model.definitionSizeConverter.mmToPx(i)};view.edit.setImgSlotRequireSize(e,a,n)}),opEvent.eInsertNewPhotoToSlot.register(function(t){var e=t.il,a=t.pageSeq,o=t.name,i=t.isNet;if(void 0===a)throw new Error("pageSeq为undefined");if(void 0===o)throw new Error("imageSlotName为undefined");var n={id:e.ir.checksum,name:e.name,src:e.ir.src,width:e.ir.width,height:e.ir.height};view.edit.insertPhotoIntoImgSlot(n,a,o,!0,i,function(){}),view.edit.selectSlot(a,o)}),opEvent.eImageSlotDelete.register(function(t){var e=t.pageSeq,a=t.name;if(!["back-flap"].contains(e)){model.book.deleteImageSlot(e,a);var o=model.book.getPageBySeq(e),n=model.photo.getPhotoInPage(o);view.edit.initPageSlot(o,n),g.triggerDrawPageThumbnail(o,n),i()}}),opEvent.eTextSlotDelete.register(function(t){var e=t.pageSeq,a=t.name;if(!["back-flap"].contains(e)){model.book.deleteTextSlot(e,a);var o=model.book.getPageBySeq(e),n=model.photo.getPhotoInPage(o);view.edit.initPageSlot(o,n),g.triggerDrawPageThumbnail(o,n),i()}}),opEvent.eDecorationSlotDelete.register(function(t){var e=t.pageSeq,a=t.name;if(!["back-flap"].contains(e)){model.book.deleteDecorationSlot(e,a);var o=model.book.getPageBySeq(e),n=model.photo.getPhotoInPage(o);view.edit.initPageSlot(o,n),g.triggerDrawPageThumbnail(o,n),i()}}),opEvent.eNewShadingInsert.register(function(t){var a=t.pageSeq,o=t.shadingId,i=t.shadingThumb,n=t.shadingEdit,r=t.imgWidth,s=t.bg,l=parseFloat(s.width)/parseFloat(s.height),d=model.book.getPageBySeq(a);r>d.width&&(r=d.width),r/l<d.height&&(r=d.height/s.height*s.width),model.book.addShadingSlot(a,o,i,n,r),opEvent.eRefreshPage.trigger(e,{seq:a})}),opEvent.eRefreshPage.register(function(t){var e=t.seq,a=model.book.getPageBySeq(e),o=model.photo.getPhotoInPage(a);view.edit.initPageSlot(a,o),g.triggerDrawPageThumbnail(a,o),n()}),opEvent.eShapeSlotDelete.register(function(t){var e=t.pageSeq,a=t.name;if(!["back-flap"].contains(e)){model.book.deleteShapeSlot(e,a);var o=model.book.getPageBySeq(e),n=model.photo.getPhotoInPage(o);view.edit.initPageSlot(o,n),g.triggerDrawPageThumbnail(o,n),i()}}),opEvent.eSlotBtnOpEvent.register(function(t){var e=t.el;switch(t.type){case"zoomin":case"zoomout":case"adjust":case"fill":u(t);break;case"rotate":C(t);break;case"magic":break;case"borderwidth":I(t);break;case"bordercolor":_(t);break;case"color":q(t);break;case"lock":E(t,!0);break;case"unlock":E(t,!1);break;case"locked":E(t);break;case"z_index":L(t);break;case"copy":break;case"delete-slot":P(t);break;case"delete-img":view.edit.removeImgSlotImg(e);break;case"style":m(t);break;case"weight":v(t);break;case"decoration":b(t);break;case"align":x(t);break;case"font-family":S(t);break;case"font-color":y(t);break;case"font-size":w(t);break;case"letter-space":k(t);break;case"line-height":T(t);break;default:f(t)}}),opEvent.eSlotDelete.register(function(t){P(t)}),opEvent.eSlotsRemove.register(function(t){var e=t.slots,a=[];e.forEach(function(t){var e=t.pageSeq,o=t.name;if("imageslot"===t.type){var i=model.book.getImageSlotByPageSeqAndName(e,o);i.image&&i.image.id&&model.photo.getById(i.image.id)}a.some(function(t){return t===e})||a.push(e)}),model.book.removeSlots(e),a.forEach(function(t){var e=model.book.getPageBySeq(t),a=model.photo.getPhotos(e);view.edit.initPageSlot(e,a),g.triggerDrawPageThumbnail(e,a)})})}function i(){view.toptool.enable("btn-undo"),view.toptool.disable("btn-redo")}function n(t){model.book.getUndoHistoryLength(t)>0?view.toptool.enable("btn-redo"):view.toptool.disable("btn-redo"),model.book.getHistoryLength(t)>0?view.toptool.enable("btn-undo"):view.toptool.disable("btn-undo")}function r(t){var e,a=t.page,o=t.template,i=model.book.generateNewPage(a.seq,"change",a.type,o,!0);for(e=0;e<a.imageSlotList.length;e++){var n,r=a.imageSlotList[e];if(r.image&&!r.themeImage&&(n=model.photo.getById(r.image.id))){for(var l=0,d=null,c=0;c<i.imageSlotList.length;c++){var h=i.imageSlotList[c];if(!h.image){var p;p=n.ir.width/n.ir.height>=h.width/h.height?s(n.ir.width,h.width):s(n.ir.width,h.height*n.ir.width/n.ir.height),p>l&&(l=p,d=h)}}if(d){var u,f,m=model.photo.getById(r.image.id);m.ir.width/m.ir.height>=d.width/d.height?(u=d.height*m.ir.width/m.ir.height,f=d.height):(u=d.width,f=d.width*m.ir.height/m.ir.width);var v=(d.width-u)/2,b=(d.height-f)/2;d.image={x:v,y:b,id:r.image.id,width:u,rotation:0,fileName:m.fileName}}}}for(e=0;e<i.textSlotList.length;e++){var x=a.textSlotList[e],S=i.textSlotList[e];x?(S.content=x.content,S.fontId=x.fontId):S.content=""}if(void 0!==a.decorationSlotList&&null!==a.decorationSlotList){void 0!=i.decorationSlotList&&null!=i.decorationSlotList||(i.decorationSlotList=[]);for(var y=0;y<a.decorationSlotList.length;y++)i.decorationSlotList[y]=a.decorationSlotList[y]}if(void 0!==a.shapeSlotList&&null!==a.shapeSlotList){void 0!=i.shapeSlotList&&null!=i.shapeSlotList||(i.shapeSlotList=[]);for(var w=0;w<a.shapeSlotList.length;w++)i.shapeSlotList[w]=a.shapeSlotList[w]}if(!0!==model.book.replacePage(i))throw new Error("更换模板失败");var k=[];switch(i.type){case"normal":k=i.seq%2!=0?[model.book.getPageBySeq(i.seq-1),i]:[i,model.book.getPageBySeq(parseFloat(i.seq)+1)];break;default:k=[i]}var T=model.photo.getPhotoInPage(k);view.edit.render(k,T,!1,i.seq),g.triggerDrawPageThumbnail(i,T)}function s(t,e){return model.definitionSizeConverter.pxToMm(t)/e}var l=t("slot"),d=t("transform"),c=t("size-converter"),g=t("pageUtil"),h=t("canvas"),p=new c(108);e.init=o}),define("fontPool",["pool"],function(t,e,a){function o(){l=new d(c)}function i(t){for(var e=l.getAdmin(),a=0;a<e.length;a++){var o=e[a];if(o.value==t)return o}return null}function n(t){for(var e=l.getAdmin(),a=0;a<e.length;a++){var o=e[a];if(o.name==t)return o}return null}function r(t){var e=i(t);if(null!=e)return e.name}function s(){return l.getAdmin()}var l,d=t("pool"),c="font";e.init=o,e.getFontById=i,e.getFontByName=n,e.getFontName=r,e.getFonts=s}),define("templatePool",function(t,e,a){function o(t){Api.template.getAllPageTemplate(t.width,t.height,function(t){l=t.data})}function i(t,e){var a=[];if(void 0==t||"all"==t?a=l:"n"==t?$.each(l,function(t,e){e.resource.imageSlotList.length>4&&a.push(e)}):(t=parseInt(t),$.each(l,function(e,o){o.resource.imageSlotList.length==t&&a.push(o)})),void 0==e)return a;var o=[];return $.each(a,function(t,a){a.type==e&&o.push(a)}),o}function n(t){l.unshift(t)}function r(t){for(var e=0;e<l.length;e++){var a=l[e];if(a.id==t)return a}}function s(t){for(var e=0;e<l.length;e++){l[e].id==t&&l.splice(e,1)}}var l=[];e.init=o,e.getAll=i,e.add=n,e.del=s,e.get=r}),define("backgroundPool",["pool"],function(t,e,a){function o(){u=new f(m)}function i(){return u.getUser()}function n(){return u.getAdmin()}function r(t){u.add(t)}function s(t){u.del(t)}function l(t){return u.getById(t)}function d(t){return u.getUserById(t)}function c(t){return u.getByStyle(t)}function g(t){return u.getByTag(t)}function h(t){return u.getUserByCode(t)}function p(t,e,a,o){u.isExist(t,e,a,o)}var u,f=t("pool"),m="background";e.init=o,e.getUser=i,e.getAdmin=n,e.addOne=r,e.deleteOne=s,e.getById=l,e.getUserById=d,e.getByStyle=c,e.getByTag=g,e.getUserByCode=h,e.isExist=p}),define("decorationPool",["pool"],function(t,e,a){function o(){u=new f(m)}function i(){return u.getUser()}function n(){return u.getAdmin()}function r(t){u.add(t)}function s(t){u.del(t)}function l(t){return u.getById(t)}function d(t){return u.getUserById(t)}function c(t){return u.getByStyle(t)}function g(t){return u.getByTag(t)}function h(t){return u.getUserByCode(t)}function p(t,e,a,o){u.isExist(t,e,a,o)}var u,f=t("pool"),m="decoration";e.init=o,e.getUser=i,e.getAdmin=n,e.addOne=r,e.deleteOne=s,e.getById=l,e.getUserById=d,e.getByStyle=c,e.getByTag=g,e.getUserByCode=h,e.isExist=p}),define("ImageRes",["md5"],function(t,e,a){var o="/api/imageRes/",i=t("md5"),n={addIR:function(t,e){SureAjax.ajax({url:o,type:"POST",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",data:JSON.stringify(t),success:e})},getIRByChecksum:function(t,e,a){var i="function"==typeof e;return SureAjax.ajax({async:i,parseError:!1,url:o+"checksum/"+t,type:"GET",headers:{Accept:"application/json"},success:function(t){"function"==typeof e&&e(t)},error:function(t){"function"==typeof a&&a()}}),null},getImageExif:function(t,e){return SureAjax.ajax({url:o+t+"/exif",type:"GET",headers:{Accept:"application/json"},success:function(t){"function"==typeof e&&e(t)},error:function(t){"function"==typeof notFound&&notFound()}}),null},toDate:function(t){var e=t.replace(":","/").replace(":","/");return new Date(e)},createIRFromQiniu:function(t,e,a,o){var i={};o=o||{};var n=t.getOption("domain");Qiniu.domain=n;var r=Qiniu.imageInfo(a.key);"/"==n.charAt(n.length-1)&&(n=n.substring(0,n.length-1));var s=n+"/"+encodeURI(a.key);i.name=e.name,i.src=s,i.uploadTime=new Date,i.checksum=e.md5;var l=o.DateTime||o.DateTimeOriginal;return i.photoTime=l?i.toDate(l):null,i.format=r.format,i.width=r.width,i.height=r.height,i.colorModel=r.colorModel,i.linkNum=0,o.Model?i.model=o.Model:o.Software&&(i.model=o.Software),i.exif={checksum:i.checksum,jsonExif:JSON.stringify(o)},i},isIRExist:function(t,e,a){i.calMd5(t,function(t){n.getIRByChecksum(t,function(t){t&&"function"==typeof e&&e(t)},function(){"function"==typeof a&&a(t)})})}};return n}),define("template",function(t,e,a){function o(t,e){t.createUserId=SureUtil.getLoginId(),t.createUserName=SureUtil.getLoginUserName(),SureAjax.ajax({url:"/api/pt/",type:"POST",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",data:JSON.stringify(t),success:e})}function i(t,e){SureAjax.ajax({url:"/api/pt/"+t,type:"GET",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",success:e})}function n(t,e,a){SureAjax.ajax({url:"/api/pt/"+t,type:"PUT",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",data:JSON.stringify(e),success:a})}function r(t,e){SureAjax.ajax({url:"/api/pt/"+t,type:"DELETE",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",success:e})}function s(t,e,a){SureAjax.ajax({url:"/api/pt/?width="+t+"&height="+e,type:"GET",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",success:a})}function l(t,e,a){SureAjax.ajax({url:"/api/pt/"+t+"/resource",type:"POST",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",data:JSON.stringify(e),success:a})}function d(t,e){SureAjax.ajax({url:"/api/pt/"+t+"/resource",type:"GET",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",success:e})}function c(t,e,a){void 0!=a?SureAjax.ajax({url:"/api/bt/?copy="+a,type:"POST",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",data:JSON.stringify(t),success:e}):SureAjax.ajax({url:"/api/bt/",type:"POST",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",data:JSON.stringify(t),success:e})}function g(t){SureAjax.ajax({url:"/api/bt/",type:"GET",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",success:t})}function h(t,e){SureAjax.ajax({url:"/api/bt/"+t,type:"DELETE",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",success:e})}function p(t,e,a){SureAjax.ajax({url:"/api/bt/"+t,type:"PUT",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",data:JSON.stringify(e),success:a})}function u(t,e){SureAjax.ajax({url:"/api/bt/"+t,type:"GET",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",success:e})}function f(t,e,a){SureAjax.ajax({url:"/api/bt/"+t+"/resource",type:"POST",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",data:JSON.stringify(e),success:a})}function m(t,e){SureAjax.ajax({url:"/api/bt/"+t+"/resource",type:"GET",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",success:e})}function v(t){var e=SureUtil.getLoginId();SureAjax.ajax({url:"/api/user/"+e+"/bt/",type:"GET",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",success:t})}e.addPageTemplate=o,e.updatePageTemplate=n,e.getPageTemplate=i,e.getAllPageTemplate=s,e.delPageTemplate=r,e.savePtr=l,e.getPtr=d,e.addBookTemplate=c,e.getBookTemplate=u,e.updateBookTemplate=p,e.delBookTemplate=h,e.getAllBookTemplate=g,e.getUserBookTemplate=v,e.saveBtr=f,e.getBtr=m}),define("material",function(t,e,a){function o(t,e){SureAjax.ajax({url:"/api/material/",type:"POST",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",data:JSON.stringify(t),success:e})}function i(t,e){t.level=p.user,t.createUserId=SureUtil.getLoginId(),t.createUserName=SureUtil.getLoginUserName(),SureAjax.ajax({url:"/api/material/",type:"POST",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",data:JSON.stringify(t),success:e})}function n(t,e){t.level=p.admin,t.createUserId=SureUtil.getLoginId(),t.createUserName=SureUtil.getLoginUserName(),SureAjax.ajax({url:"/api/material/",type:"POST",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",data:JSON.stringify(t),success:e})}function r(t,e,a){SureAjax.ajax({url:"/api/material/"+t,type:"PUT",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",data:JSON.stringify(e),success:a})}function s(t,e){SureAjax.ajax({url:"/api/material/"+t,type:"DELETE",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",data:{},success:e})}function l(t,e){SureAjax.ajax({url:"/api/material/"+t,type:"GET",headers:{Accept:"application/json"},dataType:"json",success:e})}function d(t,e,a,o){var i=SureUtil.getLoginId();SureAjax.ajax({url:"/api/user/"+i+"/material",type:"GET",async:!1,headers:{Accept:"application/json"},dataType:"json",data:{t:t,start:e,limit:a},success:o})}function c(t,e,a,o){SureAjax.ajax({url:"/api/admin/material",type:"GET",headers:{Accept:"application/json"},async:!1,dataType:"json",data:{t:t,start:e,limit:a},success:o})}function g(t){var e={};return e.value=t.src,e.type="decoration",e.code=t.checksum,e.name=t.name,e.width=t.width,e.height=t.height,e.url=t.url,e}function h(t){var e={};return e.value=t.src,e.type="background",e.code=t.checksum,e.name=t.name,e.width=t.width,e.height=t.height,e.url=t.src,e}var p={user:"U",admin:"A"};e.add=o,e.addUser=i,e.addAdmin=n,e.update=r,e.del=s,e.get=l,e.getByType=d,e.getAdminByType=c,e.createDecoration=g,e.createBackground=h}),define("app",["material","template","ImageRes","decorationPool","backgroundPool","templatePool","fontPool","presenter","view","opEvent","index"],function(t,e,a){var o={getBookInfo:function(t,e){var a="/api/book/info/"+t+"?type=tpl";isTpl||(a="/api/book/info/"+t+"?type=book"),SureAjax.ajax({url:a,type:"GET",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",success:function(t){e(t)}})},updateBook:function(t){SureAjax.ajax({url:"/api/book/info/",type:"POST",headers:{Accept:"application/json"},contentType:"application/json",dataType:"json",data:JSON.stringify(model.book.getBookInfo()),success:function(){"function"==typeof t&&t()}})},material:t("material"),template:t("template"),imageRes:t("ImageRes")},i={data:{},init:function(){var t=i.getParameterByName("bid");if("undefined"!=typeof curBookId&&(t=curBookId),!_.isNumber(parseInt(t)))return void SureMsg.alert("参数不正确");i.data.bookId=t,o.getBookInfo(t,function(t){i.data.book=t,i.initView()})},initView:function(){i.setGlobalVariable(),r.init()},getParameterByName:function(t){var e=RegExp("[?&]"+t+"=([^&]*)").exec(window.location.search);return e&&decodeURIComponent(e[1].replace(/\+/g," "))},getParameter:function(t){var e=window.location.href;return e=e.split("?")[0].split("#")[0],e.split("/")[e.split("/").length-t].toLowerCase()},setGlobalVariable:function(){}},n={init:function(e){var a=t("decorationPool"),o=t("backgroundPool"),i=t("templatePool"),n=t("fontPool");a.init(e),o.init(e),i.init(e),n.init(e),window.decorationPool=a,window.backgroundPool=o,window.templatePool=i,window.fontPool=n,window.Pool={decoration:a,background:o,template:i,font:n}}},r={init:function(){var e=t("presenter"),a=t("view"),r=t("opEvent"),s=t("index");window.view=a,window.opEvent=r,window.presenter=e,window.model=s,window.Api=o,window.App=i,n.init(i.data.book),s.book.init(i.data.book),s.photo.getBookPhoto(i.data.book.id),a.init(i.data.book),e.init(i.data.book)}};i.init()}),seajs.use("app");